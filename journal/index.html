<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TimZ - Vibe Coding Journal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <!-- GB Theme CSS -->
  <link rel="stylesheet" href="../assets/gb-theme.css">

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (‰ΩøÁî®ÂÖ±Áî®Ë®≠ÂÆö) -->
  <script type="module">
    import { 
      db, auth, googleProvider,
      collection, doc, addDoc, getDocs, updateDoc, deleteDoc, orderBy, query, onSnapshot, serverTimestamp,
      signInWithPopup, signOut, onAuthStateChanged
    } from "../js/firebase-config.js";

    // Expose Firestore to global for React components
    window.firebaseDb = db;
    window.firebaseCollection = collection;
    window.firebaseAddDoc = addDoc;
    window.firebaseGetDocs = getDocs;
    window.firebaseUpdateDoc = updateDoc;
    window.firebaseDeleteDoc = deleteDoc;
    window.firebaseDoc = doc;
    window.firebaseOrderBy = orderBy;
    window.firebaseQuery = query;
    window.firebaseOnSnapshot = onSnapshot;
    window.firebaseServerTimestamp = serverTimestamp;

    // Expose Auth to global for React components
    window.firebaseAuth = auth;
    window.firebaseGoogleProvider = googleProvider;
    window.firebaseSignInWithPopup = signInWithPopup;
    window.firebaseSignOut = signOut;
    window.firebaseOnAuthStateChanged = onAuthStateChanged;

    // Signal that Firebase is ready
    window.dispatchEvent(new Event('firebase-ready'));
  </script>

  <!-- GameBoy Shell Component -->
  <script type="text/babel" src="../js/gb-shell.js"></script>

  <style>
    /* Journal specific styles */
    .journal-card {
      background: rgba(155, 188, 15, 0.3);
      border: 2px solid #0f380f;
      padding: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .journal-card:hover {
      background: rgba(155, 188, 15, 0.6);
      transform: translateX(4px);
    }
    .mood-btn {
      padding: 4px 8px;
      border: 2px solid #0f380f;
      background: rgba(155, 188, 15, 0.3);
      cursor: pointer;
      transition: all 0.2s;
    }
    .mood-btn:hover, .mood-btn.active {
      background: #0f380f;
      color: #9bbc0f;
    }
    .tag {
      display: inline-block;
      background: #0f380f;
      color: #9bbc0f;
      padding: 2px 6px;
      font-size: 10px;
      margin-right: 4px;
      margin-top: 4px;
    }
    .journal-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .journal-modal-content {
      background: #9bbc0f;
      border: 4px solid #0f380f;
      padding: 16px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      width: 400px;
    }
    .journal-input {
      width: 100%;
      padding: 8px;
      border: 2px solid #0f380f;
      background: rgba(255,255,255,0.8);
      font-family: 'DotGothic16', monospace;
      margin-bottom: 8px;
    }
    .journal-textarea {
      width: 100%;
      min-height: 120px;
      padding: 8px;
      border: 2px solid #0f380f;
      background: rgba(255,255,255,0.8);
      font-family: 'DotGothic16', monospace;
      resize: vertical;
      margin-bottom: 8px;
    }
    .login-btn {
      background: #0f380f;
      color: #9bbc0f;
      padding: 4px 8px;
      font-size: 10px;
      border: 2px solid #9bbc0f;
      cursor: pointer;
      transition: all 0.2s;
    }
    .login-btn:hover {
      background: #9bbc0f;
      color: #0f380f;
    }
    .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #0f380f;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { GameBoyShell } = window;

    const MOODS = ['ü§Ø', 'üí°', 'üî•', 'üòÖ', 'ü§î', '‚ú®', 'üéâ', 'üò§'];

    // Journal Entry Card
    const JournalCard = ({ entry, onClick, onDelete, canEdit }) => {
      const date = entry.createdAt?.toDate?.() || new Date();
      const dateStr = date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
      
      return (
        <div className="journal-card" onClick={() => canEdit && onClick(entry)}>
          <div className="flex justify-between items-start">
            <div className="flex-1">
              <div className="flex items-center gap-2">
                <span className="text-lg">{entry.mood || 'üìù'}</span>
                <span className="font-bold text-sm truncate">{entry.title || 'ÁÑ°Ê®ôÈ°å'}</span>
              </div>
              <div className="text-xs opacity-70 mt-1">{dateStr}</div>
            </div>
            {canEdit && (
              <button 
                className="text-xs opacity-50 hover:opacity-100 px-2"
                onClick={(e) => { e.stopPropagation(); onDelete(entry.id); }}
              >‚úï</button>
            )}
          </div>
          {entry.tags?.length > 0 && (
            <div className="mt-1">
              {entry.tags.slice(0, 3).map((tag, i) => (
                <span key={i} className="tag">{tag}</span>
              ))}
            </div>
          )}
        </div>
      );
    };

    // Edit/Create Modal
    const JournalModal = ({ entry, onSave, onClose }) => {
      const [title, setTitle] = useState(entry?.title || '');
      const [content, setContent] = useState(entry?.content || '');
      const [mood, setMood] = useState(entry?.mood || 'üí°');
      const [tags, setTags] = useState(entry?.tags?.join(', ') || '');
      const [codeSnippet, setCodeSnippet] = useState(entry?.codeSnippet || '');

      const handleSave = () => {
        onSave({
          id: entry?.id,
          title: title || 'ÁÑ°Ê®ôÈ°å',
          content,
          mood,
          tags: tags.split(',').map(t => t.trim()).filter(Boolean),
          codeSnippet
        });
      };

      return (
        <div className="journal-modal" onClick={onClose}>
          <div className="journal-modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="font-bold text-lg mb-4 border-b-2 border-[#0f380f] pb-2">
              {entry?.id ? 'Á∑®ËºØÊó•Ë®ò' : 'Êñ∞Â¢ûÊó•Ë®ò'}
            </h3>
            
            <input
              className="journal-input"
              placeholder="Ê®ôÈ°å..."
              value={title}
              onChange={e => setTitle(e.target.value)}
            />

            <div className="mb-2">
              <label className="text-xs font-bold">ÂøÉÊÉÖÔºö</label>
              <div className="flex flex-wrap gap-1 mt-1">
                {MOODS.map(m => (
                  <button
                    key={m}
                    className={`mood-btn ${mood === m ? 'active' : ''}`}
                    onClick={() => setMood(m)}
                  >{m}</button>
                ))}
              </div>
            </div>

            <textarea
              className="journal-textarea"
              placeholder="‰ªäÂ§©Â≠∏Âà∞‰∫Ü‰ªÄÈ∫ºÔºüÊúâ‰ªÄÈ∫ºÊÉ≥Ê≥ïÔºü"
              value={content}
              onChange={e => setContent(e.target.value)}
            />

            <input
              className="journal-input"
              placeholder="Ê®ôÁ±§ (ÈÄóËôüÂàÜÈöîÔºåÂ¶Ç: React, AI, ÈáçÊßã)"
              value={tags}
              onChange={e => setTags(e.target.value)}
            />

            <textarea
              className="journal-textarea"
              style={{ minHeight: '60px', fontFamily: 'monospace', fontSize: '12px' }}
              placeholder="Áõ∏ÈóúÁ®ãÂºèÁ¢º (ÈÅ∏Â°´)"
              value={codeSnippet}
              onChange={e => setCodeSnippet(e.target.value)}
            />

            <div className="flex gap-2 mt-4">
              <button
                className="gb-btn flex-1 text-center"
                onClick={handleSave}
              >üíæ ÂÑ≤Â≠ò</button>
              <button
                className="gb-btn flex-1 text-center opacity-70"
                onClick={onClose}
              >ÂèñÊ∂à</button>
            </div>
          </div>
        </div>
      );
    };

    // Main Journal Page
    const JournalPage = () => {
      const [entries, setEntries] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingEntry, setEditingEntry] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [firebaseReady, setFirebaseReady] = useState(false);
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);

      // Listen to auth state
      useEffect(() => {
        if (!firebaseReady) return;
        
        const unsubscribe = window.firebaseOnAuthStateChanged(window.firebaseAuth, (currentUser) => {
          setUser(currentUser);
          setAuthLoading(false);
        });
        
        return () => unsubscribe();
      }, [firebaseReady]);

      const handleLogin = async () => {
        try {
          await window.firebaseSignInWithPopup(window.firebaseAuth, window.firebaseGoogleProvider);
        } catch (error) {
          console.error('Login error:', error);
          alert('ÁôªÂÖ•Â§±ÊïóÔºö' + error.message);
        }
      };

      const handleLogout = async () => {
        try {
          await window.firebaseSignOut(window.firebaseAuth);
        } catch (error) {
          console.error('Logout error:', error);
        }
      };

      // Wait for Firebase
      useEffect(() => {
        const checkFirebase = () => {
          if (window.firebaseDb) {
            setFirebaseReady(true);
          }
        };
        
        window.addEventListener('firebase-ready', checkFirebase);
        checkFirebase(); // Check immediately in case already loaded
        
        return () => window.removeEventListener('firebase-ready', checkFirebase);
      }, []);

      // Subscribe to entries
      useEffect(() => {
        if (!firebaseReady) return;

        const db = window.firebaseDb;
        const q = window.firebaseQuery(
          window.firebaseCollection(db, 'journal_entries'),
          window.firebaseOrderBy('createdAt', 'desc')
        );

        const unsubscribe = window.firebaseOnSnapshot(q, (snapshot) => {
          const data = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setEntries(data);
          setIsLoading(false);
        });

        return () => unsubscribe();
      }, [firebaseReady]);

      const handleSave = async (data) => {
        const db = window.firebaseDb;
        
        try {
          if (data.id) {
            // Update existing
            await window.firebaseUpdateDoc(
              window.firebaseDoc(db, 'journal_entries', data.id),
              {
                title: data.title,
                content: data.content,
                mood: data.mood,
                tags: data.tags,
                codeSnippet: data.codeSnippet,
                updatedAt: window.firebaseServerTimestamp()
              }
            );
          } else {
            // Create new
            await window.firebaseAddDoc(
              window.firebaseCollection(db, 'journal_entries'),
              {
                title: data.title,
                content: data.content,
                mood: data.mood,
                tags: data.tags,
                codeSnippet: data.codeSnippet,
                createdAt: window.firebaseServerTimestamp(),
                updatedAt: window.firebaseServerTimestamp()
              }
            );
          }
          setIsModalOpen(false);
          setEditingEntry(null);
        } catch (error) {
          console.error('Error saving entry:', error);
          alert('ÂÑ≤Â≠òÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁØáÊó•Ë®òÂóéÔºü')) return;
        
        try {
          const db = window.firebaseDb;
          await window.firebaseDeleteDoc(window.firebaseDoc(db, 'journal_entries', id));
        } catch (error) {
          console.error('Error deleting entry:', error);
          alert('Âà™Èô§Â§±Êïó');
        }
      };

      const openEdit = (entry) => {
        setEditingEntry(entry);
        setIsModalOpen(true);
      };

      const openCreate = () => {
        setEditingEntry(null);
        setIsModalOpen(true);
      };

      return (
        <GameBoyShell activePage="journal">
          {/* Header */}
          <div className="flex justify-between items-end border-b-4 border-[#0f380f] pb-2 mb-4">
            <div>
              <h1 className="text-xl font-bold">üìì JOURNAL</h1>
              <p className="text-xs">
                {user ? `Hi, ${user.displayName?.split(' ')[0] || 'User'}` : 'Vibe Coding Diary'}
              </p>
            </div>
            <div className="flex items-center gap-2">
              {authLoading ? null : user ? (
                <>
                  <button 
                    className="gb-btn text-sm px-3"
                    onClick={openCreate}
                  >+ NEW</button>
                  <button className="login-btn" onClick={handleLogout}>ÁôªÂá∫</button>
                </>
              ) : (
                <button className="login-btn" onClick={handleLogin}>üîë ÁôªÂÖ•</button>
              )}
            </div>
          </div>

          {/* Entry List */}
          <div className="flex-grow overflow-y-auto pr-1" style={{ maxHeight: '200px' }}>
            {isLoading ? (
              <div className="text-center py-4 text-sm">ËºâÂÖ•‰∏≠...</div>
            ) : entries.length === 0 ? (
              <div className="text-center py-4 text-sm opacity-70">
                ÈÇÑÊ≤íÊúâ‰ªª‰ΩïÊó•Ë®ò<br/>{user ? 'ÈªûÊìä +NEW ÈñãÂßãË®òÈåÑÔºÅ' : 'ÁôªÂÖ•ÂæåÂç≥ÂèØÊñ∞Â¢û'}
              </div>
            ) : (
              entries.map(entry => (
                <JournalCard
                  key={entry.id}
                  entry={entry}
                  onClick={openEdit}
                  onDelete={handleDelete}
                  canEdit={!!user}
                />
              ))
            )}
          </div>

          {/* Back Button */}
          <a href="../index.html?booted=true#booted" className="gb-btn menu-item mt-4">
            BACK
          </a>

          {/* Modal */}
          {isModalOpen && (
            <JournalModal
              entry={editingEntry}
              onSave={handleSave}
              onClose={() => { setIsModalOpen(false); setEditingEntry(null); }}
            />
          )}
        </GameBoyShell>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<JournalPage />);
  </script>
</body>
</html>
