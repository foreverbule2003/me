# CB çˆ¬èŸ²è³‡æ–™æµæ¶æ§‹ (CB Crawler Data Flow Architecture)

> **æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2026-01-30
> **ç‹€æ…‹**: Production Ready (Meta-Automation V1.7)

æœ¬æ–‡ä»¶è©³ç´°è¨˜éŒ„äº†ã€Œå¯è½‰å‚µ (CB) æˆ°æƒ…å®¤ã€èˆ‡ã€Œè¨ˆç®—æ©Ÿã€èƒŒå¾Œçš„è‡ªå‹•åŒ–è³‡æ–™æµæ¶æ§‹ã€‚æ­¤ç³»çµ±æ¡ç”¨ **é›™è»Œä¸¦è¡Œ (Dual Track)** ç­–ç•¥ï¼Œç¢ºä¿ç†±é–€æ•¸æ“šçš„å³æ™‚æ€§ï¼ŒåŒæ™‚ç¶­æŒå…¨å¸‚å ´æœç´¢çš„å®Œæ•´æ€§ã€‚

## æ ¸å¿ƒç­–ç•¥ï¼šé›™è»Œåˆ†æµ (Dual Track Strategy)

ç‚ºäº†è§£æ±ºå–®ä¸€æª”æ¡ˆç„¡æ³•åŒæ™‚æ»¿è¶³ã€Œç²¾ç°¡ç†±é–€æ’è¡Œã€èˆ‡ã€Œå®Œæ•´å¸‚å ´æœå°‹ã€çš„çŸ›ç›¾ï¼Œæˆ‘å€‘å°‡è³‡æ–™æµæ‹†åˆ†ç‚ºå…©æ¢ç¨ç«‹è·¯å¾‘ï¼š

### 1. è·¯å¾‘ Aï¼šæˆ°æƒ…å®¤ç†±é–€æ¸…å–® (Hot List) ğŸï¸

- **ç›®æ¨™æª”æ¡ˆ**: `public/data/hot-cb.json`
- **å…§å®¹**: åš´æ ¼ç¯©é¸çš„ **Top 20** æˆäº¤é‡ç†±é–€å¯è½‰å‚µã€‚
- **è³‡æ–™ç‰¹æ€§**:
  - **è¼•é‡**: æª”æ¡ˆæ¥µå°ï¼Œå‰ç«¯è¼‰å…¥ç„¡è² æ“”ã€‚
  - **å³æ™‚**: åƒ…åŒ…å«ç•¶æ—¥æœ‰äº¤æ˜“ä¸”æˆåŠŸæŠ“å–åˆ°åƒ¹æ ¼çš„æ¨™çš„ï¼Œä¿è­‰ç„¡ `NaN`ã€‚
- **ç”¨é€”**: å°ˆä¾› `cb-war-room.html` (æˆ°æƒ…å®¤) é¡¯ç¤ºã€‚

### 2. è·¯å¾‘ Bï¼šå…¨å¸‚å ´æœå°‹ç›®éŒ„ (Master Directory) ğŸ“–

- **ä¸»è¦ä¾†æº**: **Firestore (`cb_history` collection)**
- **å…§å®¹**: å¸‚å ´ä¸Š **300+ æª”** æ‰€æœ‰å¯è½‰å‚µçš„ç¸½é›†ã€‚
- **è³‡æ–™ç‰¹æ€§**:
  - **è§£è€¦**: `cb-data.json` ä¸å†é€²å…¥ Git å€‰åº«ï¼Œè§£æ±ºäº† **"Data in Code" åæ¨¡å¼**ï¼Œé¿å… Git æ­·å²å†—é¤˜ã€‚
  - **å³æ™‚**: æ¯æ¬¡åŒæ­¥å¾Œï¼ŒFirestore å³ç‚ºæ¬Šå¨ç‰ˆæœ¬ï¼Œå‰ç«¯ç„¡éœ€ç­‰å¾…éƒ¨ç½²å³å¯è®€å–ã€‚
  - **é¢¨éšªç®¡ç†**ï¼š
    - **é›¢ç·šæ”¯æ´**ï¼šå¯¦ä½œå‰ç«¯ `LocalStorage` ç·©å­˜ï¼Œç¢ºä¿åœ¨æ–·ç¶²æ™‚ä»èƒ½ä½¿ç”¨æœå°‹åŠŸèƒ½ã€‚
    - **è²»ç”¨æ§åˆ¶**ï¼šåƒ…åœ¨ç·©å­˜éæœŸï¼ˆ1 å°æ™‚ï¼‰æˆ–æ‰‹å‹•å¼·åˆ¶é‡æ–°è¼‰å…¥æ™‚æ‰ Fetch Firestoreï¼Œæ¥µå°åŒ–é›²ç«¯è®€å–æˆæœ¬ã€‚
- **ç”¨é€”**: ä¾› `cb-calculator.html` (è¨ˆç®—æ©Ÿ) ä½¿ç”¨ã€‚

## è‡ªå‹•åŒ–å¾ªç’° (The Automation Loop)

ç³»çµ±ä¾è³´æœ¬åœ° Task Scheduler æˆ–æ‰‹å‹•åŸ·è¡Œé€²è¡Œç¶­è­·ã€‚

### ğŸ“… æ’ç¨‹ (Schedule)

- **æ¯é€±ä¸€ 10:00 (UTC+8)**: é€±åˆåŒæ­¥ã€‚
- **æ¯é€±äº” 14:00 (UTC+8)**: é€±æœ«åŒæ­¥ (ä¸»è¦è³‡æ–™æ›´æ–°é»)ã€‚

### ğŸ”„ åŸ·è¡Œæµç¨‹

1.  **è§¸ç™¼ (Trigger)**: Task Scheduler å•Ÿå‹• `CB_Sync_Master.bat` æˆ– AI åŸ·è¡Œ `/sync-cb`ã€‚
2.  **åŒæ­¥ (Sync)**: åŸ·è¡Œ `xq_bridge.py` ä¸²æ¥ DDE æ•¸æ“šèˆ‡ Excel é«˜ç²¾åº¦æ•¸æ“šã€‚
3.  **å¯«å…¥ (Write)**: ç›´æ¥æ›´æ–° Firestore `cb_history` é›†åˆã€‚
4.  **æœ¬åœ°å¿«å–**: ç”¢å‡ºæœ¬åœ° `cb-data.json`ï¼ˆå·²åœ¨ `.gitignore` ä¸­å¿½ç•¥ï¼Œä¸é€² Gitï¼‰ã€‚
5.  **å‰ç«¯è¼‰å…¥**: ä½¿ç”¨è€…é–‹å•Ÿé é¢æ™‚ï¼Œå‰ç«¯ JS ç›´æ¥ç”± Firestore Fetch æœ€æ–°æ•¸æ“šã€‚

## æ¶æ§‹è¦–è¦ºåŒ– (Architecture Diagram)

```mermaid
graph TD
    %% ä¾†æºèˆ‡è§¸ç™¼
    Sched[Task Scheduler / /sync-cb] -->|10:00, 14:00| Bat[CB_Sync_Master.bat]
    DDE[XQ DDE å ±åƒ¹] -->|å³æ™‚| Bat
    Excel[é«˜ç²¾åº¦è½‰æ›åƒ¹.xlsx] -->|å„ªå…ˆæ¬Š| Bat

    %% æ ¸å¿ƒè™•ç†
    subgraph Data_Pipe [æ•¸æ“šè™•ç†æµæ°´ç·š]
        Bat -->|xq_bridge.py| Protect[é«˜ç²¾åº¦ä¿è­·æ©Ÿåˆ¶]
        Protect -->|æ›´æ–°| Firestore[(Firebase Cloud)]
        Protect -->|Export| LocalJSON[cb-data.json]
    end

    %% Git éš”é›¢
    LocalJSON -.-|Git Ignored| GitRepo((Git Repository))

    %% ä½¿ç”¨è€…ç«¯ (ç€è¦½å™¨)
    subgraph Client_Side [ä½¿ç”¨è€…ç€è¦½å™¨]
        WarRoom[CB æˆ°æƒ…å®¤] -->|fetch| Firestore
        Calculator[CB è¨ˆç®—æ©Ÿ] -->|Firestore Fetch + Cache| Firestore
        HistoryService[æ­·å²èµ°å‹¢åœ–] -->|Direct Fetch| Firestore
    end
```

## æª”æ¡ˆçµæ§‹èªªæ˜

```text
/public/data/
â”œâ”€â”€ hot-cb.json       # [Ignored] ç†±é–€æ¸…å–®
â”œâ”€â”€ cb-data.json      # [Ignored] å¸‚å ´å…¨é›† (åƒ…ä¾›æœ¬åœ°å¿«å–)
â””â”€â”€ history/          # [Deprecated] èˆŠç‰ˆæ­·å²è³‡æ–™å¤¾
```
