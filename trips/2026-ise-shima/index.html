<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¼Šå‹¢å¿—æ‘©â€§å¤§é˜ªç´ é£Ÿè±ªè¯æ…¢æ—…</title>
  <!-- 1. Google Fonts (Inter + DM Sans) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Inter:wght@400;500;700;800;900&display=swap"
    rel="stylesheet" />
  <!-- 2. å¼•å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4F46E5", // Indigo 600 - è—ç´«è‰²
            headerPrimary: "#0F2540", // Shimakaze Deep Blue - Headerå°ˆç”¨æ·±è—
            accent: "#E8968A", // Coral Rose (æµ·é‚Šå¤•é™½)
            dark: "#1C1C1E", // Elegant Black
            subtle: "#6E6E73", // Apple-like Grey
            surface: "#F5F5F0", // Washi Paper White
            star: "#E8968A", // Coral Rose
            love: "#C32F2F", // Deep Red
          },
          borderRadius: {
            "3xl": "24px",
            "4xl": "32px",
          },
          fontFamily: {
            display: ['"Noto Serif JP"', "serif"],
            body: ['"Inter"', "sans-serif"],
          },
        },
      },
    };
  </script>
  <!-- 3. å¼•å…¥ React å’Œ ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- 4. å¼•å…¥ Babel ç”¨ä¾†è§£æ JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 5. å¼•å…¥å…±ç”¨æ¨£å¼ -->
  <link rel="stylesheet" href="../shared/styles.css" />

  <!-- 6. å¼•å…¥å…±ç”¨å…ƒä»¶åº« (éœ€è¦ Babel è™•ç† JSX) -->
  <script src="../shared/config.js"></script>
  <script type="text/babel" src="../shared/icons.js"></script>
  <script type="text/babel" src="../shared/components.js"></script>
  <script src="../shared/app-core.js"></script>
  
  <!-- 7. å¼•å…¥è¡Œç¨‹è³‡æ–™ -->
  <script src="./data.js"></script>
</head>

<body class="bg-surface font-body text-dark selection:bg-accent/20 selection:text-primary">
  <div id="root"></div>


  <script type="text/babel">
    // --- 0. åˆå§‹åŒ– - å¾sharedå…ƒä»¶åº«å¼•å…¥Icons ---
    const { useState, useEffect, useRef } = React;

    // å¾å…±ç”¨å…ƒä»¶åº«å¼•å…¥åœ–ç¤º
    const Icons = window.TripShared.Icons;
    const {
      MapIcon,
      Calendar,
      Wallet,
      Train,
      Utensils,
      Hotel,
      ArrowRight,
      Leaf,
      Star,
      Info,
      Sparkles,
      X,
      Send,
      MapPin,
      Navigation,
      ExternalLink,
      Bot,
      MessageCircle,
      Languages,
      RouteIcon,
      Eye,
      Car,
      Bus,
      Ship,
      ChevronDown,
      ChevronUp,
    } = Icons;

    // å¾å…±ç”¨å…ƒä»¶åº«å¼•å…¥å…ƒä»¶
    const SharedComponents = window.TripShared.components;
    const {
      CollapsibleSection,
      MapModal: SharedMapModal,
      FAB,
      PhaseHeader,
    } = SharedComponents;

    // --- 1. è³‡æ–™å¸¸æ•¸ (å¾ data.js å¼•å…¥) ---
    const {
      strategyData,
      itineraryData,
      budgetData,
      recommendedRoutes,
      usefulLinks,
      kintetsuComparisonData,
      foodData,
    } = window.TripData;

    // --- 2. è¼”åŠ©å‡½æ•¸ (Helper Functions) ---
    // å¾ AppCore å¼•å…¥
    const { cleanQuery, callGeminiAPI } = window.TripShared.AppCore;

    // --- 3. UI å…ƒä»¶ (Components) ---

    // 3.1 Header (Luxury Visual Update)
    const Header = () => (
      <header className="relative w-full py-12 px-6 text-white overflow-hidden">
        <a
          href="../../index.html?booted=true#booted"
          className="absolute top-6 left-6 z-50 p-3 bg-white/10 backdrop-blur-md rounded-full text-white hover:bg-white/20 transition-all border border-white/20 shadow-lg group"
          title="å›åˆ°é¦–é "
        >
          <ArrowRight
            size={24}
            className="rotate-180 group-hover:-translate-x-1 transition-transform"
          />
        </a>
        {/* Background Image & Overlay */}
        <div className="absolute inset-0 z-0 select-none">
          <img
            src="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop"
            alt="Japan Scenery"
            className="w-full h-full object-cover opacity-90 scale-105 animate-[float_20s_ease-in-out_infinite]"
          />
          <div className="absolute inset-0 bg-gradient-to-b from-headerPrimary/90 via-headerPrimary/60 to-surface/100"></div>
          <div className="absolute inset-0 bg-headerPrimary/40 mix-blend-overlay"></div>
        </div>

        <div className="max-w-5xl mx-auto text-center relative z-10">
          <div className="inline-block px-5 py-2 mb-6 rounded-full bg-headerPrimary/30 backdrop-blur-md text-sm font-bold tracking-wider border border-accent/40 text-accent/90 animate-fade-up shadow-lg">
            JP-ISE-OSA-2026-VEG-10D
          </div>
          <h1 className="font-display text-5xl md:text-7xl font-black mb-6 leading-tight tracking-tight animate-fade-up animate-fade-up-delay-1 drop-shadow-xl text-yellow-50">
            ä¼Šå‹¢å¿—æ‘©â€§å¤§é˜ª
            <span className="block text-2xl md:text-3xl mt-4 font-bold tracking-widest font-display opacity-90">
              10æ—¥ç´ é£Ÿæ…¢æ—…
            </span>
          </h1>

        </div>
      </header>
    );

    // 3.2 å¾å…±ç”¨å…ƒä»¶åº«å¼•å…¥ SectionCard
    const { SectionCard } = window.TripShared.components;


    // 3.3 StrategySection - è¡Œç¨‹äº®é»
    const StrategySection = () => (
      <SectionCard icon={Sparkles} title="è¡Œç¨‹äº®é»">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="bg-primary/5 rounded-2xl p-4 text-center">
            <div className="text-3xl font-bold text-primary mb-1">10</div>
            <div className="text-sm text-gray-500">å¤© 9 å¤œ</div>
          </div>
          <div className="bg-primary/5 rounded-2xl p-4 text-center">
            <div className="text-3xl font-bold text-primary mb-1">5</div>
            <div className="text-sm text-gray-500">æ—¥å‘¨éŠåˆ¸</div>
          </div>
          <div className="bg-accent/10 rounded-2xl p-4 text-center">
            <div className="text-2xl mb-1">ğŸŒ¿</div>
            <div className="text-sm text-gray-600 font-medium">ç´ é£Ÿå‹å–„</div>
          </div>
          <div className="bg-accent/10 rounded-2xl p-4 text-center">
            <div className="text-2xl mb-1">â™¨ï¸</div>
            <div className="text-sm text-gray-600 font-medium">æº«æ³‰ç™‚ç™’</div>
          </div>
        </div>
        <div className="mt-6 flex flex-wrap gap-2 justify-center">
          <span className="px-3 py-1.5 bg-headerPrimary/10 text-headerPrimary rounded-full text-xs font-medium">VISON é€£ä½</span>
          <span className="px-3 py-1.5 bg-headerPrimary/10 text-headerPrimary rounded-full text-xs font-medium">è³¢å³¶å¯¶ç”Ÿè‹‘</span>
          <span className="px-3 py-1.5 bg-headerPrimary/10 text-headerPrimary rounded-full text-xs font-medium">ç©ºåº­æº«æ³‰</span>
          <span className="px-3 py-1.5 bg-headerPrimary/10 text-headerPrimary rounded-full text-xs font-medium">USJ</span>
          <span className="px-3 py-1.5 bg-headerPrimary/10 text-headerPrimary rounded-full text-xs font-medium">KIX é€²å‡º</span>
        </div>
      </SectionCard>
    );

    // 3.3.1 UsefulLinksSection (è¡Œç¨‹ç¸½è¦½ç”¨)
    const UsefulLinksSection = () => (
      <SectionCard icon={Sparkles} title="å¯¦ç”¨é€£çµ">
        <div className="grid md:grid-cols-3 gap-4">
          {usefulLinks.categories.map((category, idx) => {
            const iconMap = {
              Train: Train,
              Hotel: Hotel,
              Star: Star,
              MapPin: MapPin,
            };
            const CategoryIcon = iconMap[category.icon] || MapPin;
            return (
              <div
                key={idx}
                className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden"
              >
                <div className="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center gap-2">
                  <CategoryIcon size={16} className="text-accent" />
                  <span className="font-bold text-gray-700 text-sm">{category.label}</span>
                </div>
                <div className="p-2">
                  {category.items.map((item, iIdx) => (
                    <a
                      key={iIdx}
                      href={item.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors group"
                    >
                      <div className="flex items-center gap-2 min-w-0">
                        <span className="text-gray-700 font-medium group-hover:text-primary transition-colors text-sm truncate">
                          {item.name}
                        </span>
                        <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full shrink-0">
                          {item.day}
                        </span>
                      </div>
                      <ExternalLink
                        size={14}
                        className="text-gray-300 group-hover:text-accent shrink-0 ml-2"
                      />
                    </a>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </SectionCard>
    );

    // 3.4 DayCard (Collapsible Version)
    const DayCard = ({ dayData, onOpenRoute, onOpenFoodGuide, isExpanded: controlledExpanded, onToggle }) => {
      // ä½¿ç”¨å—æ§æˆ–éå—æ§æ¨¡å¼
      // ç•¶ controlledExpanded ç‚º null æˆ– undefined æ™‚ï¼Œä½¿ç”¨å…§éƒ¨ç‹€æ…‹
      const [internalExpanded, setInternalExpanded] = useState(true);
      const isControlled = controlledExpanded !== null && controlledExpanded !== undefined;

      // ç•¶å¤–éƒ¨æ§åˆ¶ç‹€æ…‹æ”¹è®Šæ™‚ï¼ŒåŒæ­¥æ›´æ–°å…§éƒ¨ç‹€æ…‹
      useEffect(() => {
        if (isControlled) {
          setInternalExpanded(controlledExpanded);
        }
      }, [controlledExpanded, isControlled]);

      const isExpanded = isControlled ? controlledExpanded : internalExpanded;

      const handleToggle = () => {
        if (isControlled && onToggle) {
          // è§£é™¤å…¨åŸŸæ§åˆ¶ï¼Œä¸¦åˆ‡æ›ç•¶å‰å¡ç‰‡ç‹€æ…‹
          onToggle();
          setInternalExpanded(!controlledExpanded);
        } else {
          setInternalExpanded(!internalExpanded);
        }
      };

      return (
        <div className={`relative bg-white rounded-3xl shadow-md border border-gray-100 hover:shadow-lg transition-all duration-300 flex flex-col overflow-hidden group ${isExpanded ? 'mb-6' : 'mb-3'}`}>
          {/* Image Banner - Clickable Header */}
          <button
            onClick={handleToggle}
            className="w-full relative overflow-hidden cursor-pointer text-left focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-inset transition-all duration-300 h-28"
          >
            <img
              src={dayData.image}
              alt={dayData.title}
              className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-dark/80 to-transparent"></div>
            {/* Top Left: Day Number + Date - Horizontal Badge */}
            <div className="absolute left-4 top-4 transition-all duration-300">
              <span className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-white/10 backdrop-blur-md text-white font-bold text-sm border border-white/20 shadow-lg">
                {typeof dayData.day === "number" ? `D${dayData.day}` : dayData.day}
                {dayData.date && (
                  <>
                    <span className="text-white/50">Â·</span>
                    <span className="font-bold">{dayData.date}</span>
                  </>
                )}
              </span>
            </div>
            {/* Top Right: Expand/Collapse Button */}
            <div className="absolute right-4 top-4 p-2 bg-white/20 backdrop-blur-md rounded-full text-white border border-white/30 transition-all duration-300" style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>
              <ChevronDown size={16} />
            </div>
            {/* Bottom: Title (full width, unified style) */}
            <div className="absolute left-6 right-6 text-white bottom-8 transition-all duration-300">
              <h3 className="font-bold font-display leading-tight text-xl md:text-2xl">
                {dayData.title}
              </h3>
            </div>
          </button>

          {/* Collapsible Content */}
          <div
            className="transition-all duration-300 ease-in-out overflow-hidden"
            style={{
              display: 'grid',
              gridTemplateRows: isExpanded ? '1fr' : '0fr',
            }}
          >
            <div className="min-h-0">
              <div className="p-6 flex-1 flex flex-col">
                <div className="space-y-6 mb-6 flex-1">
                  {dayData.activities.map((act, idx) => {
                    // Check for explicit map data OR arrow for fallback route detection
                    const hasExplicitMap = !!act.map;
                    const hasArrow = act.text.includes("â†’");
                    const isRoute = hasExplicitMap
                      ? act.map.type === "route"
                      : hasArrow;

                    return (
                      <div key={idx} className="group/item">
                        <div className="flex items-start gap-4">
                          <span className="text-xs font-bold text-primary/70 min-w-[3rem] font-mono leading-6">
                            {act.time}
                          </span>

                          <div className="flex-1 min-w-0">
                            {/* Main Title Row */}
                            <div className="flex items-center justify-between gap-2">
                              <div className="text-gray-800 font-bold text-sm leading-6 flex-1">
                                {act.text}
                                {act.link && (
                                  <a
                                    href={act.link}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="ml-2 text-xs text-primary hover:text-primary/80 underline font-normal"
                                  >
                                    æŸ¥æ™‚åˆ»è¡¨ â†—
                                  </a>
                                )}
                              </div>

                              {(hasExplicitMap || hasArrow) && (() => {
                                // æ™ºæ…§åˆ¤æ–·äº¤é€šå·¥å…·é¡å‹
                                const isBus = act.text.includes("å·´å£«") || act.subText?.includes("å·´å£«");
                                const TransportIcon = isBus ? Bus : Train;

                                return (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      if (hasExplicitMap) {
                                        onOpenRoute({
                                          type: act.map.type || "spot",
                                          name: cleanQuery(act.text),
                                          ...act.map,
                                        });
                                      } else if (hasArrow) {
                                        const parts = act.text.split("â†’");
                                        const origin = cleanQuery(parts[0]);
                                        const destination = cleanQuery(
                                          parts[parts.length - 1],
                                        );
                                        onOpenRoute({
                                          type: "route",
                                          name: cleanQuery(act.text),
                                          origin: origin,
                                          destination: destination,
                                        });
                                      }
                                    }}
                                    className="flex-shrink-0 transition-all cursor-pointer hover:scale-110 text-accent w-6 h-6 flex items-center justify-center"
                                    title={isRoute ? "æŸ¥çœ‹äº¤é€šè·¯ç·š" : "æŸ¥çœ‹åœ°é»"}
                                  >
                                    {isRoute ? <TransportIcon size={16} /> : <MapPin size={16} />}
                                  </button>
                                );
                              })()}

                              {/* ç¾é£ŸæŒ‡å—é€£çµåœ–ç¤º (åªåœ¨æ²’æœ‰åœ°åœ–åœ–ç¤ºæ™‚é¡¯ç¤º) */}
                              {act.foodGuideLink && !hasExplicitMap && !hasArrow && onOpenFoodGuide && (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onOpenFoodGuide();
                                  }}
                                  className="flex-shrink-0 text-accent transition-all cursor-pointer hover:scale-110 w-6 h-6 flex items-center justify-center"
                                  title={`æŸ¥çœ‹ã€Œ${act.foodGuideLink}ã€ç¾é£Ÿé¸é …`}
                                >
                                  <Utensils size={16} />
                                </button>
                              )}
                            </div>

                            {/* Sub Text (Secondary Info) */}
                            {act.subText && (
                              <div className="text-xs text-gray-500 mt-0.5 font-medium">{act.subText}</div>
                            )}

                            {/* Tips / Warnings */}
                            {act.tips && (
                              <div className="mt-2 text-xs text-orange-700 bg-orange-50 border border-orange-100 px-3 py-1.5 rounded-lg inline-block leading-relaxed">
                                <span className="font-bold mr-1">âš ï¸</span> {act.tips}
                              </div>
                            )}

                            {/* Info Note */}
                            {act.note && (
                              <div className="mt-1 text-xs text-primary/70 flex items-start gap-1 leading-relaxed">
                                <Info size={12} className="mt-0.5 shrink-0" /> {act.note}
                              </div>
                            )}

                            {/* Detailed Sub-Items (Tables/Lists) */}
                            {act.subItems && (
                              <div className="mt-3 bg-gray-50 rounded-xl border border-gray-100 overflow-hidden">
                                {act.subItems.map((sub, si) => (
                                  <div key={si} className="flex flex-wrap items-baseline justify-between px-3 py-2 border-b border-gray-100 last:border-0 text-xs hover:bg-white transition-colors">
                                    <span className="font-bold text-gray-700 mr-2">{sub.title}</span>
                                    <span className="text-gray-500">{sub.content}</span>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div className="mt-auto pt-6 border-t border-gray-50">
                  <div className="flex items-start gap-3 p-3 rounded-xl bg-gradient-to-br from-white to-gray-50 border border-gray-100">
                    <div className="p-2 bg-accent/10 text-accent rounded-lg shrink-0">
                      <Sparkles size={16} />
                    </div>
                    <div>
                      <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-0.5">HIGHLIGHT</div>
                      <div className="text-sm font-medium text-gray-700 leading-relaxed">
                        {dayData.highlight}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // 3.5 BudgetTable
    const BudgetTable = () => {
      const RATE_TWD = 0.22;
      const totalJPY = budgetData.reduce((acc, curr) => acc + curr.cost, 0);
      const totalTWD = Math.round(totalJPY * RATE_TWD);

      return (
        <SectionCard icon={Wallet} title={<div className="flex flex-col md:flex-row md:items-end gap-1"><span>é ç®—æ¦‚ç®—</span><span className="text-sm font-normal text-gray-400 md:ml-2 mb-0.5">(2äººåŒè¡Œï¼Œæ¯äººå¹³å‡)</span></div>}>
          {/* Desktop View: Table */}
          <div className="hidden md:block overflow-x-auto rounded-xl border border-gray-100">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-primary/5 text-primary">
                  <th className="p-3 font-bold text-sm whitespace-nowrap">é …ç›®</th>
                  <th className="p-3 font-bold text-sm whitespace-nowrap">é‡‘é¡ (JPY)</th>
                  <th className="p-3 font-bold text-sm whitespace-nowrap">é ä¼°å°å¹£ (ç´„)</th>
                  <th className="p-3 font-bold text-sm whitespace-nowrap">èªªæ˜</th>
                </tr>
              </thead>
              <tbody className="text-gray-600">
                {budgetData.map((row, idx) => (
                  <tr
                    key={idx}
                    className="border-b border-gray-100 hover:bg-accent/5 transition-colors"
                  >
                    <td className="p-3 font-bold text-gray-700 text-sm whitespace-nowrap">
                      {row.item}
                    </td>
                    <td className="p-3 font-bold tabular-nums text-gray-900 text-sm whitespace-nowrap">
                      Â¥{row.cost.toLocaleString()}
                    </td>
                    <td className="p-3 font-bold tabular-nums text-gray-500 text-sm whitespace-nowrap">
                      ${Math.round(row.cost * RATE_TWD).toLocaleString()}
                    </td>
                    <td className="p-3 text-sm text-subtle min-w-[200px]">{row.note}</td>
                  </tr>
                ))}
                <tr className="bg-primary/5 text-gray-800 font-bold border-t-2 border-primary/20">
                  <td className="p-3 rounded-bl-lg text-sm whitespace-nowrap">ç¸½è¨ˆ</td>
                  <td className="p-3 font-bold tabular-nums text-xl text-primary font-black whitespace-nowrap">
                    Â¥{totalJPY.toLocaleString()}
                  </td>
                  <td className="p-3 font-bold tabular-nums text-xl text-gray-500 font-black whitespace-nowrap">
                    ${totalTWD.toLocaleString()}
                  </td>
                  <td className="p-3 rounded-br-lg text-gray-500 font-normal text-sm">
                    é ç®—é‡é»ï¼šåƒå¾—å¥½ã€ä½å¾—å¥½ã€ç§»å‹•èˆ’é© (åŒ¯ç‡: {RATE_TWD})
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* Mobile View: Card List */}
          <div className="md:hidden space-y-3">
            {budgetData.map((row, idx) => (
              <div key={idx} className="p-4 bg-white border border-gray-100 rounded-xl shadow-sm flex flex-col gap-2">
                <div className="flex justify-between items-start">
                  <div className="font-bold text-gray-800 text-sm">{row.item}</div>
                  <div className="text-right">
                    <div className="font-bold tabular-nums text-primary text-sm">Â¥{row.cost.toLocaleString()}</div>
                    <div className="text-xs text-gray-400 tabular-nums">ç´„ ${Math.round(row.cost * RATE_TWD).toLocaleString()}</div>
                  </div>
                </div>
                <div className="text-xs text-gray-500 bg-gray-50 p-2 rounded-lg leading-relaxed">
                  {row.note}
                </div>
              </div>
            ))}
            {/* Mobile Total Card */}
            <div className="p-4 bg-primary/5 border border-primary/20 rounded-xl shadow-sm">
              <div className="flex justify-between items-center mb-2">
                <span className="font-bold text-gray-800 text-sm">ç¸½è¨ˆ (é ä¼°)</span>
                <div className="text-right">
                  <div className="font-black tabular-nums text-xl text-primary">Â¥{totalJPY.toLocaleString()}</div>
                  <div className="text-sm text-gray-500 tabular-nums font-bold">ç´„ ${totalTWD.toLocaleString()}</div>
                </div>
              </div>
              <div className="text-xs text-gray-500 text-center pt-2 border-t border-primary/10">
                é ç®—é‡é»ï¼šåƒå¾—å¥½ã€ä½å¾—å¥½ã€ç§»å‹•èˆ’é© (åŒ¯ç‡: {RATE_TWD})
              </div>
            </div>
          </div>
        </SectionCard>
      );
    };

    // 3.6 MapModal - ä½¿ç”¨å…±ç”¨å…ƒä»¶ (SharedMapModal)

    // 3.7 MapView
    const MapView = ({ onOpenMap }) => {
      const [isKintetsuOpen, setIsKintetsuOpen] = React.useState(true);
      const [isBusOpen, setIsBusOpen] = React.useState(true);
      const [isRoutesOpen, setIsRoutesOpen] = React.useState(true);

      return (
        <div className="space-y-8 animate-fade-in">
          <SectionCard icon={Train} title="äº¤é€šè³‡è¨Š">

            {/* è¿‘éµç‰¹æ€¥æ¯”è¼ƒè¡¨ */}
            <div className="mb-8">
              <button
                onClick={() => setIsKintetsuOpen(!isKintetsuOpen)}
                className="w-full text-base font-bold text-gray-800 mb-4 flex items-center justify-between gap-2 group"
              >
                <div className="flex items-center gap-2">
                  <Train className="text-accent" size={18} />
                  è¿‘éµç‰¹æ€¥ vs æ™®é€š/æ€¥è¡Œ æ¯”è¼ƒè¡¨
                </div>
                <ChevronDown
                  size={20}
                  className={`text-gray-400 transition-transform duration-300 ${isKintetsuOpen ? "rotate-180" : ""}`}
                />
              </button>

              {isKintetsuOpen && (
                <div className="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden animate-fade-in">
                  <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse whitespace-nowrap">
                      <thead>
                        <tr className="bg-primary/5 text-primary">
                          <th className="p-3 font-bold text-sm">æ—¥æœŸ</th>
                          <th className="p-3 font-bold text-sm">å€é–“</th>
                          <th className="p-3 font-bold text-sm">æ™®é€š/æ€¥è¡Œ (å…è²»)</th>
                          <th className="p-3 font-bold text-sm">ç‰¹æ€¥ (åŠ åƒ¹)</th>
                          <th className="p-3 font-bold text-sm">ç‰¹æ€¥åˆ¸è²»ç”¨</th>
                        </tr>
                      </thead>
                      <tbody className="text-gray-600">
                        {kintetsuComparisonData.map((row, idx) => (
                          <tr key={idx} className="border-b border-gray-100 hover:bg-accent/5 transition-colors">
                            <td className="p-3 font-bold text-primary text-sm">{row.day}</td>
                            <td className="p-3 text-sm font-medium">{row.route}</td>
                            <td className="p-3 text-sm text-gray-500">{row.regular}</td>
                            <td className="p-3 text-sm text-green-600 font-medium">{row.express}</td>
                            <td className="p-3 text-sm font-bold tabular-nums text-accent">{row.cost}</td>
                          </tr>
                        ))}
                      </tbody>
                      <tfoot>
                        <tr className="bg-primary/5 text-gray-800 font-bold border-t-2 border-primary/20">
                          <td colSpan={4} className="p-3 text-sm text-right pr-4">ç‰¹æ€¥åˆ¸ç¸½è²»ç”¨ (å…¨ç¨‹æ­ç‰¹æ€¥)</td>
                          <td className="p-3 text-lg text-primary font-black">Â¥4,320</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                  <div className="p-3 bg-orange-50 border-t border-orange-100 text-sm text-orange-700 flex items-start gap-2">
                    <Info size={16} className="shrink-0 mt-0.5" />
                    <span>è¿‘éµå‘¨éŠåˆ¸ 5æ—¥åˆ¸ plus <strong>ä¸å«ç‰¹æ€¥åˆ¸</strong>ï¼Œæ­ä¹˜ç‰¹æ€¥éœ€å¦è³¼ç‰¹æ€¥åˆ¸ã€‚æ™®é€š/æ€¥è¡Œå…è²»ä½†è€—æ™‚è¼ƒé•· (åŒ¯ç‡: 0.22)ã€‚</span>
                  </div>
                </div>
              )}
            </div>


            {/* ä¸‰é‡äº¤é€šå·´å£«æ™‚åˆ»è¡¨ */}
            <div className="mb-8">
              <button
                onClick={() => setIsBusOpen(!isBusOpen)}
                className="w-full text-base font-bold text-gray-800 mb-4 flex items-center justify-between gap-2 group"
              >
                <div className="flex items-center gap-2">
                  <Bus className="text-accent" size={18} />
                  æ¾é˜ªé§… â‡” VISON æ™‚åˆ»è¡¨ (å¹³æ—¥)
                </div>
                <ChevronDown
                  size={20}
                  className={`text-gray-400 transition-transform duration-300 ${isBusOpen ? "rotate-180" : ""}`}
                />
              </button>

              {isBusOpen && (
                <div className="space-y-4 animate-fade-in">
                  <div className="flex justify-end">
                    <a
                      href="https://vison.jp/access/"
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-xs font-bold text-accent hover:text-accent/80 flex items-center gap-1 transition-colors"
                    >
                      æŸ¥çœ‹å®˜æ–¹äº¤é€šè³‡è¨Š <ExternalLink size={14} />
                    </a>
                  </div>
                  <div className="grid md:grid-cols-2 gap-4">
                    {/* Matsusaka -> VISON */}
                    <div className="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden">
                      <div className="bg-primary/5 p-3 text-center font-bold text-primary border-b border-primary/10">æ¾é˜ªé§…å‰ â†’ VISON</div>
                      <div className="grid grid-cols-2 bg-gray-50/50 border-b border-gray-100 font-bold text-xs text-gray-500">
                        <div className="px-4 py-2 border-r border-gray-100">ç™¼è»Š</div>
                        <div className="px-4 py-2">æŠµé”</div>
                      </div>
                      <div className="text-sm">
                        {[
                          ["8:05", "8:55"], ["9:30", "10:12"], ["10:25", "11:07"],
                          ["12:45", "13:27"], ["13:20", "14:02"], ["14:45", "15:27"],
                          ["15:45", "16:27"], ["17:05", "17:51"], ["18:05", "18:47"]
                        ].map(([dep, arr], i) => (
                          <div key={i} className="grid grid-cols-2 border-b border-gray-100 hover:bg-accent/5 transition-colors">
                            <div className="px-4 py-2 font-medium text-gray-800 border-r border-gray-100 tabular-nums">{dep}</div>
                            <div className="px-4 py-2 text-gray-600 tabular-nums">{arr}</div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* VISON -> Matsusaka */}
                    <div className="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden">
                      <div className="bg-primary/5 p-3 text-center font-bold text-primary border-b border-primary/10">VISON â†’ æ¾é˜ªé§…å‰</div>
                      <div className="grid grid-cols-2 bg-gray-50/50 border-b border-gray-100 font-bold text-xs text-gray-500">
                        <div className="px-4 py-2 border-r border-gray-100">ç™¼è»Š</div>
                        <div className="px-4 py-2">æŠµé”</div>
                      </div>
                      <div className="text-sm">
                        {[
                          ["10:23", "11:06"], ["11:00", "11:43"], ["12:23", "13:06"],
                          ["14:00", "14:43"], ["15:28", "16:11"], ["16:40", "17:23"],
                          ["17:08", "18:02"], ["19:05", "19:48"]
                        ].map(([dep, arr], i) => (
                          <div key={i} className="grid grid-cols-2 border-b border-gray-100 hover:bg-accent/5 transition-colors">
                            <div className="px-4 py-2 font-medium text-gray-800 border-r border-gray-100 tabular-nums">{dep}</div>
                            <div className="px-4 py-2 text-gray-600 tabular-nums">{arr}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="mb-8">
              <button
                onClick={() => setIsRoutesOpen(!isRoutesOpen)}
                className="w-full text-base font-bold text-gray-800 mb-4 flex items-center justify-between gap-2 group"
              >
                <div className="flex items-center gap-2">
                  <RouteIcon className="text-accent" size={18} />
                  æ¯æ—¥é—œéµäº¤é€šç§»å‹•è·¯å¾‘ç¸½è¦½
                </div>
                <ChevronDown
                  size={20}
                  className={`text-gray-400 transition-transform duration-300 ${isRoutesOpen ? "rotate-180" : ""}`}
                />
              </button>

              {isRoutesOpen && (
                <div className="grid md:grid-cols-2 gap-4 animate-fade-in">
                  {recommendedRoutes.map((route) => (
                    <button
                      key={route.id}
                      onClick={() =>
                        onOpenMap({
                          type: "route",
                          name: route.name,
                          origin: route.from,
                          destination: route.to,
                        })
                      }
                      className="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md hover:border-primary/40 transition-all text-left flex items-start gap-3 group"
                    >
                      <div className="p-2 bg-primary/5 rounded-lg text-primary group-hover:bg-primary group-hover:text-white transition-colors shrink-0">
                        <div className="text-center">
                          <div className="text-[10px] font-bold uppercase leading-none mb-1">
                            {route.day.split(" ")[0]}
                          </div>
                          <div className="text-lg font-bold leading-none">
                            {route.day.split(" ")[1]}
                          </div>
                        </div>
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between gap-2">
                          <div className="font-bold text-gray-800 group-hover:text-primary truncate">
                            {route.name}
                          </div>
                          {route.duration && route.duration !== "â€”" && (
                            <span className="text-xs font-bold text-white bg-accent px-2 py-0.5 rounded-full shrink-0">
                              {route.duration}
                            </span>
                          )}
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          {route.desc}
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </div>
          </SectionCard>
        </div>
      );
    };

    // 3.8 FoodView - ç¾é£ŸæŒ‡å— (ä½¿ç”¨ data.js ä¸­çš„ foodData)

    const FoodView = () => {
      // æ”¶åˆç‹€æ…‹
      const [collapsedCategories, setCollapsedCategories] = React.useState({});

      // æ„›å¿ƒæ”¶è—ç‹€æ…‹ (ä½¿ç”¨ localStorage æŒä¹…åŒ–)
      const [favorites, setFavorites] = React.useState(() => {
        try {
          const saved = localStorage.getItem('food-favorites');
          return saved ? JSON.parse(saved) : {};
        } catch {
          return {};
        }
      });

      // å„²å­˜åˆ° localStorage
      React.useEffect(() => {
        localStorage.setItem('food-favorites', JSON.stringify(favorites));
      }, [favorites]);

      const toggleCategory = (idx) => {
        setCollapsedCategories(prev => ({
          ...prev,
          [idx]: !prev[idx]
        }));
      };

      const toggleFavorite = (itemKey) => {
        setFavorites(prev => ({
          ...prev,
          [itemKey]: !prev[itemKey]
        }));
      };

      // ç”¢ç”Ÿå”¯ä¸€çš„ item key (åªä½¿ç”¨ç´¢å¼•ç¢ºä¿å”¯ä¸€æ€§)
      const getItemKey = (catIdx, secIdx, itemIdx) => {
        return `food-${catIdx}-${secIdx}-${itemIdx}`;
      };

      // æ’åºï¼šæ„›å¿ƒé …ç›®æ’åœ¨å‰é¢
      const sortItems = (items, catIdx, secIdx) => {
        return [...items].sort((a, b) => {
          const aIdx = items.indexOf(a);
          const bIdx = items.indexOf(b);
          const aKey = getItemKey(catIdx, secIdx, aIdx);
          const bKey = getItemKey(catIdx, secIdx, bIdx);
          const aFav = favorites[aKey] ? 1 : 0;
          const bFav = favorites[bKey] ? 1 : 0;
          return bFav - aFav; // æ„›å¿ƒçš„æ’å‰é¢
        });
      };

      return (
        <div className="space-y-8 animate-fade-in">
          <SectionCard icon={Utensils} title="ç¾é£ŸæŒ‡å—">
            <p className="text-gray-600 mb-6">
              è¡Œç¨‹ä¸­çš„ç´ é£Ÿå‹å–„é¤å»³ã€ç”œé»èˆ‡å¿…åƒç¾é£Ÿæ•´ç†ã€‚
            </p>
            <div className="grid md:grid-cols-2 gap-6">
              {foodData.categories.map((category, idx) => {
                const isCollapsed = collapsedCategories[idx];
                return (
                  <div key={idx} className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden h-fit">
                    <button
                      onClick={() => toggleCategory(idx)}
                      className="w-full px-5 py-4 bg-accent/10 border-b border-accent/20 flex items-center justify-between cursor-pointer hover:bg-accent/15 transition-colors text-left"
                    >
                      <h3 className="font-bold text-gray-800 flex items-center gap-2">
                        <MapPin size={18} className="text-accent" />
                        {category.location}
                      </h3>
                      <div className="flex items-center gap-2">
                        <span className="text-xs font-bold text-accent bg-white px-3 py-1 rounded-full shadow-sm">
                          {category.day}
                        </span>
                        <ChevronDown
                          size={20}
                          className={`text-accent/70 transition-transform duration-300 ${isCollapsed ? "" : "rotate-180"}`}
                        />
                      </div>
                    </button>

                    <div
                      className={`transition-all duration-300 ease-in-out overflow-hidden ${isCollapsed ? 'max-h-0 opacity-0' : 'max-h-[5000px] opacity-100'}`}
                    >
                      <div className="p-4 space-y-6">
                        {category.sections.map((section, sIdx) => (
                          <div key={sIdx}>
                            <h4 className="text-sm font-bold text-gray-800 mb-3">{section.title}</h4>
                            <div className="space-y-2">
                              {section.items.map((item, originalIdx) => {
                                const itemKey = getItemKey(idx, sIdx, originalIdx);
                                const isFavorite = favorites[itemKey];
                                return { ...item, originalIdx, itemKey, isFavorite };
                              }).sort((a, b) => (b.isFavorite ? 1 : 0) - (a.isFavorite ? 1 : 0))
                                .map((item) => (
                                  <div
                                    key={item.itemKey}
                                    className={`p-3 rounded-xl border transition-all duration-300 ${item.isFavorite
                                      ? "bg-pink-50 border-pink-200"
                                      : item.recommended
                                        ? "bg-accent/5 border-accent/30"
                                        : "bg-gray-50 border-gray-100"
                                      }`}
                                  >
                                    <div className="flex items-start gap-2">
                                      {/* æ„›å¿ƒæŒ‰éˆ• */}
                                      <button
                                        onClick={() => toggleFavorite(item.itemKey)}
                                        className={`p-1.5 rounded-lg transition-all shrink-0 ${item.isFavorite
                                          ? "bg-pink-100 text-pink-500"
                                          : "bg-gray-100 text-gray-400 hover:bg-pink-50 hover:text-pink-400"
                                          }`}
                                        title={item.isFavorite ? "å–æ¶ˆç½®é ‚" : "æƒ³åƒï¼ç½®é ‚"}
                                      >
                                        <Star size={14} fill={item.isFavorite ? "currentColor" : "none"} />
                                      </button>

                                      <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-1.5 mb-0.5">
                                          {item.recommended && (
                                            <span className="text-[10px] font-bold text-white bg-accent px-1.5 py-0.5 rounded shrink-0">æ¨è–¦</span>
                                          )}
                                          <span className="text-xs text-gray-400 shrink-0">{item.type}</span>
                                        </div>
                                        <div className="font-bold text-gray-800 text-sm leading-snug">{item.name}</div>
                                        <p className="text-xs text-gray-600 mt-1">{item.desc}</p>
                                        {item.note && (
                                          <p className="text-xs text-orange-600 mt-1">{item.note}</p>
                                        )}
                                      </div>
                                      <div className="flex items-center gap-2 shrink-0">
                                        {item.price && (
                                          <span className="text-xs font-medium text-gray-500">{item.price}</span>
                                        )}
                                        {item.mapUrl && (
                                          <a
                                            href={item.mapUrl}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="p-1.5 bg-primary/10 rounded-lg text-primary hover:bg-primary hover:text-white transition-colors"
                                            title="åœ¨ Google Maps ä¸­é–‹å•Ÿ"
                                          >
                                            <Navigation size={14} />
                                          </a>
                                        )}
                                      </div>
                                    </div>
                                  </div>
                                ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </SectionCard>
        </div>
      );
    };

    // 3.9 AI & Translation Components
    const AIChatBubble = ({ sender, text }) => (
      <div
        className={`flex ${sender === "user" ? "justify-end" : "justify-start"
          } mb-4`}
      >
        <div
          className={`max-w-[80%] rounded-3xl p-4 text-sm leading-relaxed ${sender === "user"
            ? "bg-primary text-white rounded-br-none"
            : "bg-white border border-gray-100 text-gray-700 shadow-sm rounded-bl-none"
            }`}
        >
          {text}
        </div>
      </div>
    );

    const TranslatorButton = ({ label, prompt, onTranslate, isLoading }) => (
      <button
        onClick={() => onTranslate(prompt)}
        disabled={isLoading}
        className="w-full text-left p-3 rounded-xl border border-gray-200 hover:border-primary/50 hover:bg-primary/5 transition-all duration-200 group flex items-center justify-between"
      >
        <span className="font-medium text-gray-700 group-hover:text-primary">
          {label}
        </span>
        <Sparkles
          size={16}
          className="text-gray-300 group-hover:text-primary"
        />
      </button>
    );

    const AIModal = ({ isOpen, onClose }) => {
      const [activeFeature, setActiveFeature] = useState("chat");
      const [chatHistory, setChatHistory] = useState([
        {
          sender: "ai",
          text: "å—¨ï¼æˆ‘æ˜¯æ‚¨çš„ç´ é£Ÿæ—…éŠ AI åŠ©æ‰‹ã€‚é—œæ–¼è¡Œç¨‹ã€ç´ é£Ÿé¤å»³æˆ–æ—¥æœ¬æ—…éŠçš„å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼âœ¨",
        },
      ]);
      const [inputText, setInputText] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [translationResult, setTranslationResult] = useState(null);
      const chatEndRef = useRef(null);

      useEffect(() => {
        if (chatEndRef.current) {
          chatEndRef.current.scrollIntoView({ behavior: "smooth" });
        }
      }, [chatHistory, activeFeature]);

      if (!isOpen) return null;

      const handleSendMessage = async () => {
        if (!inputText.trim()) return;

        const userMsg = inputText;
        setChatHistory((prev) => [
          ...prev,
          { sender: "user", text: userMsg },
        ]);
        setInputText("");
        setIsLoading(true);

        const response = await callGeminiAPI(userMsg);

        setChatHistory((prev) => [...prev, { sender: "ai", text: response }]);
        setIsLoading(false);
      };

      const handleTranslate = async (restriction) => {
        setIsLoading(true);
        setTranslationResult(null);
        const prompt = `
                    Please translate the following dietary restriction into natural, polite Japanese for a restaurant staff member.
                    Constraint: "${restriction}"
                    
                    Format the output exactly as:
                    Japanese: [Japanese text]
                    Pronunciation: [Romaji]
                    Meaning: [Brief explanation in Traditional Chinese]
                `;
        const response = await callGeminiAPI(
          prompt,
          "You are a translator. Keep formatting simple and clean.",
        );
        setTranslationResult(response);
        setIsLoading(false);
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
          <div className="bg-gray-50 w-full max-w-lg h-[600px] rounded-3xl shadow-2xl flex flex-col overflow-hidden relative anim-slideUp-h1">
            <div className="bg-primary p-4 flex items-center justify-between text-white shrink-0">
              <div className="flex items-center gap-2">
                <Bot size={24} className="text-primary/30" />
                <h3 className="font-bold text-lg">AI æ—…éŠåŠ©æ‰‹</h3>
              </div>
              <button
                onClick={onClose}
                className="p-1 hover:bg-white/20 rounded-full transition-colors"
              >
                <X size={20} />
              </button>
            </div>

            <div className="flex p-2 bg-white border-b border-gray-100 gap-2 shrink-0">
              <button
                onClick={() => setActiveFeature("chat")}
                className={`flex-1 py-2 flex items-center justify-center gap-2 rounded-lg text-sm font-semibold transition-colors ${activeFeature === "chat"
                  ? "bg-primary/10 text-primary"
                  : "text-gray-500 hover:bg-gray-100"
                  }`}
              >
                <MessageCircle size={16} /> è¡Œç¨‹é¡§å•
              </button>
              <button
                onClick={() => setActiveFeature("translate")}
                className={`flex-1 py-2 flex items-center justify-center gap-2 rounded-lg text-sm font-semibold transition-colors ${activeFeature === "translate"
                  ? "bg-primary/10 text-primary"
                  : "text-gray-500 hover:bg-gray-100"
                  }`}
              >
                <Languages size={16} /> ç´ é£Ÿæºé€šå¡
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
              {activeFeature === "chat" && (
                <div className="flex flex-col min-h-full justify-end">
                  <div className="flex-1 pb-4">
                    {chatHistory.map((msg, idx) => (
                      <AIChatBubble
                        key={idx}
                        sender={msg.sender}
                        text={msg.text}
                      />
                    ))}
                    {isLoading && (
                      <div className="flex justify-start mb-4">
                        <div className="bg-white border border-gray-100 rounded-3xl p-4 text-gray-400 text-sm shadow-sm flex items-center gap-2">
                          <Sparkles
                            size={14}
                            className="animate-spin text-primary"
                          />{" "}
                          AI æ€è€ƒä¸­...
                        </div>
                      </div>
                    )}
                    <div ref={chatEndRef} />
                  </div>
                </div>
              )}

              {activeFeature === "translate" && (
                <div className="space-y-4">
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-primary/20">
                    <h4 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                      <Leaf size={16} className="text-green-500" />{" "}
                      ç´ é£Ÿæºé€šå¡ (è«‹ç›´æ¥å‡ºç¤ºçµ¦åº—å“¡)
                    </h4>

                    <div className="space-y-4">
                      {/* Card 1: åˆ†å€é£²é£Ÿéœ€æ±‚ (NGç´…å€ / OKç¶ å€) */}
                      <div className="p-4 rounded-xl bg-white border border-gray-200 shadow-sm">
                        <p className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-1.5">
                          <span className="text-red-500">ğŸš«</span> é£Ÿäº‹åˆ¶é™ (é£²é£Ÿç¦å¿Œ)
                        </p>

                        {/* NG Section */}
                        <div className="mb-3 p-3 bg-red-50 border border-red-100 rounded-lg">
                          <p className="text-lg font-bold text-red-600 leading-relaxed">
                            ç§ã¯è‚‰ã¨é­šä»‹é¡ãŒé£Ÿã¹ã‚‰ã‚Œã¾ã›ã‚“ã€‚<br />
                            <span className="border-b-2 border-red-200">è‚‰ã‚„é­šã®å‡ºæ±ï¼ˆã ã—ï¼‰ã‚‚NGã§ã™ã€‚</span>
                          </p>
                          <p className="text-xs text-red-500/70 mt-2 font-medium">(æˆ‘ä¸åƒè‚‰ã€æµ·é®®ï¼Œä»¥åŠå«è‚‰æˆ–é­šçš„é«˜æ¹¯)</p>
                        </div>

                        {/* OK Section */}
                        <div className="p-3 bg-green-50 border border-green-100 rounded-lg">
                          <p className="text-lg font-bold text-green-700 leading-relaxed">
                            ã§ã‚‚ã€åµãƒ»ä¹³è£½å“ãƒ»ãƒã‚®ãƒ»ãƒ‹ãƒ³ãƒ‹ã‚¯ã¯é£Ÿã¹ã‚‰ã‚Œã¾ã™ã€‚
                          </p>
                          <div className="mt-2 text-xs text-green-700/70 font-medium">
                            (ä½†æˆ‘<span className="font-bold border-b border-green-400">å¯ä»¥åƒ</span>é›è›‹ã€ç‰›å¥¶ã€è”¥ã€è’œ)
                          </div>
                        </div>
                      </div>

                      {/* Card 2: é«˜æ¹¯ç¢ºèª */}
                      <div className="p-4 rounded-xl bg-blue-50/50 border border-blue-100">
                        <p className="text-xs font-bold text-gray-500 mb-1">ğŸŸ å‡ºæ±ã®ç¢ºèª (é«˜æ¹¯ç¢ºèª)</p>
                        <p className="text-xl font-bold text-gray-900 mb-2 leading-relaxed">
                          ã“ã®æ–™ç†ã«ã€é°¹ç¯€ã‚„é­šã®å‡ºæ±ã¯å…¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ
                        </p>
                        <p className="text-xs text-blue-500/70 mt-1 font-medium">(è«‹å•é€™é“èœå«æœ‰æŸ´é­šæˆ–é­šé¡é«˜æ¹¯å—ï¼Ÿ)</p>
                      </div>

                      {/* Card 3: å¯é£Ÿæ¸…å–® */}
                      <div className="p-4 rounded-xl bg-gray-50 border border-gray-200">
                        <p className="text-xs font-bold text-gray-500 mb-1">âœ… é£Ÿã¹ã‚‰ã‚Œã‚‹ã‚‚ã® (å¯é£Ÿæ¸…å–®)</p>
                        <ul className="grid grid-cols-2 gap-2 mt-2">
                          <li className="flex items-center gap-2 text-sm font-bold text-gray-700"><span className="text-green-500">âœ”</span> åµ (é›è›‹)</li>
                          <li className="flex items-center gap-2 text-sm font-bold text-gray-700"><span className="text-green-500">âœ”</span> ä¹³è£½å“ (ç‰›å¥¶/èµ·å¸)</li>
                          <li className="flex items-center gap-2 text-sm font-bold text-gray-700"><span className="text-green-500">âœ”</span> ç‰ã­ã (æ´‹è”¥)</li>
                          <li className="flex items-center gap-2 text-sm font-bold text-gray-700"><span className="text-green-500">âœ”</span> ãƒ‹ãƒ³ãƒ‹ã‚¯ (å¤§è’œ)</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {activeFeature === "chat" && (
              <div className="p-4 bg-white border-t border-gray-100 shrink-0">
                <div className="flex items-center gap-2">
                  <input
                    type="text"
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyDown={(e) =>
                      e.key === "Enter" && handleSendMessage()
                    }
                    placeholder="è¼¸å…¥å•é¡Œï¼Œä¾‹å¦‚ï¼šé™„è¿‘æœ‰æ¨è–¦çš„é»å¿ƒå—ï¼Ÿ"
                    className="flex-1 px-4 py-2.5 bg-gray-100 border-none rounded-full focus:ring-2 focus:ring-primary outline-none transition-all"
                  />
                  <button
                    onClick={handleSendMessage}
                    disabled={isLoading}
                    className="p-3 bg-primary text-white rounded-full hover:bg-primary/90 disabled:opacity-50 transition-colors shadow-md"
                  >
                    <Send size={18} />
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // --- 4. ä¸»ç¨‹å¼ (Main Application) ---

    const App = () => {
      const [activeTab, setActiveTab] = useState("itinerary");
      const [isAIModalOpen, setIsAIModalOpen] = useState(false);
      const [mapModalData, setMapModalData] = useState({
        isOpen: false,
        data: null,
      });
      // å…¨éƒ¨å±•é–‹/æŠ˜ç–Šç‹€æ…‹ï¼štrue = å…¨éƒ¨å±•é–‹, false = å…¨éƒ¨æŠ˜ç–Š, null = å€‹åˆ¥æ§åˆ¶
      const [allExpanded, setAllExpanded] = useState(true);
      // éšæ®µæ”¶åˆç‹€æ…‹ï¼š{ 0: true, 1: true } ä»£è¡¨å…©å€‹éšæ®µéƒ½å±•é–‹
      const [phaseExpanded, setPhaseExpanded] = useState(
        itineraryData.reduce((acc, _, idx) => ({ ...acc, [idx]: true }), {})
      );

      const tabs = [
        { id: "overview", label: "è¡Œç¨‹ç¸½è¦½", icon: MapIcon },
        { id: "itinerary", label: "æ¯æ—¥è©³æƒ…", icon: Calendar },
        { id: "map", label: "è¡Œç¨‹åœ°åœ–", icon: Navigation },
        { id: "food", label: "ç¾é£ŸæŒ‡å—", icon: Utensils },
        { id: "budget", label: "é ç®—è¦åŠƒ", icon: Wallet },
      ];

      const handleOpenMap = (data) => {
        setMapModalData({ isOpen: true, data });
      };

      return (
        <div className="min-h-screen bg-gray-50 font-sans selection:bg-primary/20 selection:text-primary pb-24 md:pb-12">
          <Header />

          <div className="sticky top-0 z-40 glass shadow-sm border-b border-gray-100/50">
            <div className="max-w-5xl mx-auto px-4">
              <nav className="flex items-center justify-around gap-1 sm:gap-2 md:gap-8 py-3 md:py-4">
                {tabs.map((tab) => {
                  const isActive = activeTab === tab.id;
                  const TabIcon = tab.icon;
                  return (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`
                                                flex items-center justify-center gap-1 sm:gap-2 px-3 py-2 sm:px-4 sm:py-2.5 md:px-5 rounded-full font-medium transition-all duration-300 whitespace-nowrap text-xs sm:text-sm md:text-base
                                                ${isActive
                          ? "bg-primary text-white shadow-md transform scale-105"
                          : "bg-transparent text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                        }
                                            `}
                    >
                      <TabIcon size={18} className="flex-shrink-0" />
                      <span className="hidden sm:inline">{tab.label}</span>
                    </button>
                  );
                })}
              </nav>
            </div>
          </div>

          <main className="max-w-5xl mx-auto px-6 py-8">
            {activeTab === "overview" && (
              <div className="animate-fade-in space-y-8">
                <StrategySection />

                <div className="grid md:grid-cols-2 gap-8">
                  {itineraryData.map((phase, idx) => (
                    <div
                      key={idx}
                      className="bg-white rounded-3xl p-6 shadow-md border-t-4 border-primary"
                    >
                      <h3 className="text-xl font-bold text-gray-800 mb-4 pb-2 border-b border-gray-100">
                        {phase.phase}
                      </h3>
                      <div className="space-y-4">
                        {phase.days.map((day, dIdx) => (
                          <div key={dIdx} className="flex items-start gap-3">
                            <div className="min-w-[3rem] text-sm font-bold text-primary bg-primary/5 px-2 py-1 rounded text-center">
                              D{day.day}
                            </div>
                            <div className="text-gray-700 text-sm font-medium pt-1">
                              {day.title}
                            </div>
                          </div>
                        ))}
                      </div>
                      <button
                        onClick={() => setActiveTab("itinerary")}
                        className="mt-6 w-full py-2 flex items-center justify-center gap-2 text-primary font-semibold text-sm hover:bg-primary/5 rounded-lg transition-colors"
                      >
                        æŸ¥çœ‹è©³æƒ… <ArrowRight size={16} />
                      </button>
                    </div>
                  ))}
                </div>

                <UsefulLinksSection />
              </div>
            )}

            {activeTab === "itinerary" && (
              <div className="space-y-6">
                {/* ç§»é™¤ç¨ç«‹çš„å…¨åŸŸæŒ‰éˆ•å€å¡Šï¼Œæ”¹æ•´åˆé€²ä¸‹æ–¹ */}

                {itineraryData.map((phase, idx) => (
                  <div key={idx} className="relative">
                    <button
                      onClick={() => setPhaseExpanded(prev => ({ ...prev, [idx]: !prev[idx] }))}
                      className="sticky top-[52px] z-30 w-full bg-gray-50/95 backdrop-blur py-3 md:py-4 cursor-pointer text-left focus:outline-none group"
                    >
                      <h2 className="text-base md:text-xl font-bold text-gray-600 flex items-center gap-2">
                        <span className="w-1 h-6 md:h-8 bg-accent rounded-full"></span>
                        {phase.phase}


                        <span className="ml-auto text-gray-400 group-hover:text-primary transition-colors">
                          {phaseExpanded[idx] ? (
                            <ChevronUp size={18} />
                          ) : (
                            <ChevronDown size={18} />
                          )}
                        </span>
                      </h2>
                    </button>
                    <div
                      className={`grid grid-cols-1 md:grid-cols-2 gap-6 transition-all duration-300 overflow-hidden ${phaseExpanded[idx] ? 'opacity-100 max-h-[9999px]' : 'opacity-0 max-h-0'
                        }`}
                    >
                      {phase.days.map((day, dIdx) => (
                        <DayCard
                          key={dIdx}
                          dayData={day}
                          onOpenRoute={handleOpenMap}
                          onOpenFoodGuide={() => setActiveTab("food")}
                          isExpanded={allExpanded}
                          onToggle={() => setAllExpanded(null)}
                        />
                      ))}
                    </div>
                  </div>
                ))}



                <div className="flex justify-center mt-12">
                  <button
                    onClick={() =>
                      window.scrollTo({ top: 0, behavior: "smooth" })
                    }
                    className="px-5 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
                  >
                    å›åˆ°é ‚éƒ¨
                  </button>
                </div>
              </div>
            )}

            {activeTab === "budget" && (
              <div className="max-w-3xl mx-auto">
                <BudgetTable />
                <div className="mt-8 p-6 bg-primary/5 rounded-3xl flex gap-4 items-start">
                  <Info className="text-primary flex-shrink-0 mt-1" />
                  <div className="text-sm text-primary leading-relaxed">
                    <p className="font-bold mb-1">é—œæ–¼é è¨‚</p>
                    å»ºè­°æå‰ 3-6 å€‹æœˆé–‹å§‹é è¨‚ä½å®¿ä»¥ç¢ºä¿æ—©é³¥å„ªæƒ ã€‚Shimakaze
                    è§€å…‰ç‰¹æ€¥éœ€åœ¨ä¹˜è»Šæ—¥å‰ä¸€å€‹æœˆä¸Šåˆ 10:30 æº–æ™‚æ¶ç¥¨ã€‚
                  </div>
                </div>
              </div>
            )}

            {activeTab === "map" && <MapView onOpenMap={handleOpenMap} />}

            {activeTab === "food" && <FoodView />}
          </main>

          {/* FAB Group */}
          <div className="fixed bottom-6 right-6 z-50 flex flex-col gap-3 items-end">
            {/* Itinerary Toggle FAB */}
            {activeTab === "itinerary" && (
              <button
                onClick={() => setAllExpanded(allExpanded === true ? false : true)}
                className="p-3 rounded-full bg-white/70 backdrop-blur-md text-primary shadow-xl border border-white/50 hover:bg-white hover:text-primary transition-all duration-300 group relative"
              >
                {allExpanded === true ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                <span className="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-gray-900/80 backdrop-blur text-white text-xs font-bold py-1.5 px-3 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                  {allExpanded === true ? "å…¨éƒ¨æŠ˜ç–Š" : "å…¨éƒ¨å±•é–‹"}
                </span>
              </button>
            )}

            {/* AI Assistant FAB */}
            <button
              onClick={() => setIsAIModalOpen(true)}
              className="p-3 rounded-full bg-white/70 backdrop-blur-md text-primary shadow-xl border border-white/50 hover:bg-white hover:text-primary transition-all duration-300 group relative"
            >
              <Sparkles size={24} className="animate-pulse" />
              <span className="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-gray-900/80 backdrop-blur text-white text-xs font-bold py-1.5 px-3 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                AI æ—…éŠé¡§å•
              </span>
            </button>
          </div>

          <AIModal
            isOpen={isAIModalOpen}
            onClose={() => setIsAIModalOpen(false)}
          />
          <SharedMapModal
            isOpen={mapModalData.isOpen}
            onClose={() =>
              setMapModalData({ ...mapModalData, isOpen: false })
            }
            data={mapModalData.data}
          />

          <footer className="text-center py-8 text-gray-400 text-sm">
            <p>Â© 2026 ä¼Šå‹¢å¿—æ‘©â€§å¤§é˜ªç´ é£Ÿè±ªè¯æ…¢æ—… v6 (KIX é€²å‡ºç‰ˆ)</p>
          </footer>
        </div>
      );
    };

    // --- 5. æ¸²æŸ“æ‡‰ç”¨ (Render App) ---
    // ä½¿ç”¨ AppCore çš„åˆå§‹åŒ–å‡½å¼
    const { initTripApp } = window.TripShared.AppCore;
    initTripApp(App);
  </script>
</body>

</html>
```