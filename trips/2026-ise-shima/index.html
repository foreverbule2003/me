<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¼Šå‹¢å¿—æ‘©â€§å¤§é˜ªç´ é£Ÿè±ªè¯æ…¢æ—…</title>
  <!-- 1. Google Fonts (Inter + DM Sans) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Inter:wght@400;700;800;900&family=DM+Sans:wght@400;500;700&display=swap"
    rel="stylesheet" />
  <!-- 2. å¼•å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#0F2540", // Shimakaze Deep Blue
            accent: "#E8968A", // Coral Rose (æµ·é‚Šå¤•é™½)
            dark: "#1C1C1E", // Elegant Black
            subtle: "#6E6E73", // Apple-like Grey
            surface: "#F5F5F0", // Washi Paper White
            star: "#E8968A", // Coral Rose
            love: "#C32F2F", // Deep Red
          },
          borderRadius: {
            "3xl": "24px",
            "4xl": "32px",
          },
          fontFamily: {
            display: ['"Noto Serif JP"', "serif"],
            body: ['"DM Sans"', "sans-serif"],
          },
        },
      },
    };
  </script>
  <!-- 3. å¼•å…¥ React å’Œ ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- 4. å¼•å…¥ Babel ç”¨ä¾†è§£æ JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 5. å¼•å…¥å…±ç”¨æ¨£å¼ -->
  <link rel="stylesheet" href="../shared/styles.css" />

  <!-- 6. å¼•å…¥å…±ç”¨å…ƒä»¶åº« (éœ€è¦ Babel è™•ç† JSX) -->
  <script src="../shared/config.js"></script>
  <script type="text/babel" src="../shared/icons.js"></script>
  <script type="text/babel" src="../shared/components.js"></script>
</head>

<body class="bg-surface font-body text-dark selection:bg-accent/20 selection:text-primary">
  <div id="root"></div>


  <script type="text/babel">
    // --- 0. åˆå§‹åŒ– - å¾sharedå…ƒä»¶åº«å¼•å…¥Icons ---
    const { useState, useEffect, useRef } = React;

    // å¾å…±ç”¨å…ƒä»¶åº«å¼•å…¥åœ–ç¤º
    const Icons = window.TripShared.Icons;
    const {
      MapIcon,
      Calendar,
      Wallet,
      Train,
      Utensils,
      Hotel,
      ArrowRight,
      Leaf,
      Star,
      Info,
      Sparkles,
      X,
      Send,
      MapPin,
      Navigation,
      ExternalLink,
      Bot,
      MessageCircle,
      Languages,
      RouteIcon,
      Eye,
      Car,
      Bus,
      Ship,
    } = Icons;


    // --- 1. è³‡æ–™å¸¸æ•¸ (Data Constants) ---

    const strategyData = {
      title: "é—œéµç­–ç•¥ (v21 é«˜é‡å±±é›ªæ™¯ç‰ˆ)",
      content:
        "ç”±å¤§é˜ª KIX é€²å‡ºã€‚Day 1 åœç•™æ©Ÿå ´å‘¨é‚Šï¼ŒDay 2 ç›´å¥” VISON é€£ä½å…©æ™šï¼Œå„ªåŒ– 5 æ—¥å‘¨éŠåˆ¸æ•ˆç›Š (Day 2-6)ã€‚Day 10 å®‰æ’é«˜é‡å±±è³é›ªï¼Œé«”é©—ç¥è–æ°›åœã€‚",
      transport: [
        "è¿‘éµé›»è»Šå‘¨éŠåˆ¸ 5æ—¥åˆ¸ plus (Day 2-6 ä½¿ç”¨)",
        "è§€å…‰ç‰¹æ€¥ Shimakaze (å¿—æ‘©ä¹‹é¢¨) - Day 6 æ­ä¹˜ (è³¢å³¶â†’å¤§é˜ªé›£æ³¢)",
        "å—æµ·é«˜é‡ç·š (Day 10 ä½¿ç”¨)",
      ],
      accommodation: [
        "Day 1 (æ©Ÿå ´): OMO é—œè¥¿æ©Ÿå ´ by æ˜Ÿé‡é›†åœ˜ (å¤§æµ´å ´)",
        "Day 2-3 (åœ’å€): Hotel Vison (é€£ä½å…©æ™š)",
        "Day 4 (å¸‚å€): ä¼Šå‹¢å¸‚å€é£¯åº— / Comfort Hotel",
        "Day 5 (æº«æ³‰): è³¢å³¶å¯¶ç”Ÿè‹‘ (æ—¥å¼æº«æ³‰æ—…é¤¨)",
        "Day 6-10 (éƒ½å¸‚): å¤§é˜ªé›£æ³¢/å¿ƒé½‹æ©‹ä¸€å¸¶",
        "Day 11 (æ©Ÿå ´): é—œè¥¿æ©Ÿå ´è¯ç››é “é£¯åº—",
      ],
    };

    const itineraryData = [
      {
        phase: "ç¬¬ä¸€éšæ®µï¼šä¼Šå‹¢å¿—æ‘©åº¦å‡æ…¢æ—… (Day 1 - Day 6)",
        days: [
          {
            day: 1,
            title: "é—œè¥¿æŠµé”ï¼Rinku Outlet",
            image: "https://images.unsplash.com/photo-1569336415962-a4bd9f69cd83?q=80&w=2070&auto=format&fit=crop",
            time: "13:00 - ä½å®¿",
            activities: [
              { time: "13:00", text: "æŠµé”é—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX)", map: { query: "Kansai International Airport" } },
              { time: "14:00", text: "äº¤é€šï¼šæ©Ÿå ´ â†’ è‡¨ç©ºåŸ", subText: "æ¥é§å·´å£«æˆ–å—æµ·é›»éµ (ä¸€ç«™)", map: { query: "Rinku Town Station" } },
              {
                time: "14:30",
                text: "è³¼ç‰©ï¼šRinku Premium Outlets",
                note: "åˆ¥å¿˜äº†å» Hoka Store (å€è™Ÿ6700)",
                map: { query: "Rinku Premium Outlets" }
              },
              { time: "18:00", text: "æ™šé¤ï¼šOutlet å…§/å‘¨é‚Š", subText: "Snow Peak Eat, è’¼ç‰ ç­‰" },
              {
                time: "19:30",
                text: "ä½å®¿ï¼šOMO Kansai Airport",
                subText: "æ˜Ÿé‡é›†åœ˜æ©Ÿå ´é£¯åº—",
                note: "ä½å®¢å°ˆç”¨å¤§æµ´å ´/æ¡‘æ‹¿",
                map: { query: "OMO Kansai Airport" }
              },
            ],
            highlight: "ğŸ›ï¸ è½åœ°å³è³¼ç‰©ï¼ç›´å¥” Rinku Outlet è²·è£å‚™ï¼Œå…¥ä½æ˜Ÿé‡é›†åœ˜æ©Ÿå ´é£¯åº—äº«å—å¤§æµ´å ´ã€‚",
          },
          {
            day: 2,
            title: "ç›´å¥” VISONï¼åœ’å€æ¢ç´¢",
            image: "https://images.unsplash.com/photo-1481026469463-66327c86e544?q=80&w=2108&auto=format&fit=crop",
            time: "10:00 - 20:00",
            activities: [
              {
                time: "10:00",
                text: "OMO â†’ é›£æ³¢",
                subText: "å—æµ·é›»éµ (Â¥970)",
                map: { type: "route", origin: "Kansai Airport Station", destination: "Namba Station" }
              },
              {
                time: "11:00",
                text: "é›£æ³¢ â†’ æ¾é˜ª",
                subText: "è¿‘éµç‰¹æ€¥ (ç´„80åˆ†)",
                note: "å•Ÿç”¨å‘¨éŠåˆ¸ 5æ—¥plusï¼Œå¦éœ€è³¼ç‰¹æ€¥åˆ¸ Â¥1640",
                map: { type: "route", origin: "Osaka-Namba Station", destination: "Matsusaka Station" }
              },
              {
                time: "12:30",
                text: "æ¾é˜ª â†’ VISON",
                subText: "ä¸‰é‡äº¤é€šå·´å£« (ç´„45åˆ†)",
                map: { type: "route", origin: "Matsusaka Station", destination: "VISON Mie" }
              },
              {
                time: "14:00",
                text: "åˆé¤ï¼šNOUNIYELL è¾²å ´é¤å»³",
                note: "æœ‰æ©Ÿè”¬èœæ–™ç† (å¥—é¤ Â¥3,500)"
              },
              {
                time: "15:00",
                text: "å…¥ä½ Hotel Vison",
                subText: "Check-in 15:00",
                map: { query: "Hotel Vison" }
              },
              {
                time: "15:30",
                text: "åˆå¾Œæ•£æ­¥",
                subText: "Sweet Village (ç”œé»å€)",
                subItems: [
                  { title: "LE CHOCOLAT DE H", content: "è¾»å£åšå•“å·§å…‹åŠ›" },
                  { title: "Mariage de Farine", content: "çŸ³è‡¼ç¾ç£¨å°éº¥éºµåŒ…" }
                ]
              },
              {
                time: "20:00",
                text: "é«”é©—ï¼šæœ¬è‰æ¹¯",
                subText: "è—¥è‰æº«æ³‰ (ä½å®¢å…è²»)",
                note: "å¤œæ™šå¯æ¬£è³åœ’å€æ˜Ÿç©º ğŸŒŸ",
                map: { query: "VISON Honzo Yu" }
              },
            ],
            highlight: "ğŸšŒ å•Ÿç”¨å‘¨éŠåˆ¸ï¼Œç›´å¥”æ—¥æœ¬æœ€å¤§å•†æ¥­åº¦å‡åœ’å€ VISONã€‚ç‰¹æ€¥åˆ¸éœ€å¦è³¼ã€‚",
          },
          {
            day: 3,
            title: "VISON æ·±åº¦é«”é©— (é€£ä½)",
            image: "https://images.unsplash.com/photo-1544367563-12123d8c115c?q=80&w=2070&auto=format&fit=crop",
            time: "å…¨æ—¥",
            activities: [
              {
                time: "08:00",
                text: "æ—©é¤ï¼šå¬‰é‡ã¨ã†ãµ æˆ– Buffet",
                tips: "å¬‰é‡è±†è…éœ€æå‰ 5 å¤©é ç´„"
              },
              {
                time: "10:00",
                text: "æ™¨é–“é«”é©—",
                subText: "æœ¬è‰æ¹¯æ™¨æ¹¯ / HONZO lab. RINNE",
                subItems: [
                  { title: "HONZO lab.", content: "å’Œè‰èŒ¶ã€ç´”ç´ ç”œé»" },
                  { title: "æœ¬è‰æ¹¯", content: "06:00 - 00:00 é–‹æ”¾" }
                ]
              },
              { time: "12:00", text: "åˆé¤ï¼šraf è‡ªåŠ©é¤æˆ–æ¿ƒæ¹¯", note: "æä¾›ç•¶åœ°è”¬èœæ–™ç†" },
              { time: "14:00", text: "è³¼ç‰©æ™‚å…‰", note: "è³¼è²· VISON é™å®šä¼´æ‰‹ç¦®" },
              { time: "18:00", text: "æ™šé¤ï¼šSan Sebastian Street", subText: "è¥¿ç­ç‰™é¢¨æƒ…ç¾é£Ÿè¡—" },
              { time: "20:00", text: "ä½å®¿ï¼šVISON (ç¬¬äºŒæ™š)" },
            ],
            highlight: "â™¨ï¸ ä¸è¶•è»Šçš„æ‚ é–’ä¸€å¤©ï¼Œä½å®¢å…è²»ç„¡é™æ¬¡ä½¿ç”¨æœ¬è‰æ¹¯ã€‚",
          },
          {
            day: 4,
            title: "ä¼Šå‹¢ç¥å®®å…§å®®æ…¢éŠ",
            image: "https://images.unsplash.com/photo-1694175173949-1c2bc79b99dc?q=80&w=2070&auto=format&fit=crop",
            time: "11:00 - 17:00",
            activities: [
              { time: "11:00", text: "äº¤é€šï¼šVISON â†’ æ¾é˜ª", subText: "å·´å£«", map: { type: "route", origin: "VISON Mie", destination: "Matsusaka Station" } },
              { time: "12:00", text: "äº¤é€šï¼šæ¾é˜ª â†’ ä¼Šå‹¢å¸‚", subText: "è¿‘éµç‰¹æ€¥ (ç‰¹æ€¥åˆ¸+Â¥520)", map: { type: "route", origin: "Matsusaka Station", destination: "Iseshi Station" } },
              {
                time: "13:00",
                text: "åˆé¤ï¼šæ‰˜ç¦æ©«ä¸",
                subText: "Oharai-machi",
                subItems: [
                  { title: "å¿…åƒ", content: "è±†è…å†°æ·‡æ·‹" },
                  { title: "åç”¢", content: "èµ¤ç¦ (Akafuku)" }
                ],
                map: { query: "Oharai Machi Ise" }
              },
              {
                time: "14:30",
                text: "åƒæ‹œï¼šä¼Šå‹¢ç¥å®® (å…§å®®)",
                note: "æ—¥æœ¬äººå¿ƒéˆæ•…é„‰ï¼Œä¸‹åˆäººæ½®è¼ƒå°‘",
                map: { query: "Ise Jingu Naiku" }
              },
              {
                time: "17:00",
                text: "å…¥ä½ï¼šä¼Šå‹¢å¸‚å€é£¯åº—",
                subText: "Comfort Hotel Ise",
                map: { query: "Comfort Hotel Ise" }
              },
            ],
            highlight: "â›©ï¸ åƒæ‹œæ—¥æœ¬äººå¿ƒéˆæ•…é„‰ï¼Œæ¼«æ­¥æ‰˜ç¦æ©«ä¸äº«å—è€è¡—ç¾é£Ÿã€‚",
          },
          {
            day: 5,
            title: "å‰å¾€è³¢å³¶åº¦å‡",
            image: "https://images.unsplash.com/photo-1490761668535-35497054764d?q=80&w=2070&auto=format&fit=crop",
            time: "10:00 - ä½å®¿",
            activities: [
              { time: "10:00", text: "äº¤é€šï¼šä¼Šå‹¢å¸‚ â†’ è³¢å³¶", subText: "è¿‘éµç‰¹æ€¥ (ç‰¹æ€¥åˆ¸+Â¥520)", map: { type: "route", origin: "Iseshi Station", destination: "Kashikojima Station" } },
              { time: "12:00", text: "åˆé¤/åˆèŒ¶ï¼šå¿—æ‘©åœ°ä¸­æµ·æ‘", subText: "æµ·æ™¯å’–å•¡å»³", map: { query: "Shima Mediterranean Village" } },
              {
                time: "15:00",
                text: "å…¥ä½ï¼šè³¢å³¶å¯¶ç”Ÿè‹‘",
                subText: "Kashikojima Hojoen",
                note: "è»Šç«™æä¾›å…è²»æ¥é§è»Š (ç´„3åˆ†)",
                tips: "è»Šç«™å…¨å®¶è¶…å•† 18:00 é—œé–€ï¼Œè«‹ææ—©è²·å®µå¤œ",
                map: { query: "Kashikojima Hojoen" }
              },
            ],
            highlight: "ğŸŒŠ å¿—æ‘©åŠå³¶çµ•ç¾æµ·æ™¯ + å‚³çµ±æº«æ³‰æ—…é¤¨æ‡·çŸ³æ–™ç†ã€‚",
          },
          {
            day: 6,
            title: "Shimakaze è±ªè¯å›ç¨‹",
            image: "https://images.unsplash.com/photo-1732142029568-605e2d534ac1?q=80&w=2070&auto=format&fit=crop",
            time: "11:00 - 19:30",
            activities: [
              { time: "11:00", text: "é€€æˆ¿å¯„æ”¾è¡Œæ", note: "è»Šç«™ç½®ç‰©æ«ƒ (ç™»æ©Ÿç®± Â¥600/æ¬¡)" },
              {
                time: "11:30",
                text: "è§€å…‰ï¼šè³¢å³¶è¥¿ç­ç‰™éŠèˆ¹",
                subText: "è‹±è™ç£å·¡éŠ (50åˆ†)",
                note: "æ†‘å‘¨éŠåˆ¸æŠ˜æŠµ Â¥100",
                map: { query: "Kashikojima Espana Cruise" }
              },
              { time: "12:30", text: "æ•£æ­¥ï¼šè³¢å³¶å¤§æ©‹ & çœŸç åº—" },
              { time: "13:30", text: "åˆé¤ï¼šè³¢å³¶ Cafe", subText: "è»Šç«™2Fç°¡é¤" },
              {
                time: "16:00",
                text: "äº¤é€šï¼šè§€å…‰ç‰¹æ€¥ Shimakaze",
                subText: "è³¢å³¶ â†’ å¤§é˜ªé›£æ³¢",
                tips: "éœ€æå‰ä¸€å€‹æœˆé ç´„ï¼Œç‰¹æ€¥+è»Šå»‚åˆ¸ Â¥2690",
                map: { type: "route", origin: "Kashikojima Station", destination: "Osaka-Namba Station" }
              },
              { time: "19:30", text: "æ™šé¤ï¼šå¤§é˜ªå¸‚å€", note: "åƒæˆ¿å¤§é˜ªç‡’ (ç´ é£Ÿ) ç­‰" },
            ],
            highlight: "ğŸš‚ é ­ç­‰è‰™ç´š Shimakaze è§€å…‰åˆ—è»Šï¼Œç‚ºä¼Šå‹¢å¿—æ‘©ä¹‹æ—…ç•«ä¸‹è±ªè¯å¥é»ã€‚",
          },
        ],
      },
      {
        phase: "ç¬¬äºŒéšæ®µï¼šå¤§é˜ª & é«˜é‡å±± & è¿”ç¨‹ (Day 7 - Day 12)",
        days: [
          {
            day: 7,
            title: "æ¢…ç”°æ‚ é–’è³¼ç‰© & USJ",
            image: "https://images.unsplash.com/photo-1612404834746-1ffba06de133?q=80&w=2070&auto=format&fit=crop",
            time: "11:00 - 20:00",
            activities: [
              {
                time: "11:00",
                text: "è³¼ç‰©ï¼šæ¢…ç”°å•†åœˆ",
                subText: "LUCUA / Yodobashi / Grand Front",
                map: { query: "LUCUA Osaka" }
              },
              {
                time: "13:00",
                text: "åˆé¤ï¼šæ¢…ç”°ç´ é£Ÿå‹å–„",
                subItems: [
                  { title: "Chabuton", content: "Yodobashi 8F (ç´ é£Ÿæ‹‰éºµ)" },
                  { title: "2foods", content: "LUCUA Eagle Park (å…¨ç´ )" }
                ]
              },
              {
                time: "17:00",
                text: "æ¨‚åœ’ï¼šUSJ ç’°çƒå½±åŸ",
                subText: "Evening Entry",
                tips: "å–„ç”¨ Single Rider ç¯€çœæ™‚é–“",
                map: { query: "Universal Studios Japan" }
              },
            ],
            highlight: "ğŸ¢ å¹´ç¥¨å„ªå‹¢ï¼šç™½å¤©è³¼ç‰©ï¼Œå‚æ™šå…¥åœ’é¿é–‹äººæ½®ã€‚",
          },
          {
            day: 8,
            title: "æµ·éŠé¤¨ç™‚ç™’ & å“ˆåˆ©æ³¢ç‰¹",
            image: "https://images.unsplash.com/photo-1534351590666-13e3e96b5017?q=80&w=2070&auto=format&fit=crop",
            time: "10:00 - 20:00",
            activities: [
              { time: "10:00", text: "æ™¯é»ï¼šå¤§é˜ªæµ·éŠé¤¨", subText: "é¯¨é¯Šã€æ°´æ¯å€å¿…çœ‹", map: { query: "Osaka Aquarium Kaiyukan" } },
              { time: "16:00", text: "æ¨‚åœ’ï¼šäºŒé€² USJ", subText: "æŒå¹´ç¥¨å…¥å ´", map: { query: "Universal Studios Japan" } },
              { time: "18:00", text: "é«”é©—ï¼šå“ˆåˆ©æ³¢ç‰¹é­”æ³•ä¸–ç•Œ", note: "å¤œæ™šåŸå ¡å…‰å½±èˆ‡æ°›åœæ¥µä½³" },
            ],
            highlight: "ğŸ¦ˆ ç™‚ç™’æµ·æ´‹ç”Ÿç‰©èˆ‡é­”æ³•ä¸–ç•Œçš„å®Œç¾çµåˆã€‚",
          },
          {
            day: 9,
            title: "ç©ºåº­æº«æ³‰ç´”äº«æ—¥",
            image: "https://images.unsplash.com/photo-1580536735231-158a127a3c75?q=80&w=2070&auto=format&fit=crop",
            time: "10:00 - 19:00",
            activities: [
              { time: "10:00", text: "äº¤é€šï¼šé›£æ³¢ â†’ å¼å¤©ç”º", subText: "JR å¤§é˜ªç’°ç‹€ç·šæˆ–åœ°éµ", map: { type: "route", origin: "Osaka-Namba Station", destination: "Bentencho Station" } },
              {
                time: "11:00",
                text: "é«”é©—ï¼šç©ºåº­æº«æ³‰",
                subText: "Solaniwa Onsen",
                subItems: [
                  { title: "ç‰¹è‰²", content: "å®‰åœŸæ¡ƒå±±æ™‚ä»£é€ æ™¯" },
                  { title: "è¨­æ–½", content: "å…è²»æµ´è¡£ã€å¤©ç©ºåº­åœ’è¶³æ¹¯" }
                ],
                map: { query: "Solaniwa Onsen Osaka" }
              },
              { time: "18:30", text: "æ™šé¤ï¼šå¤§é˜ªå¸‚å€ç´ é£Ÿ", note: "æ¢…ä¹‹èŠ± (è±†è…æ‡·çŸ³) æˆ– Green Earth" },
            ],
            highlight: "â™¨ï¸ å¤§é˜ªå¸‚å€æœ€å¤§æº«æ³‰ä¸»é¡Œæ¨‚åœ’ï¼Œä¸ç”¨èˆŸè»Šå‹é “å³å¯ç©¿æµ´è¡£æ‹ç…§æ‰“å¡ã€‚",
          },
          {
            day: 10,
            title: "é«˜é‡å±±é›ªæ™¯ä¸€æ—¥éŠ",
            image: "https://images.unsplash.com/photo-1545569341-9eb8b30979d9?q=80&w=2070&auto=format&fit=crop",
            time: "08:00 - 19:00",
            activities: [
              {
                time: "08:00",
                text: "äº¤é€šï¼šé›£æ³¢ â†’ æ¥µæ¨‚æ©‹",
                subText: "å—æµ·é«˜é‡ç·š (æ€¥è¡Œç´„90åˆ†)",
                map: { type: "route", origin: "Namba Station", destination: "Gokurakubashi Station" }
              },
              { time: "09:30", text: "äº¤é€šï¼šæ¥µæ¨‚æ©‹ â†’ é«˜é‡å±±", subText: "ç™»å±±çºœè»Š + å—æµ·æ—é–“å·´å£«" },
              { time: "10:30", text: "åƒæ‹œï¼šå£‡ä¸Šä¼½è—", note: "æœ±ç´…æ ¹æœ¬å¤§å¡”èˆ‡ç™½é›ªçµ•æ™¯", map: { query: "Danjo Garan" } },
              { time: "12:00", text: "åˆé¤ï¼šç²¾é€²æ–™ç†", subText: "å®¿åŠæˆ–å‘¨é‚Šé¤å»³" },
              { time: "14:00", text: "åƒæ‹œï¼šå¥§ä¹‹é™¢", note: "æˆ°åœ‹æ­¦å°‡å¤å¢“ç¾¤ï¼Œæ°£æ°›èŠåš´", map: { query: "Okunoin Cemetery" } },
              { time: "16:00", text: "äº¤é€šï¼šè¿”å›å¤§é˜ªé›£æ³¢", subText: "ç´„ 2 å°æ™‚è»Šç¨‹" },
              { time: "æ™šä¸Š", text: "æ™šé¤è‡ªç”±é£Ÿ", tips: "é«˜é‡å±±1æœˆæ°£æº«é›¶ä¸‹ï¼Œè«‹è‘—é‡è£ä¿æš–ï¼" },
            ],
            highlight: "â„ï¸ 1æœˆé™å®šçµ•ç¾é›ªæ™¯ï¼Œæ¢è¨ªä¸–ç•Œéºç”¢é«˜é‡å±±ç¥è–æ°›åœã€‚",
          },
          {
            day: 11,
            title: "æœ€å¾Œæ¡è³¼ & æ©Ÿå ´ä½å®¿",
            image: "https://images.unsplash.com/photo-1569336415962-a4bd9f69cd83?q=80&w=2070&auto=format&fit=crop",
            time: "10:00 - 19:00",
            activities: [
              { time: "10:00", text: "äº¤é€šï¼šå¤§é˜ª â†’ è‡¨ç©ºåŸ", map: { type: "route", origin: "Namba Station", destination: "Rinku Town Station" } },
              { time: "11:00", text: "è³¼ç‰©ï¼šRinku Premium Outlets", note: "æœ€å¾Œè¡åˆºï¼Œç‡Ÿæ¥­è‡³20:00", map: { query: "Rinku Premium Outlets" } },
              { time: "18:00", text: "æ™šé¤ï¼šTRIAL è¶…å¸‚ (24H)", subText: "æˆ– Outlet å…§é¤å»³" },
              {
                time: "19:00",
                text: "ä½å®¿ï¼šé—œè¥¿æ©Ÿå ´è¯ç››é “é£¯åº—",
                subText: "Kansai Airport Washington Hotel",
                map: { query: "Kansai Airport Washington Hotel" }
              },
            ],
            highlight: "ğŸ›ï¸ ä½æ©Ÿå ´æ—ï¼Œä¸ç”¨æ“”å¿ƒæ—©ç­æ©Ÿã€‚",
          },
          {
            day: 12,
            title: "å„ªé›…è¿”ç¨‹",
            image: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=2070&auto=format&fit=crop",
            time: "08:00 - 10:00",
            activities: [
              { time: "08:00", text: "äº¤é€šï¼šå‰å¾€é—œè¥¿æ©Ÿå ´", subText: "é£¯åº—å…è²»æ¥é§è»Š (ç´„10åˆ†)" },
              { time: "10:00", text: "Check-in & è¿”ç¨‹", note: "å¸¶è‘—æˆ°åˆ©å“èˆ‡å›æ†¶å›å®¶ âœˆï¸" },
            ],
            highlight: "âœˆï¸ å®Œç¾èˆ‡å……æ»¿å›æ†¶çš„æ—…ç¨‹ã€‚",
          },
        ],
      },
    ];

    const budgetData = [
      {
        item: "æ©Ÿç¥¨ (TPE-KIX)",
        cost: 42000,
        note: "ç´„ $9,240 TWD (ä¾†å›ä¼°ç®—)",
      },
      {
        item: "äº¤é€š (è¿‘éµå‘¨éŠåˆ¸)",
        cost: 6900,
        note: "ç´„ $1,518 TWD (5æ—¥åˆ¸ plus)",
      },
      {
        item: "äº¤é€š (ç‰¹æ€¥åˆ¸/å…¶ä»–)",
        cost: 10370,
        note: "ç´„ $2,281 TWD (å« Shimakaze & å—æµ·ç­‰)",
      },
      {
        item: "ä½å®¿ (11æ³Š)",
        cost: 80000,
        note: "ç´„ $17,600 TWD (å« OMO, VISON, å¯¶ç”Ÿè‹‘ç­‰)",
      },
      {
        item: "é¤é£²è²»",
        cost: 30000,
        note: "ç´„ $6,600 TWD (æ¯æ—¥ç´ é£Ÿ)",
      },
      {
        item: "å¨›æ¨‚è²»",
        cost: 5000,
        note: "ç´„ $1,100 TWD (æµ·éŠé¤¨ã€ç©ºåº­æº«æ³‰)",
      },
    ];

    const recommendedRoutes = [
      {
        id: 1,
        day: "Day 1",
        name: "æ©Ÿå ´ â†’ Outlet",
        from: "Kansai International Airport",
        to: "Rinku Premium Outlets",
        desc: "æ¥é§å·´å£« (ç´„20åˆ†)",
      },
      {
        id: 2,
        day: "Day 2",
        name: "é›£æ³¢ â†’ VISON",
        from: "Osaka-Namba Station",
        to: "VISON Mie",
        desc: "è¿‘éµç‰¹æ€¥è‡³æ¾é˜ªè½‰å·´å£«",
      },
      {
        id: 3,
        day: "Day 4",
        name: "VISON â†’ ä¼Šå‹¢ç¥å®®",
        from: "VISON Mie",
        to: "Ise Jingu Naiku",
        desc: "å·´å£«è‡³æ¾é˜ªè½‰è¿‘éµ",
      },
      {
        id: 4,
        day: "Day 5",
        name: "ä¼Šå‹¢ â†’ è³¢å³¶",
        from: "Iseshi Station",
        to: "Kashikojima Station",
        desc: "è¿‘éµç‰¹æ€¥ (ç´„50åˆ†)",
      },
      {
        id: 5,
        day: "Day 6",
        name: "è³¢å³¶ â†’ å¤§é˜ªé›£æ³¢",
        from: "Kashikojima Station",
        to: "Osaka-Namba Station",
        desc: "Shimakaze è§€å…‰ç‰¹æ€¥",
      },
      {
        id: 6,
        day: "Day 10",
        name: "é›£æ³¢ â†’ é«˜é‡å±±",
        from: "Namba Station",
        to: "Koyasan",
        desc: "å—æµ·é«˜é‡ç·š (ç´„90åˆ†)",
      },
      {
        id: 7,
        day: "Day 11",
        name: "é›£æ³¢ â†’ è‡¨ç©ºåŸ",
        from: "Namba Station",
        to: "Rinku Town Station",
        desc: "å—æµ·é›»éµ",
      },
    ];

    const mapLocations = {
      regions: [
        {
          name: "ç¬¬ä¸€éšæ®µï¼šä¼Šå‹¢å¿—æ‘© (Day 1-6)",
          description: "KIXé€²å‡ºï¼Œç¶“é›£æ³¢å‰å¾€ä¼Šå‹¢å¿—æ‘©ï¼Œäº«å—VISONèˆ‡è³¢å³¶åº¦å‡ã€‚",
          routeLink: "https://www.google.com/maps/dir/Kansai+International+Airport/Rinku+Premium+Outlets/Osaka-Namba+Station/Matsusaka+Station/VISON,+Taki/Ise+Jingu+Naiku/Kashikojima+Station/Osaka-Namba+Station",
          spots: [
            { name: "é—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX)", query: "Kansai International Airport", type: "transport" },
            { name: "Rinku Town (Outlet)", query: "Rinku Premium Outlets", type: "shopping" },
            { name: "å¤§é˜ªé›£æ³¢ (è½‰ä¹˜é»)", query: "Osaka-Namba Station", type: "transport" },
            { name: "VISON (åº¦å‡åœ’å€)", query: "VISON Mie Japan", type: "attraction" },
            { name: "ä¼Šå‹¢ç¥å®® å…§å®®", query: "Ise Jingu Naiku", type: "attraction" },
            { name: "è³¢å³¶å¯¶ç”Ÿè‹‘", query: "Kashikojima Hojoen", type: "hotel" },
          ],
        },
        {
          name: "ç¬¬äºŒéšæ®µï¼šå¤§é˜ª & é«˜é‡å±± (Day 7-12)",
          description: "å¤§é˜ªå¸‚å€æ¼«éŠã€é«˜é‡å±±é›ªæ™¯ã€ä»¥åŠæœ€å¾Œçš„è‡¨ç©ºåŸæ¡è³¼ã€‚",
          routeLink: "https://www.google.com/maps/dir/Osaka-Namba+Station/Universal+Studios+Japan/Osaka+Aquarium+Kaiyukan/Koyasan/Rinku+Washington+Hotel/Kansai+International+Airport",
          spots: [
            { name: "USJ ç’°çƒå½±åŸ", query: "Universal Studios Japan", type: "attraction" },
            { name: "å¤§é˜ªæµ·éŠé¤¨", query: "Osaka Aquarium Kaiyukan", type: "attraction" },
            { name: "ç©ºåº­æº«æ³‰", query: "Solaniwa Onsen Osaka", type: "attraction" },
            { name: "é«˜é‡å±± (å£‡ä¸Šä¼½è—)", query: "Danjo Garan", type: "attraction" },
            { name: "Rinku Washington Hotel", query: "Kansai Airport Washington Hotel", type: "hotel" },
          ],
        },
      ],
    };

    // --- 2. è¼”åŠ©å‡½æ•¸ (Helper Functions) ---

    const cleanQuery = (text) => {
      let cleaned = text.replace(
        /[\u{1F600}-\u{1F6FF}|[\u{1F300}-\u{1F5FF}|[\u{1F680}-\u{1F6FF}|[\u{1F700}-\u{1F77F}|[\u{1F780}-\u{1F7FF}|[\u{1F800}-\u{1F8FF}|[\u{1F900}-\u{1F9FF}|[\u{1FA00}-\u{1FA6F}|[\u{1FA70}-\u{1FAFF}]/gu,
        "",
      );
      cleaned = cleaned.replace(
        /æ­ä¹˜|ç§»å‹•|å‰å¾€|æŠµé”|å…¥ä½|æ™šé¤|åˆé¤|åƒæ‹œ/g,
        "",
      );
      cleaned = cleaned.replace(/[ï¼š:()ï¼ˆï¼‰]/g, " ");
      return cleaned.trim();
    };

    const callGeminiAPI = async (prompt, systemContext = "") => {
      const apiKey = ""; // åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Key (å¦‚æœæœ‰)
      const model = "gemini-3.0-pro";

      const fullSystemInstruction = `
                You are a helpful, expert travel concierge for a vegetarian trip to Japan (Ise-Shima and Osaka).
                Current Itinerary Context: ${JSON.stringify(itineraryData)}
                User Style Guide & Strategy: ${JSON.stringify(strategyData)}
                Your persona: Friendly, polite, knowledgeable about vegetarian dining.
                Respond in Traditional Chinese (ç¹é«”ä¸­æ–‡).
                Specific Instruction: ${systemContext}
            `;

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              systemInstruction: { parts: [{ text: fullSystemInstruction }] },
            }),
          },
        );
        const data = await response.json();
        if (data.error) {
          console.error("Gemini Error:", data.error);
          return "æŠ±æ­‰ï¼ŒAI æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
        return (
          data.candidates?.[0]?.content?.parts?.[0]?.text ||
          "æŠ±æ­‰ï¼ŒAI ç›®å‰å¿™ç¢Œä¸­ã€‚"
        );
      } catch (error) {
        console.error("Fetch Error:", error);
        return "é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ã€‚";
      }
    };

    // --- 3. UI å…ƒä»¶ (Components) ---

    // 3.1 Header (Luxury Visual Update)
    const Header = () => (
      <header className="relative w-full py-32 px-6 text-white overflow-hidden">
        <a
          href="../../index.html?booted=true#booted"
          className="absolute top-6 left-6 z-50 p-3 bg-white/10 backdrop-blur-md rounded-full text-white hover:bg-white/20 transition-all border border-white/20 shadow-lg group"
          title="å›åˆ°é¦–é "
        >
          <ArrowRight
            size={24}
            className="rotate-180 group-hover:-translate-x-1 transition-transform"
          />
        </a>
        {/* Background Image & Overlay */}
        <div className="absolute inset-0 z-0 select-none">
          <img
            src="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop"
            alt="Japan Scenery"
            className="w-full h-full object-cover opacity-90 scale-105 animate-[float_20s_ease-in-out_infinite]"
          />
          <div className="absolute inset-0 bg-gradient-to-b from-primary/90 via-primary/60 to-surface/100"></div>
          <div className="absolute inset-0 bg-primary/40 mix-blend-overlay"></div>
        </div>

        <div className="max-w-5xl mx-auto text-center relative z-10">
          <div className="inline-block px-5 py-2 mb-6 rounded-full bg-primary/30 backdrop-blur-md text-sm font-bold tracking-wider border border-accent/40 text-accent/90 animate-fade-up shadow-lg">
            JP-ISE-OSA-2026-VEG-12D
          </div>
          <h1 className="font-display text-5xl md:text-7xl font-black mb-6 leading-tight tracking-tight animate-fade-up animate-fade-up-delay-1 drop-shadow-xl text-yellow-50">
            ä¼Šå‹¢å¿—æ‘©â€§å¤§é˜ª
            <span className="block text-2xl md:text-4xl mt-4 font-light tracking-[0.2em] font-body opacity-90">
              12æ—¥ç´ é£Ÿæ…¢æ—…
            </span>
          </h1>
          <p className="text-lg md:text-xl text-white/90 max-w-xl mx-auto animate-fade-up animate-fade-up-delay-2 font-medium drop-shadow-md">
            é«˜é‡å±±é›ªæ™¯ Â· VISON é€£ä½ Â· Shimakaze å¥¢è¯é«”é©—
          </p>
        </div>
      </header>
    );

    // 3.2 å¾å…±ç”¨å…ƒä»¶åº«å¼•å…¥ SectionCard
    const { SectionCard } = window.TripShared.components;


    // 3.3 StrategySection
    const StrategySection = () => (
      <div className="grid md:grid-cols-2 gap-6 mb-8">
        <SectionCard icon={Star} title="æ ¸å¿ƒç­–ç•¥">
          <p className="text-gray-600 text-lg leading-relaxed mb-4">
            {strategyData.content}
          </p>
          <div className="flex flex-wrap gap-2">
            <span className="text-white px-4 py-1.5 rounded-full text-sm font-medium bg-accent/90">
              å¤§é˜ª KIX é€²
            </span>
            <span className="text-white px-4 py-1.5 rounded-full text-sm font-medium bg-accent/90">
              é ç®—å‡ç´š
            </span>
            <span className="text-white px-4 py-1.5 rounded-full text-sm font-medium bg-accent/90">
              ç´ é£Ÿå‹å–„
            </span>
            <span className="text-white px-4 py-1.5 rounded-full text-sm font-medium bg-accent/90">
              å¤§çœ¾é‹è¼¸
            </span>
          </div>
        </SectionCard>

        <SectionCard icon={Train} title="äº¤é€šèˆ‡ä½å®¿">
          <div className="space-y-4">
            <div>
              <h3 className="font-bold text-gray-800 flex items-center gap-2 mb-2">
                <Train size={18} className="text-accent" /> å¥¢è¯ç§»å‹•
              </h3>
              <ul className="list-disc list-inside text-gray-600 pl-2 space-y-1">
                {strategyData.transport.map((item, idx) => (
                  <li key={idx}>{item}</li>
                ))}
              </ul>
            </div>
            <div>
              <h3 className="font-bold text-gray-800 flex items-center gap-2 mb-2">
                <Hotel size={18} className="text-accent" /> ä½å®¿å»ºè­°
              </h3>
              <ul className="list-disc list-inside text-gray-600 pl-2 space-y-1">
                {strategyData.accommodation.map((item, idx) => (
                  <li key={idx}>{item}</li>
                ))}
              </ul>
            </div>
          </div>
        </SectionCard>
      </div>
    );

    // 3.4 DayCard (Refined: Smart Fallback Logic Added)
    const DayCard = ({ dayData, onOpenRoute }) => (
      <div className="relative bg-white rounded-3xl shadow-md border border-gray-100 hover:shadow-lg transition-all duration-300 mb-6 flex flex-col h-full overflow-hidden group">
        {/* Image Banner */}
        <div className="h-48 w-full relative overflow-hidden">
          <img
            src={dayData.image}
            alt={dayData.title}
            className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
          />
          <div className="absolute inset-0 bg-gradient-to-t from-dark/80 to-transparent"></div>
          <div className="absolute bottom-4 left-6 text-white">
            <div className="text-sm font-bold opacity-90 mb-1 tracking-wider uppercase text-accent">
              {dayData.time}
            </div>
            <h3 className="text-2xl font-bold font-display leading-tight">
              {dayData.title}
            </h3>
          </div>
          <div className="absolute top-4 right-4">
            <span className="flex items-center justify-center w-12 h-12 rounded-xl bg-white/10 backdrop-blur-md text-white font-bold text-lg border border-white/20 shadow-lg">
              {typeof dayData.day === "number"
                ? `D${dayData.day}`
                : dayData.day}
            </span>
          </div>
        </div>

        <div className="p-6 flex-1 flex flex-col">
          <div className="space-y-6 mb-6 flex-1">
            {dayData.activities.map((act, idx) => {
              // Check for explicit map data OR arrow for fallback route detection
              const hasExplicitMap = !!act.map;
              const hasArrow = act.text.includes("â†’");
              const isRoute = hasExplicitMap
                ? act.map.type === "route"
                : hasArrow;

              return (
                <div key={idx} className="group/item">
                  <div className="flex items-start gap-4">
                    <span className="text-xs font-bold text-indigo-400 min-w-[3rem] pt-1.5 font-mono">
                      {act.time}
                    </span>

                    <div className="flex-1 min-w-0">
                      {/* Main Title Row */}
                      <div className="flex items-start justify-between gap-2">
                        <div className="text-gray-800 font-bold text-sm leading-relaxed">
                          {act.text}
                          {act.link && (
                            <a
                              href={act.link}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="ml-2 text-xs text-indigo-500 hover:text-indigo-700 underline font-normal"
                            >
                              æŸ¥æ™‚åˆ»è¡¨ â†—
                            </a>
                          )}
                        </div>

                        {(hasExplicitMap || hasArrow) && (
                          <button
                            onClick={() => {
                              if (hasExplicitMap) {
                                onOpenRoute({
                                  type: act.map.type || "spot",
                                  name: cleanQuery(act.text),
                                  ...act.map,
                                });
                              } else if (hasArrow) {
                                const parts = act.text.split("â†’");
                                const origin = cleanQuery(parts[0]);
                                const destination = cleanQuery(
                                  parts[parts.length - 1],
                                );
                                onOpenRoute({
                                  type: "route",
                                  name: cleanQuery(act.text),
                                  origin: origin,
                                  destination: destination,
                                });
                              }
                            }}
                            className={`
                                flex-shrink-0 opacity-0 group-hover/item:opacity-100 transition-all cursor-pointer
                                ${isRoute ? "text-accent" : "text-gray-400 hover:text-accent"}
                              `}
                            title={isRoute ? "æŸ¥çœ‹äº¤é€šè·¯ç·š" : "æŸ¥çœ‹åœ°é»"}
                          >
                            {isRoute ? <Train size={16} /> : <MapPin size={16} />}
                          </button>
                        )}
                      </div>

                      {/* Sub Text (Secondary Info) */}
                      {act.subText && (
                        <div className="text-xs text-gray-500 mt-0.5 font-medium">{act.subText}</div>
                      )}

                      {/* Tips / Warnings */}
                      {act.tips && (
                        <div className="mt-2 text-xs text-orange-700 bg-orange-50 border border-orange-100 px-3 py-1.5 rounded-lg inline-block leading-relaxed">
                          <span className="font-bold mr-1">âš ï¸</span> {act.tips}
                        </div>
                      )}

                      {/* Info Note */}
                      {act.note && (
                        <div className="mt-1 text-xs text-indigo-600/80 flex items-start gap-1 leading-relaxed">
                          <Info size={12} className="mt-0.5 shrink-0" /> {act.note}
                        </div>
                      )}

                      {/* Detailed Sub-Items (Tables/Lists) */}
                      {act.subItems && (
                        <div className="mt-3 bg-gray-50 rounded-xl border border-gray-100 overflow-hidden">
                          {act.subItems.map((sub, si) => (
                            <div key={si} className="flex flex-wrap items-baseline justify-between px-3 py-2 border-b border-gray-100 last:border-0 text-xs hover:bg-white transition-colors">
                              <span className="font-bold text-gray-700 mr-2">{sub.title}</span>
                              <span className="text-gray-500">{sub.content}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          <div className="mt-auto pt-6 border-t border-gray-50">
            <div className="flex items-start gap-3 p-3 rounded-xl bg-gradient-to-br from-white to-gray-50 border border-gray-100">
              <div className="p-2 bg-accent/10 text-accent rounded-lg shrink-0">
                <Sparkles size={16} />
              </div>
              <div>
                <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-0.5">HIGHLIGHT</div>
                <div className="text-sm font-medium text-gray-700 leading-relaxed">
                  {dayData.highlight}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );

    // 3.5 BudgetTable
    const BudgetTable = () => {
      const total = budgetData.reduce((acc, curr) => acc + curr.cost, 0);

      return (
        <SectionCard icon={Wallet} title="é ç®—æ¦‚ç®— (2äººåŒè¡Œï¼Œæ¯äººå¹³å‡)">
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-primary text-white">
                  <th className="p-4 font-semibold rounded-tl-lg font-display tracking-wider">
                    é …ç›®
                  </th>
                  <th className="p-4 font-semibold">é‡‘é¡ (JPY)</th>
                  <th className="p-4 font-semibold rounded-tr-lg">èªªæ˜</th>
                </tr>
              </thead>
              <tbody className="text-gray-600">
                {budgetData.map((row, idx) => (
                  <tr
                    key={idx}
                    className="border-b border-gray-100 hover:bg-accent/5 transition-colors"
                  >
                    <td className="p-4 font-medium text-primary font-display">
                      {row.item}
                    </td>
                    <td className="p-4 font-mono text-dark">
                      Â¥{row.cost.toLocaleString()}
                    </td>
                    <td className="p-4 text-sm text-subtle">{row.note}</td>
                  </tr>
                ))}
                <tr className="bg-gradient-to-r from-primary to-[#0A1A30] text-accent font-bold border-t-2 border-accent">
                  <td className="p-4 rounded-bl-lg">ç¸½è¨ˆ</td>
                  <td className="p-4 font-mono text-xl text-white">
                    Â¥{total.toLocaleString()}
                  </td>
                  <td className="p-4 rounded-br-lg text-white/80 font-normal">
                    é ç®—é‡é»ï¼šåƒå¾—å¥½ã€ä½å¾—å¥½ã€ç§»å‹•èˆ’é©
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </SectionCard>
      );
    };

    // 3.6 MapModal (Fixed: Header icon now depends on data.type)
    const MapModal = ({ isOpen, onClose, data }) => {
      if (!isOpen || !data) return null;

      let mapUrl = "";
      let externalMapUrl = "";
      // Use cleaned name from DayCard, or raw query as fallback
      let title = data.name || data.query;

      if (data.type === "route") {
        mapUrl = `https://maps.google.com/maps?saddr=${encodeURIComponent(
          data.origin,
        )}&daddr=${encodeURIComponent(data.destination)}&dirflg=r&output=embed`;
        externalMapUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(
          data.origin,
        )}&destination=${encodeURIComponent(data.destination)}&travelmode=transit`;
      } else {
        mapUrl = `https://maps.google.com/maps?q=${encodeURIComponent(
          data.query,
        )}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
        externalMapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
          data.query,
        )}`;
      }

      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
          <div className="bg-white w-full max-w-3xl h-[80vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden relative anim-slideUp-h1">
            <div className="bg-primary p-4 flex items-center justify-between text-white shrink-0">
              <div className="flex items-center gap-2 flex-1 min-w-0">
                {data.type === "route" ? (
                  <Train size={22} />
                ) : (
                  <MapPin size={22} />
                )}
                <h3 className="font-bold text-lg truncate">{title}</h3>
              </div>
              <button
                onClick={onClose}
                className="ml-4 w-10 h-10 flex items-center justify-center bg-white/20 hover:bg-white/40 rounded-full transition-colors text-2xl font-bold flex-shrink-0"
              >
                âœ•
              </button>
            </div>
            <div className="flex-1 bg-gray-100 relative">
              <iframe
                width="100%"
                height="100%"
                frameBorder="0"
                scrolling="no"
                marginHeight="0"
                marginWidth="0"
                src={mapUrl}
                title={title}
                className="w-full h-full"
              ></iframe>
            </div>
            <div className="p-4 bg-white border-t border-gray-100 flex justify-between items-center shrink-0">
              <span className="text-xs text-gray-400">
                * é è¦½åœ°åœ–å¯èƒ½å›  Google æ”¿ç­–å¶æœ‰è¼‰å…¥é™åˆ¶
              </span>
              <a
                href={externalMapUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-2 px-4 py-2 bg-primary/5 text-primary rounded-lg hover:bg-indigo-100 font-medium transition-colors text-sm"
              >
                åœ¨ Google Maps App é–‹å•Ÿ <ExternalLink size={14} />
              </a>
            </div>
          </div>
        </div>
      );
    };

    // 3.7 MapView
    const MapView = ({ onOpenMap }) => {
      return (
        <div className="space-y-8 animate-fade-in">
          <SectionCard icon={Navigation} title="è¡Œç¨‹å°èˆªè·¯ç·š">
            <div className="mb-6 bg-primary/5 border border-indigo-100 p-4 rounded-xl flex items-start gap-3">
              <Info className="text-primary shrink-0 mt-1" size={20} />
              <p className="text-indigo-800 text-sm leading-relaxed">
                åœ°åœ–åŠŸèƒ½å·²å‡ç´šï¼š
                <br />
                <span className="font-bold">ğŸ“ å–®é»æœå°‹</span>
                ï¼šé»æ“Šæ™¯é»åˆ—è¡¨ï¼ŒæŸ¥çœ‹å–®ä¸€ä½ç½®ã€‚
                <br />
                <span className="font-bold text-primary">
                  ğŸš— æ¯æ—¥ç§»å‹•è·¯å¾‘
                </span>
                ï¼šå·²åŒæ­¥æ•´åˆè‡³ã€Œæ¯æ—¥è©³æƒ…ã€åˆ†é ä¸­ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹ç¸½è¦½é—œéµè·¯å¾‘ã€‚
              </p>
            </div>

            <div className="mb-8">
              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <RouteIcon className="text-primary" size={20} />
                æ¯æ—¥é—œéµäº¤é€šç§»å‹•è·¯å¾‘ç¸½è¦½
              </h3>
              <div className="grid md:grid-cols-2 gap-4">
                {recommendedRoutes.map((route) => (
                  <button
                    key={route.id}
                    onClick={() =>
                      onOpenMap({
                        type: "route",
                        name: route.name,
                        origin: route.from,
                        destination: route.to,
                      })
                    }
                    className="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md hover:border-indigo-300 transition-all text-left flex items-start gap-3 group"
                  >
                    <div className="p-2 bg-primary/5 rounded-lg text-primary group-hover:bg-indigo-600 group-hover:text-white transition-colors shrink-0">
                      <div className="text-center">
                        <div className="text-[10px] font-bold uppercase leading-none mb-1">
                          {route.day.split(" ")[0]}
                        </div>
                        <div className="text-lg font-bold leading-none">
                          {route.day.split(" ")[1]}
                        </div>
                      </div>
                    </div>
                    <div>
                      <div className="font-bold text-gray-800 group-hover:text-indigo-700">
                        {route.name}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {route.desc}
                      </div>
                      <div className="text-xs text-gray-400 mt-1 flex items-center gap-1">
                        {route.from.split(" ")[0]} <ArrowRight size={10} />{" "}
                        {route.to.split(" ")[0]}
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-8">
              {mapLocations.regions.map((region, idx) => (
                <div
                  key={idx}
                  className="bg-white rounded-3xl shadow-md border border-gray-200 overflow-hidden flex flex-col"
                >
                  <div className="p-6 bg-primary/5 border-b border-indigo-100">
                    <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                      <MapPin className="text-primary" size={20} />
                      {region.name}
                    </h3>
                    <p className="text-sm text-gray-600 mb-4 h-10 line-clamp-2">
                      {region.description}
                    </p>
                    <a
                      href={region.routeLink}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="block w-full"
                    >
                      <div className="group bg-primary p-4 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex items-center justify-between">
                        <div className="text-white">
                          <span className="text-xs font-bold opacity-80 uppercase tracking-wider">
                            Complete Route
                          </span>
                          <div className="font-bold flex items-center gap-2">
                            é–‹å•Ÿæœ¬éšæ®µå®Œæ•´è·¯ç·š{" "}
                            <ExternalLink size={14} className="opacity-80" />
                          </div>
                        </div>
                        <div className="bg-white/20 p-2 rounded-full group-hover:bg-white/30 transition-colors">
                          <Navigation className="text-white" size={18} />
                        </div>
                      </div>
                    </a>
                  </div>
                  <div className="p-4 flex-1 flex flex-col gap-2">
                    <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 px-2">
                      Key Locations
                    </div>
                    {region.spots.map((spot, sIdx) => {
                      const iconMap = {
                        transport: Train,
                        shopping: Wallet,
                        attraction: Star,
                        food: Utensils,
                        hotel: Hotel,
                      };
                      const SpotIcon = iconMap[spot.type] || MapPin;
                      return (
                        <button
                          key={sIdx}
                          onClick={() =>
                            onOpenMap({
                              type: "spot",
                              name: spot.name,
                              query: spot.query,
                            })
                          }
                          className="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors group border border-transparent hover:border-gray-200 text-left"
                        >
                          <div className="flex items-center gap-3">
                            <div
                              className={`p-2 rounded-lg ${spot.type === "food"
                                ? "bg-green-50 text-green-600"
                                : "bg-gray-100 text-gray-500"
                                }`}
                            >
                              <SpotIcon size={16} />
                            </div>
                            <span className="text-gray-700 font-medium group-hover:text-primary transition-colors text-sm">
                              {spot.name}
                            </span>
                          </div>
                          <ExternalLink
                            size={14}
                            className="text-gray-300 group-hover:text-indigo-400"
                          />
                        </button>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </SectionCard>
        </div>
      );
    };

    // 3.8 AI & Translation Components
    const AIChatBubble = ({ sender, text }) => (
      <div
        className={`flex ${sender === "user" ? "justify-end" : "justify-start"
          } mb-4`}
      >
        <div
          className={`max-w-[80%] rounded-3xl p-4 text-sm leading-relaxed ${sender === "user"
            ? "bg-indigo-600 text-white rounded-br-none"
            : "bg-white border border-gray-100 text-gray-700 shadow-sm rounded-bl-none"
            }`}
        >
          {text}
        </div>
      </div>
    );

    const TranslatorButton = ({ label, prompt, onTranslate, isLoading }) => (
      <button
        onClick={() => onTranslate(prompt)}
        disabled={isLoading}
        className="w-full text-left p-3 rounded-xl border border-gray-200 hover:border-indigo-400 hover:bg-primary/5 transition-all duration-200 group flex items-center justify-between"
      >
        <span className="font-medium text-gray-700 group-hover:text-indigo-700">
          {label}
        </span>
        <Sparkles
          size={16}
          className="text-gray-300 group-hover:text-indigo-500"
        />
      </button>
    );

    const AIModal = ({ isOpen, onClose }) => {
      const [activeFeature, setActiveFeature] = useState("chat");
      const [chatHistory, setChatHistory] = useState([
        {
          sender: "ai",
          text: "å—¨ï¼æˆ‘æ˜¯æ‚¨çš„ç´ é£Ÿæ—…éŠ AI åŠ©æ‰‹ã€‚é—œæ–¼è¡Œç¨‹ã€ç´ é£Ÿé¤å»³æˆ–æ—¥æœ¬æ—…éŠçš„å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼âœ¨",
        },
      ]);
      const [inputText, setInputText] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [translationResult, setTranslationResult] = useState(null);
      const chatEndRef = useRef(null);

      useEffect(() => {
        if (chatEndRef.current) {
          chatEndRef.current.scrollIntoView({ behavior: "smooth" });
        }
      }, [chatHistory, activeFeature]);

      if (!isOpen) return null;

      const handleSendMessage = async () => {
        if (!inputText.trim()) return;

        const userMsg = inputText;
        setChatHistory((prev) => [
          ...prev,
          { sender: "user", text: userMsg },
        ]);
        setInputText("");
        setIsLoading(true);

        const response = await callGeminiAPI(userMsg);

        setChatHistory((prev) => [...prev, { sender: "ai", text: response }]);
        setIsLoading(false);
      };

      const handleTranslate = async (restriction) => {
        setIsLoading(true);
        setTranslationResult(null);
        const prompt = `
                    Please translate the following dietary restriction into natural, polite Japanese for a restaurant staff member.
                    Constraint: "${restriction}"
                    
                    Format the output exactly as:
                    Japanese: [Japanese text]
                    Pronunciation: [Romaji]
                    Meaning: [Brief explanation in Traditional Chinese]
                `;
        const response = await callGeminiAPI(
          prompt,
          "You are a translator. Keep formatting simple and clean.",
        );
        setTranslationResult(response);
        setIsLoading(false);
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
          <div className="bg-gray-50 w-full max-w-lg h-[600px] rounded-3xl shadow-2xl flex flex-col overflow-hidden relative anim-slideUp-h1">
            <div className="bg-primary p-4 flex items-center justify-between text-white shrink-0">
              <div className="flex items-center gap-2">
                <Bot size={24} className="text-indigo-200" />
                <h3 className="font-bold text-lg">AI æ—…éŠåŠ©æ‰‹</h3>
              </div>
              <button
                onClick={onClose}
                className="p-1 hover:bg-white/20 rounded-full transition-colors"
              >
                <X size={20} />
              </button>
            </div>

            <div className="flex p-2 bg-white border-b border-gray-100 gap-2 shrink-0">
              <button
                onClick={() => setActiveFeature("chat")}
                className={`flex-1 py-2 flex items-center justify-center gap-2 rounded-lg text-sm font-semibold transition-colors ${activeFeature === "chat"
                  ? "bg-indigo-100 text-indigo-700"
                  : "text-gray-500 hover:bg-gray-100"
                  }`}
              >
                <MessageCircle size={16} /> è¡Œç¨‹é¡§å•
              </button>
              <button
                onClick={() => setActiveFeature("translate")}
                className={`flex-1 py-2 flex items-center justify-center gap-2 rounded-lg text-sm font-semibold transition-colors ${activeFeature === "translate"
                  ? "bg-indigo-100 text-indigo-700"
                  : "text-gray-500 hover:bg-gray-100"
                  }`}
              >
                <Languages size={16} /> ç´ é£Ÿæºé€šå¡
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
              {activeFeature === "chat" && (
                <div className="flex flex-col min-h-full justify-end">
                  <div className="flex-1 pb-4">
                    {chatHistory.map((msg, idx) => (
                      <AIChatBubble
                        key={idx}
                        sender={msg.sender}
                        text={msg.text}
                      />
                    ))}
                    {isLoading && (
                      <div className="flex justify-start mb-4">
                        <div className="bg-white border border-gray-100 rounded-3xl p-4 text-gray-400 text-sm shadow-sm flex items-center gap-2">
                          <Sparkles
                            size={14}
                            className="animate-spin text-indigo-500"
                          />{" "}
                          AI æ€è€ƒä¸­...
                        </div>
                      </div>
                    )}
                    <div ref={chatEndRef} />
                  </div>
                </div>
              )}

              {activeFeature === "translate" && (
                <div className="space-y-4">
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-indigo-100">
                    <h4 className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                      <Leaf size={16} className="text-green-500" />{" "}
                      é¸æ“‡æ‚¨çš„é£²é£Ÿéœ€æ±‚
                    </h4>
                    <div className="grid grid-cols-1 gap-2">
                      <TranslatorButton
                        label="ğŸš« æˆ‘ä¸åƒè‚‰å’Œé­š (Meat/Fish Free)"
                        prompt="I do not eat meat or fish."
                        onTranslate={handleTranslate}
                        isLoading={isLoading}
                      />
                      <TranslatorButton
                        label="ğŸŸ æˆ‘ä¸èƒ½åƒæŸ´é­šé«˜æ¹¯ (No Dashi)"
                        prompt="I cannot eat dashi (fish stock). Please verify if the soup or sauce contains fish stock."
                        onTranslate={handleTranslate}
                        isLoading={isLoading}
                      />
                      <TranslatorButton
                        label="ğŸ§… æˆ‘ä¸åƒäº”è¾› (No Alliums)"
                        prompt="I do not eat onions, garlic, chives, leeks, or scallions. (Oriental Vegetarian)"
                        onTranslate={handleTranslate}
                        isLoading={isLoading}
                      />
                      <TranslatorButton
                        label="ğŸ¥šğŸ¥› æˆ‘ä¸åƒè›‹å¥¶ (Vegan)"
                        prompt="I am Vegan. I do not eat meat, fish, eggs, milk, or honey."
                        onTranslate={handleTranslate}
                        isLoading={isLoading}
                      />
                    </div>
                  </div>
                  {isLoading && !translationResult && (
                    <div className="text-center py-8 text-indigo-400 flex flex-col items-center gap-2">
                      <Sparkles className="animate-spin" />
                      <span className="text-sm">
                        Gemini-3.0-Pro æ­£åœ¨ç‚ºæ‚¨æ’°å¯«æ—¥æ–‡...
                      </span>
                    </div>
                  )}
                  {translationResult && (
                    <div className="bg-white border-2 border-indigo-500 rounded-xl p-5 shadow-md anim-slideUp-p">
                      <div className="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                        <span className="text-xs font-bold text-indigo-500 uppercase tracking-wider">
                          Show to Staff
                        </span>
                        <Sparkles size={14} className="text-yellow-500" />
                      </div>
                      <div className="whitespace-pre-wrap text-gray-800 leading-relaxed font-medium">
                        {translationResult}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>

            {activeFeature === "chat" && (
              <div className="p-4 bg-white border-t border-gray-100 shrink-0">
                <div className="flex items-center gap-2">
                  <input
                    type="text"
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyDown={(e) =>
                      e.key === "Enter" && handleSendMessage()
                    }
                    placeholder="è¼¸å…¥å•é¡Œï¼Œä¾‹å¦‚ï¼šé™„è¿‘æœ‰æ¨è–¦çš„é»å¿ƒå—ï¼Ÿ"
                    className="flex-1 px-4 py-2.5 bg-gray-100 border-none rounded-full focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                  />
                  <button
                    onClick={handleSendMessage}
                    disabled={isLoading}
                    className="p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 disabled:opacity-50 transition-colors shadow-md"
                  >
                    <Send size={18} />
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // --- 4. ä¸»ç¨‹å¼ (Main Application) ---

    const App = () => {
      const [activeTab, setActiveTab] = useState("itinerary");
      const [isAIModalOpen, setIsAIModalOpen] = useState(false);
      const [mapModalData, setMapModalData] = useState({
        isOpen: false,
        data: null,
      });

      const tabs = [
        { id: "overview", label: "è¡Œç¨‹ç¸½è¦½", icon: MapIcon },
        { id: "itinerary", label: "æ¯æ—¥è©³æƒ…", icon: Calendar },
        { id: "budget", label: "é ç®—è¦åŠƒ", icon: Wallet },
        { id: "map", label: "è¡Œç¨‹åœ°åœ–", icon: Navigation },
      ];

      const handleOpenMap = (data) => {
        setMapModalData({ isOpen: true, data });
      };

      return (
        <div className="min-h-screen bg-gray-50 font-sans selection:bg-indigo-200 selection:text-indigo-900 pb-24 md:pb-12">
          <Header />

          <div className="sticky top-0 z-40 glass shadow-sm border-b border-gray-100/50">
            <div className="max-w-5xl mx-auto px-4">
              <nav className="flex items-center justify-around gap-1 sm:gap-2 md:gap-8 py-3 md:py-4">
                {tabs.map((tab) => {
                  const isActive = activeTab === tab.id;
                  const TabIcon = tab.icon;
                  return (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`
                                                flex items-center justify-center gap-1 sm:gap-2 px-3 py-2 sm:px-4 sm:py-2.5 md:px-5 rounded-full font-medium transition-all duration-300 whitespace-nowrap text-xs sm:text-sm md:text-base
                                                ${isActive
                          ? "bg-primary text-white shadow-md transform scale-105"
                          : "bg-transparent text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                        }
                                            `}
                    >
                      <TabIcon size={18} className="flex-shrink-0" />
                      <span className="hidden sm:inline">{tab.label}</span>
                    </button>
                  );
                })}
              </nav>
            </div>
          </div>

          <main className="max-w-5xl mx-auto px-6 py-8">
            {activeTab === "overview" && (
              <div className="animate-fade-in space-y-8">
                <StrategySection />

                <div className="grid md:grid-cols-2 gap-8">
                  {itineraryData.map((phase, idx) => (
                    <div
                      key={idx}
                      className="bg-white rounded-3xl p-6 shadow-md border-t-4 border-indigo-500"
                    >
                      <h3 className="text-xl font-bold text-gray-800 mb-4 pb-2 border-b border-gray-100">
                        {phase.phase}
                      </h3>
                      <div className="space-y-4">
                        {phase.days.map((day, dIdx) => (
                          <div key={dIdx} className="flex items-start gap-3">
                            <div className="min-w-[3rem] text-sm font-bold text-indigo-500 bg-primary/5 px-2 py-1 rounded text-center">
                              D{day.day}
                            </div>
                            <div className="text-gray-700 text-sm font-medium pt-1">
                              {day.title}
                            </div>
                          </div>
                        ))}
                      </div>
                      <button
                        onClick={() => setActiveTab("itinerary")}
                        className="mt-6 w-full py-2 flex items-center justify-center gap-2 text-primary font-semibold text-sm hover:bg-primary/5 rounded-lg transition-colors"
                      >
                        æŸ¥çœ‹è©³æƒ… <ArrowRight size={16} />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {activeTab === "itinerary" && (
              <div className="space-y-12">
                {itineraryData.map((phase, idx) => (
                  <div key={idx} className="relative">
                    <div className="sticky top-20 z-30 bg-gray-50/95 backdrop-blur py-4 mb-4">
                      <h2 className="text-2xl font-bold text-gray-800 pl-4 border-l-4 border-purple-500">
                        {phase.phase}
                      </h2>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {phase.days.map((day, dIdx) => (
                        <DayCard
                          key={dIdx}
                          dayData={day}
                          onOpenRoute={handleOpenMap}
                        />
                      ))}
                    </div>
                  </div>
                ))}

                <div className="flex justify-center mt-12">
                  <button
                    onClick={() =>
                      window.scrollTo({ top: 0, behavior: "smooth" })
                    }
                    className="px-5 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
                  >
                    å›åˆ°é ‚éƒ¨
                  </button>
                </div>
              </div>
            )}

            {activeTab === "budget" && (
              <div className="max-w-3xl mx-auto">
                <BudgetTable />
                <div className="mt-8 p-6 bg-primary/5 rounded-3xl flex gap-4 items-start">
                  <Info className="text-primary flex-shrink-0 mt-1" />
                  <div className="text-sm text-indigo-800 leading-relaxed">
                    <p className="font-bold mb-1">é—œæ–¼åŒ¯ç‡èˆ‡é è¨‚</p>
                    å»ºè­°æå‰ 3-6 å€‹æœˆé–‹å§‹é è¨‚ä½å®¿ä»¥ç¢ºä¿æ—©é³¥å„ªæƒ ã€‚Shimakaze
                    è§€å…‰ç‰¹æ€¥éœ€åœ¨ä¹˜è»Šæ—¥å‰ä¸€å€‹æœˆä¸Šåˆ 10:30 æº–æ™‚æ¶ç¥¨ã€‚
                  </div>
                </div>
              </div>
            )}

            {activeTab === "map" && <MapView onOpenMap={handleOpenMap} />}
          </main>

          <button
            onClick={() => setIsAIModalOpen(true)}
            className="fixed bottom-6 right-6 z-50 p-4 rounded-full bg-primary text-white shadow-2xl hover:scale-110 hover:shadow-indigo-500/50 transition-all duration-300 group"
          >
            <Sparkles size={28} className="animate-pulse" />
            <span className="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-gray-900 text-white text-xs font-bold py-1 px-3 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
              âœ¨ AI æ—…éŠé¡§å•
            </span>
          </button>

          <AIModal
            isOpen={isAIModalOpen}
            onClose={() => setIsAIModalOpen(false)}
          />
          <MapModal
            isOpen={mapModalData.isOpen}
            onClose={() =>
              setMapModalData({ ...mapModalData, isOpen: false })
            }
            data={mapModalData.data}
          />

          <footer className="text-center py-8 text-gray-400 text-sm">
            <p>Â© 2026 ä¼Šå‹¢å¿—æ‘©â€§å¤§é˜ªç´ é£Ÿè±ªè¯æ…¢æ—… v6 (KIX é€²å‡ºç‰ˆ)</p>
          </footer>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>

</html>