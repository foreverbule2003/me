<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CB Analytics Engine | Me Tools</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>

    <!-- Firebase SDK (Compatibility Mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
      :root {
        --brand-slate: #0f172a;
        --brand-indigo: #4f46e5;
        --market-up: #ef4444;
        --market-down: #22c55e;
        --bg-main: #f8fafc;
      }

      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        background-color: var(--bg-main);
      }

      .mono {
        font-family: "JetBrains Mono", monospace;
      }

      .premium-card {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.05),
          0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }

      .input-premium:focus {
        outline: none;
        border-color: var(--brand-indigo);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      }

      /* 輸入欄位弱化/高亮狀態 */
      .inputs-dimmed {
        opacity: 0.5;
        transition: opacity 0.3s ease;
      }
      .inputs-highlighted {
        opacity: 1;
        animation: highlightPulse 0.4s ease-out;
      }
      @keyframes highlightPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 20px rgba(79, 70, 229, 0.15);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Chart Loading Overlay */
      .chart-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(2px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 0.75rem;
        transition: opacity 0.3s ease;
      }
      .chart-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      /* Autocomplete Dropdown */
      .autocomplete-container {
        position: relative;
      }
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 250px;
        overflow-y: auto;
        background: white;
        border: 1px solid #e2e8f0;
        border-top: none;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 50;
        display: none;
      }
      .autocomplete-dropdown.show {
        display: block;
      }
      .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.15s ease;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-item:hover,
      .autocomplete-item.active {
        background-color: #ecfdf5;
      }
      .autocomplete-item .symbol {
        font-weight: 700;
        color: #10b981;
        font-family: monospace;
      }
      .autocomplete-item .hint {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-left: auto;
      }
      .autocomplete-empty {
        padding: 1rem;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
      }

      .gradient-card {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }
      .input-focus:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      }
      .metric-card {
        transition: all 0.3s ease;
      }
      .metric-card:hover {
        transform: translateY(-2px);
      }
      /* 輸入欄位弱化/高亮狀態 */
      .inputs-dimmed {
        opacity: 0.5;
        transition: opacity 0.3s ease;
      }
      .inputs-highlighted {
        opacity: 1;
        animation: highlightPulse 0.6s ease-out;
      }
      @keyframes highlightPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.01);
          box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        100% {
          transform: scale(1);
        }
      }
      /* 方案 A: 折疊式展開動畫 */
      .inputs-collapsed {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition:
          max-height 0.4s ease-out,
          opacity 0.3s ease-out;
      }
      .inputs-expanded {
        max-height: 2000px;
        opacity: 1;
        transition:
          max-height 0.4s ease-in,
          opacity 0.3s ease-in 0.1s;
      }

      /* Chart Loading Overlay */
      .chart-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(2px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 0.75rem;
        transition: opacity 0.3s ease;
      }
      .chart-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      /* Pulse Animation */
      .pulse-ring {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #10b981;
        position: relative;
        animation: pulse-ring 2s infinite;
      }
      .pulse-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      @keyframes pulse-ring {
        0% {
          transform: scale(0.8);
          opacity: 0.8;
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        70% {
          transform: scale(1);
          opacity: 0;
          box-shadow: 0 0 0 20px rgba(16, 185, 129, 0);
        }
        100% {
          transform: scale(0.8);
          opacity: 0;
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
      }

      /* Autocomplete Dropdown */
      .autocomplete-container {
        position: relative;
      }
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 0.75rem 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 50;
        display: none;
      }
      .autocomplete-dropdown.show {
        display: block;
      }
      .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.15s ease;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-item:hover,
      .autocomplete-item.active {
        background-color: #ecfdf5;
      }
      .autocomplete-item .symbol {
        font-weight: 700;
        color: #10b981;
        font-family: monospace;
      }
      .autocomplete-item .hint {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-left: auto;
      }
      .autocomplete-empty {
        padding: 1rem;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body class="min-h-screen text-slate-900">
    <div class="max-w-[1200px] mx-auto p-4 md:p-8">
      <!-- Top Action Bar -->
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <a
            href="../cb-war-room.html"
            class="flex items-center gap-2 text-slate-600 hover:text-slate-900 font-bold text-sm"
          >
            <i class="fas fa-arrow-left"></i><span>戰情室</span>
          </a>
          <div class="h-4 w-[1px] bg-slate-200"></div>
          <div class="flex items-center gap-2">
            <span class="status-pill market-open">
              <i class="fas fa-microchip text-[10px]"></i>
              數據引擎 v2.0
            </span>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button
            onclick="window.open('mock-cb-calculator-full.html', '_blank')"
            class="px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 text-[10px] font-black border border-indigo-100 hover:bg-indigo-100 transition-colors flex items-center gap-1"
          >
            <i class="fas fa-palette"></i> V2 PREVIEW
          </button>
          <a
            href="../../index.html?booted=true"
            class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-all border border-transparent hover:border-slate-200"
          >
            <i class="fas fa-house-chimney text-sm"></i>
          </a>
        </div>
      </div>

      <!-- Professional Header -->
      <div class="mb-10 text-center md:text-left">
        <h1
          class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-3"
        >
          <i class="fas fa-calculator text-indigo-500"></i>
          CB 可轉債計算機
        </h1>
        <p class="text-slate-500 text-sm mt-1 font-medium">
          精密計算溢價率、轉換價值與損益平衡點
        </p>
      </div>

      <!-- High-End Info Card -->
      <div
        class="mb-10 p-6 bg-slate-50 rounded-2xl border border-slate-200 flex flex-col md:flex-row items-start gap-4 shadow-sm relative overflow-hidden"
      >
        <!-- Background decoration -->
        <div
          class="absolute top-0 right-0 p-4 opacity-5 blur-[2px] pointer-events-none text-slate-400"
        >
          <i class="fas fa-brain text-7xl"></i>
        </div>

        <div class="flex items-start gap-4 relative z-10 w-full">
          <div
            class="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 shrink-0"
          >
            <i class="fas fa-terminal"></i>
          </div>
          <div>
            <h3 class="font-bold text-slate-800 mb-1">
              關於轉換溢價率 (Conversion Premium)
            </h3>
            <p class="text-xs leading-loose text-slate-500 font-medium">
              表示 CB 市場價格相對於其「轉換為股票價值」的超額比例。
              <span class="text-indigo-600 font-bold bg-indigo-50 px-1 rounded"
                >溢價率趨近 0% 或為負</span
              >
              時，CB 價格將與底層股價高度連動。
            </p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
        <!-- Input Panel -->
        <div class="lg:col-span-5 bg-white p-5 md:p-6 rounded-2xl premium-card">
          <h2
            class="text-sm font-bold text-slate-400 mb-6 flex items-center gap-2"
          >
            <i class="fas fa-sliders-h text-indigo-500"></i>
            輸入參數
          </h2>

          <!-- Search Area Integrated -->
          <div class="mb-8">
            <label class="block text-[11px] font-bold text-slate-400 mb-2 ml-1"
              >標的搜尋</label
            >
            <div class="autocomplete-container" id="searchContainer">
              <div class="relative">
                <input
                  type="text"
                  id="stockSearch"
                  placeholder="輸入代號或名稱 (例: 2330)"
                  autocomplete="off"
                  spellcheck="false"
                  class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none mono font-bold"
                />
                <i
                  class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"
                ></i>
                <div
                  id="searchLoader"
                  class="hidden absolute right-4 top-1/2 -translate-y-1/2"
                >
                  <i class="fas fa-circle-notch fa-spin text-indigo-400"></i>
                </div>
              </div>
              <div id="searchDropdown" class="autocomplete-dropdown"></div>
              <!-- Hidden elements for JS compatibility -->
              <input type="hidden" id="tickerSymbol" />
              <button id="searchBtn" class="hidden"></button>
            </div>
          </div>

          <!-- Stock/CB Name Display -->
          <div
            id="stockNameDisplay"
            class="hidden mb-6 p-4 bg-indigo-50/50 rounded-xl border border-indigo-100"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center text-white text-xs font-bold shadow-sm shadow-indigo-200"
              >
                <i class="fas fa-tag"></i>
              </div>
              <span
                id="stockNameText"
                class="font-black text-slate-800 text-lg tracking-tight"
              ></span>
              <span
                id="stockCodeBadge"
                class="ml-auto px-2 py-1 bg-white border border-slate-200 text-slate-500 text-[10px] rounded-md mono font-black"
              ></span>
            </div>
            <!-- 時間戳記行 -->
            <div
              class="flex items-center gap-3 mt-3 pt-3 border-t border-indigo-100/50 text-[10px] text-slate-400 font-bold uppercase"
            >
              <div class="flex items-center gap-1.5">
                <i class="far fa-clock"></i>
                <span id="dataTimestamp"></span>
              </div>
              <div class="flex items-center gap-1.5">
                <i class="fas fa-database text-slate-300"></i>
                <span id="dataSourceBadge" class="rounded"></span>
              </div>
            </div>
          </div>

          <!-- Analytics Navigation -->
          <div class="mb-8">
            <a
              href="../cb-war-room.html"
              class="flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-xl hover:border-indigo-200 hover:bg-indigo-50/30 transition-all group no-underline"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center text-red-500"
                >
                  <i class="fas fa-fire text-sm group-hover:animate-pulse"></i>
                </div>
                <div>
                  <div
                    class="text-[11px] font-bold text-slate-400 tracking-tighter"
                  >
                    市場熱門 (戰情室)
                  </div>
                  <div class="text-sm font-bold text-slate-700">
                    查看今日熱門榜單
                  </div>
                </div>
              </div>
              <i
                class="fas fa-chevron-right text-slate-300 group-hover:translate-x-1 transition-transform"
              ></i>
            </a>
          </div>

          <!-- Ticker Status (Added back for compatibility) -->
          <div class="relative">
            <span
              id="tickerStatus"
              class="hidden absolute left-0 -top-6 text-xs font-bold text-slate-400"
            ></span>
          </div>

          <hr class="border-slate-100 mb-8" />

          <div id="inputFieldsContainer" class="space-y-6">
            <!-- Parameters Section -->
            <div class="flex items-center justify-between px-1">
              <span
                id="manualInputBtn"
                class="text-[11px] font-bold text-slate-400 tracking-widest cursor-pointer hover:text-indigo-500 transition-colors"
                >手動調整參數</span
              >
              <i class="fas fa-keyboard text-slate-200"></i>
            </div>
            <!-- CB Price -->
            <div class="group">
              <div class="flex items-center justify-between mb-2 px-1">
                <label
                  class="text-[11px] font-bold text-slate-400 group-hover:text-slate-600 transition-colors uppercase tracking-tight"
                  >可轉債價格</label
                >
                <!-- Integrated Moneyness Badge -->
                <span
                  id="itmBadge"
                  class="hidden px-1.5 py-0.5 rounded text-[9px] font-black bg-emerald-50 text-emerald-600 border border-emerald-100 flex items-center gap-1"
                >
                  價內 --%
                </span>
              </div>
              <div class="relative">
                <input
                  type="number"
                  id="cbPrice"
                  value="125.00"
                  step="0.01"
                  class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none mono font-bold text-slate-700 text-lg"
                  placeholder="125.00"
                />
              </div>
            </div>

            <!-- Stock Price -->
            <div class="group">
              <label
                class="block text-[11px] font-bold text-slate-400 mb-2 ml-1 uppercase tracking-tight"
                >標的股價</label
              >
              <div class="relative">
                <input
                  type="number"
                  id="stockPrice"
                  value="255.00"
                  step="0.01"
                  class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none mono font-bold text-slate-700 text-lg"
                  placeholder="255.00"
                />
              </div>
            </div>

            <!-- Conversion Price -->
            <div class="group">
              <label
                class="block text-[11px] font-bold text-slate-400 mb-2 ml-1 uppercase tracking-tight"
                >轉換價</label
              >
              <div class="relative">
                <input
                  type="number"
                  id="conversionPrice"
                  value="246.60"
                  step="0.01"
                  class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none mono font-bold text-slate-700 text-lg"
                  placeholder="246.60"
                />
              </div>
            </div>

            <!-- Conversion Price -->
            <!-- Note: Removed redundant items for space consistency -->
          </div>
          <!-- 結束 inputFieldsContainer -->
        </div>

        <!-- Results Panel -->
        <div
          id="resultsContainer"
          class="lg:col-span-7 flex flex-col justify-between space-y-6 lg:space-y-0 lg:gap-6"
        >
          <!-- Main Result: Unified Valuation Dashboard -->
          <div
            class="premium-card p-0 rounded-2xl border-l-4 border-slate-200 transition-colors duration-300 shadow-sm overflow-hidden"
            id="premiumCard"
          >
            <!-- Top Section: Premium Rate -->
            <div class="p-6 pb-4">
              <div class="flex justify-between items-center mb-1">
                <h3
                  class="text-[10px] font-black text-slate-400 uppercase tracking-widest opacity-80"
                >
                  轉換溢價率
                </h3>
                <span
                  class="px-1.5 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter bg-slate-100 text-slate-400 border border-slate-100/50"
                  id="premiumStatus"
                  >計算中</span
                >
              </div>
              <div class="flex items-baseline gap-2 mb-2">
                <span
                  class="text-3xl font-black text-slate-800 tracking-tighter mono"
                  id="premiumRate"
                  >--%</span
                >
              </div>
              <p
                class="text-[10px] font-bold text-slate-400 opacity-60 leading-none"
                id="premiumDesc"
              >
                暫無數據。請輸入標的進行運算。
              </p>
            </div>

            <!-- Divider -->
            <div class="h-px bg-slate-100 mx-6"></div>

            <!-- Bottom Section: Metrics Grid -->
            <div
              class="grid grid-cols-2 gap-px bg-slate-100 border-t border-slate-100"
            >
              <!-- Conversion Value -->
              <div
                class="bg-white/60 p-5 group hover:bg-white transition-colors"
              >
                <div
                  class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center justify-between"
                >
                  <span>轉換價值</span>
                  <div
                    class="w-5 h-5 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:text-indigo-400 transition-colors"
                  >
                    <i class="fas fa-coins text-[10px]"></i>
                  </div>
                </div>
                <div
                  class="text-2xl font-black text-slate-800 mono tracking-tight mb-1"
                  id="conversionValue"
                >
                  --
                </div>
                <div
                  class="text-[10px] font-bold text-slate-400 flex items-center gap-1.5"
                >
                  <i class="fas fa-layer-group text-[9px] opacity-70"></i>
                  <span id="sharesInfo" class="mono">-- 股/張</span>
                </div>
              </div>

              <!-- Parity (Upside) -->
              <div
                class="bg-white/60 p-5 group hover:bg-white transition-colors relative"
              >
                <div
                  class="absolute left-0 top-4 bottom-4 w-px bg-slate-100/50"
                ></div>
                <div
                  class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center justify-between"
                >
                  <span>需上漲 (BE)</span>
                  <div
                    class="w-5 h-5 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:text-amber-500 transition-colors"
                  >
                    <i class="fas fa-bullseye text-[10px]"></i>
                  </div>
                </div>
                <div
                  class="text-2xl font-black text-slate-800 mono tracking-tight mb-1"
                  id="parityPrice"
                >
                  --
                </div>
                <div
                  class="text-[10px] font-bold text-slate-400 flex items-center gap-1.5"
                  id="upsideBox"
                >
                  <i class="fas fa-chart-line text-[9px] opacity-70"></i>
                  <span id="upsideNeeded" class="mono">需上漲 --%</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Note: Redundant Moneyness Card Removed as it is now integrated -->

        <!-- System Status Bar (Hidden by default, used for Idle) -->
        <div
          id="statusBar"
          class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex items-center gap-4"
        >
          <div
            class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-sm shrink-0 transition-all duration-300"
            id="statusIconBg"
          >
            <i class="fas fa-minus text-slate-400" id="statusIcon"></i>
          </div>
          <div>
            <h4
              class="text-xs font-black text-slate-700 uppercase tracking-wider leading-none"
              id="statusTitle"
            >
              系統閒置中
            </h4>
            <p
              class="text-[10px] font-bold text-slate-400 mt-1"
              id="statusDesc"
            >
              待機中：等待輸入數據
            </p>
          </div>
        </div>

        <!-- Premium Rate Trend Chart -->
        <div
          id="chartContainer"
          class="premium-card p-6 rounded-2xl relative min-h-[300px]"
        >
          <div class="flex items-center justify-between mb-6">
            <h4
              class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"
            >
              <i class="fas fa-history text-indigo-400"></i>
              歷史溢價走勢
            </h4>
            <div class="flex items-center gap-3">
              <div
                class="flex bg-slate-100 p-1 rounded-lg"
                id="chartRangeButtons"
              >
                <button
                  class="range-btn text-[10px] font-black px-2.5 py-1 rounded-md transition-all hover:bg-white text-slate-400"
                  data-range="1m"
                >
                  1M
                </button>
                <button
                  class="range-btn text-[10px] font-black px-2.5 py-1 rounded-md transition-all ml-1 hover:bg-white text-slate-400"
                  data-range="3m"
                >
                  3M
                </button>
                <button
                  class="range-btn text-[10px] font-black px-2.5 py-1 rounded-md transition-all ml-1 bg-white shadow-sm text-indigo-600"
                  data-range="all"
                >
                  MAX
                </button>
              </div>
              <button
                id="resetZoomBtn"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 bg-slate-50 rounded-lg border border-slate-100 transition-colors"
                title="重置"
              >
                <i class="fas fa-compress-arrows-alt"></i>
              </button>
              <span class="text-xs text-gray-400" id="chartDataInfo"
                >-- 筆資料</span
              >
            </div>
          </div>
          <div class="relative" style="height: 200px">
            <!-- Loading Overlay (Targeted) -->
            <div
              id="chartLoader"
              class="chart-overlay hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-[2px] rounded-lg"
            >
              <div class="pulse-ring mb-2">
                <div class="pulse-dot"></div>
              </div>
              <h5
                id="chartLoaderTitle"
                class="font-bold text-gray-700 text-sm mb-0.5"
              >
                正在搜尋歷史資料...
              </h5>
              <p id="chartLoaderDesc" class="text-[10px] text-gray-500">
                正在連接櫃買中心資料庫
              </p>
            </div>
            <canvas id="premiumChart"></canvas>
          </div>
          <p
            id="chartNoData"
            class="text-center text-gray-400 text-sm py-8 hidden"
          >
            <i class="fas fa-database mr-2"></i
            >尚無歷史資料，每次搜尋將累積一筆紀錄
          </p>
        </div>

        <!-- Formula Reference -->
        <div
          class="bg-white p-5 rounded-xl text-xs text-gray-400 border border-gray-100"
        >
          <h4 class="font-bold text-gray-600 mb-2">計算公式</h4>
          <ul class="space-y-1 list-disc pl-4">
            <li>
              <span class="font-medium text-gray-500">可轉換股數</span> =
              100,000 ÷ 轉換價格
            </li>
            <li>
              <span class="font-medium text-gray-500">轉換價值</span> =
              可轉換股數 × 股價 ÷ 1000
            </li>
            <li>
              <span class="font-medium text-gray-500">轉換溢價率</span> =
              (CB價格 - 轉換價值) ÷ 轉換價值 × 100%
            </li>
            <li>
              <span class="font-medium text-gray-500">轉換平價</span> = 轉換價格
              × CB價格 ÷ 100
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Modal Removed -->

    <script type="module">
      import { CbCalculatorCore } from "../components/CbCalculatorCore.mjs";
      // Expose for debugging
      window.CbCalculatorCore = CbCalculatorCore;

      const inputs = {
        tickerSymbol: document.getElementById("tickerSymbol"),
        cbPrice: document.getElementById("cbPrice"),
        stockPrice: document.getElementById("stockPrice"),
        conversionPrice: document.getElementById("conversionPrice"),
      };

      // Helper for data paths
      const getDataPath = (path) => {
        const base = window.location.pathname.startsWith("/me/") ? "/me" : "";
        return `${base}/data/${path}`;
      };

      // onMount: Check URL Params
      window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const autoSearch = params.get("autoSearch");

        if (code) {
          const searchInput = document.getElementById("stockSearch");
          if (searchInput) searchInput.value = code;
          inputs.tickerSymbol.value = code;

          // Proactively expand UI if code exists
          expandInputFields();

          if (autoSearch === "true") {
            // Trigger Search automatically
            setTimeout(() => {
              handleSearch({ preventDefault: () => {} });
            }, 300);
          }
        }
      });

      const searchBtn = document.getElementById("searchBtn");
      const tickerStatus = document.getElementById("tickerStatus");
      const manualInputBtn = document.getElementById("manualInputBtn");
      const inputFieldsContainer = document.getElementById(
        "inputFieldsContainer",
      );
      const resultsContainer = document.getElementById("resultsContainer");

      // 展開輸入欄位與結果區塊
      function expandInputFields() {
        inputFieldsContainer.classList.remove(
          "inputs-collapsed",
          "inputs-dimmed",
        );
        inputFieldsContainer.classList.add("inputs-expanded");
        resultsContainer.classList.remove("inputs-collapsed");
        resultsContainer.classList.add("inputs-expanded");
        manualInputBtn.classList.add("hidden");
      }

      // 手動輸入按鈕事件
      manualInputBtn.addEventListener("click", () => {
        expandInputFields();
        // 清除預設值讓用戶可以輸入
        inputs.cbPrice.value = "";
        inputs.stockPrice.value = "";
        inputs.conversionPrice.value = "";
        inputs.cbPrice.focus();
      });

      // Load Database from JSON
      let cbDatabase = {};

      // 即時行情快取（5 秒 TTL）
      const priceCache = {};

      // ============== 溢價率歷史紀錄 (LocalStorage) ==============
      const HISTORY_KEY_PREFIX = "cb_premium_history_";
      const MAX_HISTORY_DAYS = 30;
      let premiumChart = null; // Chart.js 實例

      // ============== Firebase 初始化 (v9 Compat) ==============
      const firebaseConfig = {
        apiKey: "AIzaSyB4VXQaa_bWldNrXfSARgK3w258fac9Fvg",
        authDomain: "my-landing-page-2ca68.firebaseapp.com",
        projectId: "my-landing-page-2ca68",
        storageBucket: "my-landing-page-2ca68.firebasestorage.app",
        messagingSenderId: "847051837050",
        appId: "1:847051837050:web:c5e2bc56252e0d3ab835c3",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Global state
      window.attemptedCrawls = new Set();
      let currentUser = null;

      auth.onAuthStateChanged((user) => {
        currentUser = user;
        console.log(
          `[Auth] Mode: ${user ? "Authenticated (" + user.email + ")" : "Anonymous (Read-Only)"}`,
        );
      });

      // Helper for measureFetch (Shared with War Room)
      window.measureFetch = async (url, options = {}) => {
        const start = performance.now();
        try {
          const res = await fetch(url, options);
          return res;
        } finally {
          const duration = performance.now() - start;
          if (duration > 3000)
            console.warn(
              `[Perf] Slow fetch: ${url} (${duration.toFixed(0)}ms)`,
            );
        }
      };

      // ============== Autocomplete & Search 功能 ==============
      let availableSymbols = [];

      async function fetchAvailableSymbols() {
        try {
          const snapshot = await db.collection("cb_history").get();
          availableSymbols = snapshot.docs.map((doc) => ({
            symbol: doc.id,
            name: doc.data().name || "",
          }));
          console.log(
            "[Autocomplete] Loaded",
            availableSymbols.length,
            "symbols",
          );
        } catch (e) {
          console.warn("[Autocomplete] Failed to load symbols:", e);
          availableSymbols = [];
        }
      }

      function renderAutocomplete(filter = "") {
        const dropdown = document.getElementById("searchDropdown");
        const filterUpper = filter.toUpperCase().trim();

        const matches = filterUpper
          ? availableSymbols.filter(
              (s) =>
                s.symbol.includes(filterUpper) ||
                (s.name && s.name.toUpperCase().includes(filterUpper)),
            )
          : availableSymbols;

        if (matches.length === 0 && filterUpper) {
          dropdown.innerHTML =
            '<div class="autocomplete-empty italic text-slate-400">NO MATCH FOUND</div>';
        } else if (matches.length === 0) {
          dropdown.innerHTML =
            '<div class="autocomplete-empty text-slate-400">LOADING DATA...</div>';
        } else {
          dropdown.innerHTML = matches
            .slice(0, 8)
            .map(
              (item) => `
                  <div class="autocomplete-item px-4 py-3 hover:bg-slate-50 cursor-pointer flex items-center justify-between border-b border-slate-50 last:border-none group" data-symbol="${item.symbol}">
                      <div class="flex flex-col">
                        <span class="mono font-black text-indigo-600">${item.symbol}</span>
                        <span class="text-[10px] font-bold text-slate-400">${item.name || "Unknown"}</span>
                      </div>
                      <i class="fas fa-chevron-right text-[10px] text-slate-200 group-hover:text-indigo-400 transition-colors"></i>
                  </div>
              `,
            )
            .join("");
        }
      }

      function showAutocomplete() {
        const dropdown = document.getElementById("searchDropdown");
        dropdown.style.display = "block";
        renderAutocomplete(document.getElementById("stockSearch").value);
      }

      function hideAutocomplete() {
        const dropdown = document.getElementById("searchDropdown");
        dropdown.style.display = "none";
      }

      function initAutocomplete() {
        const input = document.getElementById("stockSearch");
        const dropdown = document.getElementById("searchDropdown");

        input.addEventListener("focus", () => {
          if (availableSymbols.length > 0) showAutocomplete();
        });

        input.addEventListener("input", (e) => {
          // Sync to hidden input for compatibility
          const hiddenInput = document.getElementById("tickerSymbol");
          if (hiddenInput) hiddenInput.value = e.target.value;

          if (availableSymbols.length > 0) {
            showAutocomplete();
            renderAutocomplete(e.target.value);
          }
        });

        // Allow Enter key to trigger search directly
        input.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            hideAutocomplete();
            handleUnifiedSearch(input.value);
          }
        });

        input.addEventListener("blur", () => {
          setTimeout(hideAutocomplete, 200);
        });

        dropdown.addEventListener("click", (e) => {
          const item = e.target.closest(".autocomplete-item");
          if (item) {
            const symbol = item.dataset.symbol;
            input.value = symbol;
            hideAutocomplete();
            handleUnifiedSearch(symbol);
          }
        });
      }

      // 統一搜尋處理函數
      async function handleUnifiedSearch(code) {
        const searchBtn = document.getElementById("searchBtn");
        const legacyTicker = document.getElementById("tickerSymbol");
        const stockSearch = document.getElementById("stockSearch");
        const searchLoader = document.getElementById("searchLoader");

        // Sync value
        if (legacyTicker) legacyTicker.value = code;
        if (stockSearch) stockSearch.value = code;

        // UI Feedback
        if (stockSearch) stockSearch.disabled = true;
        if (searchLoader) searchLoader.classList.remove("hidden");

        try {
          // 呼叫原始邏輯
          if (searchBtn) {
            // 由於 handleSearch 是 async，我們無法直接 await click 事件。
            // 但 handleSearch 內部會處理 UI 解鎖。
            // 這裡我們需要攔截 handleSearch 的 finally 來解鎖我們的新 UI。
            // 最好的方式是直接呼叫 handleSearch (如果它是全域可見的)
            // 但為了安全，我們模擬點擊，並透過一個 interval 或 event listener 來監聽完成

            // 其實可以直接呼叫 handleSearch(null) 因為它會讀取 inputs.tickerSymbol
            if (typeof handleSearch === "function") {
              await handleSearch(null);
            } else {
              searchBtn.click();
              // Fallback check for new UI unlock
              setTimeout(() => {
                if (stockSearch) stockSearch.disabled = false;
                if (searchLoader) searchLoader.classList.add("hidden");
              }, 2000);
              return;
            }
          }
        } catch (e) {
          console.error(e);
        } finally {
          // Restore UI
          if (stockSearch) {
            stockSearch.disabled = false;
            // No focus here to prevent auto-popup
          }
          if (searchLoader) searchLoader.classList.add("hidden");
        }
      }

      fetchAvailableSymbols().then(() => {
        initAutocomplete();
      });

      // 取得 Firestore 中的歷史紀錄 (增量更新)
      async function fetchIncrementalHistory(symbol, lastDate = null) {
        try {
          let query = db
            .collection("cb_history")
            .doc(symbol)
            .collection("records");

          if (lastDate) {
            query = query.where("date", ">", lastDate);
          }

          const snapshot = await query.get();
          if (!snapshot.empty) {
            return snapshot.docs.map((doc) => doc.data());
          }
        } catch (e) {
          console.warn("[Firebase] Firestore read failed.", e);
        }
        return [];
      }

      // 上傳單筆資料到 Firestore Subcollection
      async function uploadRecordToFirestore(symbol, record) {
        if (!currentUser) {
          console.warn("[Firebase] Write skipped: Not logged in.");
          return;
        }
        try {
          const batch = db.batch();

          // 1. 更新主文件 LastUpdated
          const metaRef = db.collection("cb_history").doc(symbol);
          batch.set(
            metaRef,
            {
              symbol: symbol,
              lastUpdated: new Date().toISOString(),
            },
            { merge: true },
          );

          // 2. 寫入單日紀錄
          const recordRef = metaRef.collection("records").doc(record.date);
          batch.set(recordRef, record);

          await batch.commit();
          console.log(
            `[Firebase] Auto-saved record ${record.date} for ${symbol}`,
          );
        } catch (e) {
          console.error("[Firebase] Save failed:", e);
        }
      }

      // 取得指定代號的歷史紀錄
      function getHistoryData(symbol) {
        try {
          const data = localStorage.getItem(HISTORY_KEY_PREFIX + symbol);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error("[History] Failed to read:", e);
          return [];
        }
      }

      // 儲存溢價率紀錄 (Local + Firestore Incremental)
      async function savePremiumRecord(symbol, todayData) {
        // 從 LocalStorage 取得目前快取 (僅用於增量存儲)
        const cached = getHistoryData(symbol);
        let history = [...cached];

        const existingIdx = history.findIndex((r) => r.date === todayData.date);
        if (existingIdx >= 0) {
          history[existingIdx] = todayData;
        } else {
          history.push(todayData);
        }

        // 保存到 LocalStorage (快取)
        const trimmed = history
          .slice(-MAX_HISTORY_DAYS)
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        try {
          localStorage.setItem(
            HISTORY_KEY_PREFIX + symbol,
            JSON.stringify(trimmed),
          );
        } catch (e) {}

        // 同步寫入 Firestore
        await uploadRecordToFirestore(symbol, todayData);

        return history;
      }

      // 顯示圖表載入遮罩
      // 顯示圖表載入遮罩
      function showChartLoading(show, title = "處理中...", desc = "") {
        // console.log(`[UI] showChartLoading: ${show}, title=${title}`);
        const loader = document.getElementById("chartLoader");
        const container = document.getElementById("chartContainer");
        const titleEl = document.getElementById("chartLoaderTitle");
        const descEl = document.getElementById("chartLoaderDesc");

        // 選取控制按鈕 (區間切換與重置)
        const rangeBtns = document.getElementById("chartRangeButtons");
        const resetBtn = document.getElementById("resetZoomBtn");

        if (show) {
          // 強制移除隱藏類別，防止 CSS 優先級問題
          container.classList.remove("hidden");
          loader.classList.remove("hidden");
          if (titleEl) titleEl.textContent = title;
          if (descEl) descEl.textContent = desc;

          // 禁用圖表控制項
          if (rangeBtns)
            rangeBtns.classList.add(
              "pointer-events-none",
              "opacity-40",
              "cursor-not-allowed",
            );
          if (resetBtn)
            resetBtn.classList.add(
              "pointer-events-none",
              "opacity-40",
              "cursor-not-allowed",
            );
        } else {
          loader.classList.add("hidden");

          // 恢復圖表控制項
          if (rangeBtns)
            rangeBtns.classList.remove(
              "pointer-events-none",
              "opacity-40",
              "cursor-not-allowed",
            );
          if (resetBtn)
            resetBtn.classList.remove(
              "pointer-events-none",
              "opacity-40",
              "cursor-not-allowed",
            );
        }
      }

      // 繪製溢價率走勢圖
      // 取得合併後的歷史資料 (Hybrid Sync: Local -> JSON -> Firestore Incremental)
      async function fetchMergedHistory(symbol) {
        showChartLoading(true, "正在檢查歷史資料...", "搜尋本地與雲端快取");

        // 1. Get Local Cache first
        const localData = getHistoryData(symbol);
        let history = [...localData];
        let lastDate = null;

        // 2. Cold Start Strategy: If LocalStorage is empty, try fetching static JSON
        if (history.length === 0) {
          console.log("[Sync] Cold start: checking static JSON...");
          try {
            const res = await window.measureFetch(
              getDataPath(`history/${symbol}.json?t=${Date.now()}`),
            );
            if (res.ok) {
              const jsonData = await res.json();
              if (Array.isArray(jsonData) && jsonData.length > 0) {
                console.log(
                  `[Sync] Loaded ${jsonData.length} records from static JSON.`,
                );
                history = jsonData;
              }
            }
          } catch (e) {
            console.warn("[Sync] Static JSON fetch failed:", e);
          }
        }

        if (history.length > 0) {
          const sorted = history.sort(
            (a, b) => new Date(a.date) - new Date(b.date),
          );
          lastDate = sorted[sorted.length - 1].date;
        }

        // 3. Fetch NEW data from Firestore (Incremental)
        console.log(
          `[Sync] Checking for updates since ${lastDate || "BEGINNING"}...`,
        );
        // 只在有歷史資料時才顯示「同步中」，否則如果是全新的則保持「檢查中」
        if (lastDate)
          showChartLoading(true, "同步最新數據...", "正在下載增量更新");

        const newRecords = await fetchIncrementalHistory(symbol, lastDate);
        if (newRecords.length > 0) history = history.concat(newRecords);

        // 4. Auto-Crawl Strategy
        // If we have very few records (e.g. only today's auto-save), we should still try to crawl full history
        // [Fix] Prevent infinite loop: Only attempt crawl ONCE per session per symbol
        if (history.length < 100 && !window.attemptedCrawls.has(symbol)) {
          console.log("[Sync] Data sparse. Attempting Auto-Crawl...");
          window.attemptedCrawls.add(symbol); // Mark as attempted immediately

          if (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
          ) {
            showStatus("資料庫建立中...", "warning");

            // [Smart Incremental] 若有部分資料，只補齊缺少的月份
            let crawlUrl = `/api/crawl?code=${symbol}`;
            let statusMsg = "連接櫃買中心與證交所 (約 15 秒)";

            if (history.length > 100) {
              // 找出最後一筆日期
              const sorted = history.sort(
                (a, b) => new Date(a.date) - new Date(b.date),
              );
              const lastRecordDate = sorted[sorted.length - 1].date;
              crawlUrl += `&since=${lastRecordDate}`;
              statusMsg = `補齊 ${lastRecordDate} 後的資料 (約 3 秒)`;
              console.log(
                `[Sync] Smart Incremental Crawl: since ${lastRecordDate}`,
              );
            } else {
              // [Smart Backfill] 資料不足 100 筆 (約 5 個月)，強制回補完整歷史
              statusMsg = `補齊完整半年資料 (約 15 秒)`;
              console.log(
                `[Sync] History sparse (${history.length} < 100). Forcing full backfill.`,
              );
            }

            showChartLoading(true, "正在自動爬取資料...", statusMsg);

            try {
              const crawlRes = await window.measureFetch(crawlUrl);
              if (crawlRes.ok) {
                console.log("[Sync] Crawl finished. Refetching JSON...");
                showChartLoading(
                  true,
                  "爬取完成，正在整理...",
                  "解析數據並建立索引",
                );

                // Retry fetching JSON
                const retryRes = await window.measureFetch(
                  getDataPath(`history/${symbol}.json?t=${Date.now()}`),
                );
                if (retryRes.ok) {
                  const retryJson = await retryRes.json();
                  if (Array.isArray(retryJson)) {
                    history = retryJson;
                    window
                      .runMigration(symbol)
                      .catch((e) => console.error("Auto upload failed:", e));
                  }
                }
              }
            } catch (e) {
              console.warn("[Sync] Auto-crawl failed:", e);
              // Loader will be hidden by the parent handleSearch's finally block
            }
          }
        }

        // 5. Update Local Cache & Finish
        const map = new Map();
        history.forEach((h) => map.set(h.date, h));
        const fullSorted = Array.from(map.values()).sort(
          (a, b) => new Date(a.date) - new Date(b.date),
        );
        const toSave = fullSorted.slice(-MAX_HISTORY_DAYS);
        localStorage.setItem(
          HISTORY_KEY_PREFIX + symbol,
          JSON.stringify(toSave),
        );

        return fullSorted;
      }

      // ==========================================
      // [TOOL] Client-Side Migration Helper
      // Run `await window.runMigration('24673')` in console
      // ==========================================
      window.runMigration = async function (symbol) {
        if (!symbol)
          return console.error("請輸入代號，例如: runMigration('24673')");

        console.log(`[Migration] Starting migration for ${symbol}...`);

        try {
          // 1. Fetch JSON
          const res = await window.measureFetch(
            getDataPath(`history/${symbol}.json?t=${Date.now()}`),
          );
          if (!res.ok) throw new Error(`JSON file not found: ${res.status}`);
          const data = await res.json();

          console.log(`[Migration] Found ${data.length} records. Uploading...`);

          const BATCH_SIZE = 450;
          let total = 0;

          // 2. Batch Upload
          for (let i = 0; i < data.length; i += BATCH_SIZE) {
            const chunk = data.slice(i, i + BATCH_SIZE);
            const batch = db.batch();
            const recordsRef = db
              .collection("cb_history")
              .doc(symbol)
              .collection("records");

            chunk.forEach((record) => {
              if (record.date) {
                batch.set(recordsRef.doc(record.date), record);
              }
            });

            await batch.commit();
            total += chunk.length;
            console.log(`[Migration] Progress: ${total}/${data.length}`);
          }

          // 3. Update Meta (including CB name for autocomplete)
          const currentName =
            document.getElementById("stockNameText")?.textContent || "";
          await db.collection("cb_history").doc(symbol).set(
            {
              symbol: symbol,
              name: currentName, // Save name for autocomplete
              lastUpdated: new Date().toISOString(),
              recordCount: total,
            },
            { merge: true },
          );

          console.log(
            `✅ [Migration] Success! Migrated ${total} records for ${symbol}`,
          );
          // Note: No longer calling handleSearch() here to avoid recursive UI resets.
        } catch (e) {
          console.error("[Migration] Failed:", e);
        }
      };

      // [Tool] 批次修復缺少的 CB 名稱
      window.fixMetadata = async function () {
        console.log("🚀 [Fix] 開始掃描缺少名稱的標的...");

        if (availableSymbols.length === 0) await fetchAvailableSymbols();

        const missing = availableSymbols.filter((s) => !s.name);
        console.log(`🔍 發現 ${missing.length} 筆資料缺少名稱`);

        if (missing.length === 0) return console.log("✅ 所有標的皆已有名稱！");

        let successCount = 0;

        for (const [index, item] of missing.entries()) {
          const symbol = item.symbol;
          console.log(`[${index + 1}/${missing.length}] 正在查詢 ${symbol}...`);

          try {
            const queries = [`otc_${symbol}.tw`, `tse_${symbol}.tw`];
            const res = await fetch(
              `/api/stock/getStockInfo.jsp?ex_ch=${queries.join("|")}&json=1&delay=0`,
            );

            if (res.ok) {
              const json = await res.json();
              const match = json.msgArray?.find((q) => q.c === symbol);

              if (match && match.n) {
                console.log(`   -> 找到名稱: ${match.n}`);
                await db.collection("cb_history").doc(symbol).set(
                  {
                    name: match.n,
                  },
                  { merge: true },
                );
                successCount++;
              } else {
                console.warn(`   ⚠️ 找不到名稱`);
              }
            }
          } catch (e) {
            console.error(`   ❌ 查詢失敗:`, e);
          }
          await new Promise((r) => setTimeout(r, 1500));
        }
        console.log(
          `🎉 修復完成！成功更新 ${successCount} 筆資料。請重新整理頁面。`,
        );
      };

      function renderPremiumChart(symbol, historyData) {
        // 選取控制按鈕 (區間切換與重置)
        // 確保顯示圖表容器
        const chartContainer = document.getElementById("chartContainer");
        const chartNoData = document.getElementById("chartNoData");
        const chartDataInfo = document.getElementById("chartDataInfo");
        const canvas = document.getElementById("premiumChart");

        chartContainer.classList.remove("hidden");

        // 無資料處理：嘗試顯示初始單點 (UX 改善：避免完全空白)
        if (!historyData || historyData.length === 0) {
          const cbPrice = parseFloat(inputs.cbPrice.value);
          const stockPrice = parseFloat(inputs.stockPrice.value);
          const conversionPrice = parseFloat(inputs.conversionPrice.value);

          if (cbPrice && stockPrice && conversionPrice) {
            // 建立一個臨時的「今日點」
            const today = new Date().toISOString().split("T")[0].substring(5);
            const sharesPerBond = 100000 / conversionPrice;
            const conversionValue = (sharesPerBond * stockPrice) / 1000;
            const premiumRate =
              ((cbPrice - conversionValue) / conversionValue) * 100;

            historyData = [
              { date: today, premium: premiumRate, stockPrice, cbPrice },
            ];
            chartNoData.classList.add("hidden");
            canvas.classList.remove("hidden");
          } else {
            chartNoData.classList.remove("hidden");
            canvas.classList.add("hidden");
            chartDataInfo.textContent = "0 筆資料";
            return;
          }
        }

        chartNoData.classList.add("hidden");
        canvas.classList.remove("hidden");
        chartDataInfo.textContent = `${historyData.length} 筆資料 (含歷史)`;

        // 使用完整歷史資料
        const data = historyData;
        const labels = data.map((r) => r.date.substring(5)); // MM-DD
        const premiums = data.map((r) => r.premium || r.premiumRate || 0);
        const stockPrices = data.map((r) => r.stockPrice || 0);
        // CB Price may be missing or mocked
        const cbPrices = data.map((r) => r.cbPrice || null);

        // 銷毀舊圖表
        if (premiumChart) premiumChart.destroy();

        premiumChart = new Chart(canvas, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "溢價率 (%)",
                data: premiums,
                borderColor: "rgb(75, 192, 192)",
                backgroundColor: "rgba(75, 192, 192, 0.1)",
                yAxisID: "y",
                tension: 0.3,
                fill: true,
                pointRadius: data.length > 50 ? 1 : 3,
              },
              {
                label: "股價 (TWD)",
                data: stockPrices,
                borderColor: "rgba(54, 162, 235, 0.6)",
                borderDash: [5, 5],
                yAxisID: "y1",
                tension: 0.3,
                pointRadius: 0,
                borderWidth: 1.5,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: { display: true, text: "溢價率 (%)" },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                grid: { drawOnChartArea: false },
                title: { display: true, text: "股價 (TWD)" },
              },
            },
            plugins: {
              zoom: {
                pan: {
                  enabled: true,
                  mode: "x",
                  threshold: 5,
                },
                zoom: {
                  wheel: {
                    enabled: true,
                  },
                  pinch: {
                    enabled: true,
                  },
                  mode: "x",
                },
              },
              tooltip: {
                callbacks: {
                  afterLabel: function (context) {
                    const item = data[context.dataIndex];
                    if (context.dataset.yAxisID === "y" && item.cbPrice) {
                      return `CB價: ${item.cbPrice.toFixed(2)}`;
                    }
                    if (item.isMock) return "(模擬數據)";
                  },
                },
              },
            },
          },
        });

        // 重要：將原始數據掛載至實例以便區間切換按鈕使用
        premiumChart.fullData = data;

        // 初始顯時區間設為「全部」按鈕樣式
        updateRangeButtonUI("all");
      }

      async function loadDatabase() {
        try {
          // Add timestamp to prevent caching
          // Use absolute path relative to site root
          const res = await fetch(
            getDataPath("cb-data.json") + "?t=" + new Date().getTime(),
          );
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();

          // Convert array to object map for easy lookup
          json.items.forEach((item) => {
            cbDatabase[item.code] = item; // Map CB Code (e.g. 24673)

            // Map Stock Code (e.g. 2467)
            if (item.underlyingCode && !cbDatabase[item.underlyingCode]) {
              cbDatabase[item.underlyingCode] = item;
            }
          });

          console.log(
            "Database loaded:",
            Object.keys(cbDatabase).length,
            "keys",
          );

          // Temp debug indicator (optional)
          // tickerStatus.textContent = "DB Loaded";
          // tickerStatus.classList.remove("hidden");
        } catch (e) {
          console.error("Error loading cb-data.json:", e);
          alert(
            "資料庫載入失敗: " + e.message + "\n請確認 cb-data.json 是否存在",
          );

          // Fallback for demo
          cbDatabase = {
            24673: {
              name: "志聖三 (Fallback)",
              cbPrice: 125.0,
              stockPrice: 255.0,
              conversionPrice: 246.6,
            },
          };
        }
      }

      // Manual Search Logic
      async function handleSearch(e) {
        if (e && e.preventDefault) e.preventDefault();

        const symbol = inputs.tickerSymbol.value.trim().toUpperCase();
        if (!symbol) return;

        // [Fix] Disable input during search to prevent double-submit or navigation jumps
        inputs.tickerSymbol.disabled = true;

        // 1. 即時響應 UI
        expandInputFields();
        showChartLoading(true, "查詢中...", "正在讀取資料庫與即時行情");
        tickerStatus.classList.add("hidden");
        showStatus("搜尋中...", "warning");

        // 2. 引導 UI 渲染 (避免 JS 阻塞)
        await new Promise((r) => setTimeout(r, 60));

        try {
          // 3. 讀取與篩選資料庫
          if (Object.keys(cbDatabase).length === 0) await loadDatabase();
          let data = cbDatabase[symbol] || {
            name: "",
            conversionPrice: 0,
            stockPrice: 0,
            cbPrice: 0,
            underlyingCode: "",
          };

          // 4. 抓取即時行情 (MIS API) - 實作進階快取機制
          const now = new Date();
          const today = now.toDateString();
          const hour = now.getHours();
          const minute = now.getMinutes();
          // 台灣市場 13:30 收盤
          const isAfterHours = hour > 13 || (hour === 13 && minute >= 30);

          const CACHE_TTL = 5000; // 5秒節流
          const cachedData = priceCache[symbol];
          let usedCache = false;

          // 判斷是否可以使用快取：
          // 1. 5秒內的 Session 節流 (盤中適用)
          // 2. 盤後 (13:30後) 且今日已抓過一次
          if (cachedData) {
            const isVeryRecent = Date.now() - cachedData.timestamp < CACHE_TTL;
            const isSameDayAfterHours =
              isAfterHours && cachedData.date === today;

            if (isVeryRecent || isSameDayAfterHours) {
              data.cbPrice = cachedData.cbPrice || data.cbPrice;
              data.stockPrice = cachedData.stockPrice || data.stockPrice;
              usedCache = true;
              console.log(
                `[MIS] ${isSameDayAfterHours ? "盤後使用快取" : "節流使用快取"}: ${symbol}`,
              );
            }
          }

          if (!usedCache) {
            const queries = [];
            if (symbol.length === 5) queries.push(`otc_${symbol}.tw`);
            if (data.underlyingCode) {
              queries.push(`tse_${data.underlyingCode}.tw`);
              queries.push(`otc_${data.underlyingCode}.tw`);
            }
            if (symbol.length === 4) {
              queries.push(`tse_${symbol}.tw`);
              queries.push(`otc_${symbol}.tw`);
            }

            if (queries.length > 0) {
              const res = await fetch(
                `/api/stock/getStockInfo.jsp?ex_ch=${queries.join("|")}&json=1&delay=0`,
              );
              if (res.ok) {
                const json = await res.json();
                if (json.msgArray) {
                  const cbM = json.msgArray.find((q) => q.c === symbol);
                  if (cbM) {
                    const p =
                      parseFloat(cbM.z) ||
                      parseFloat(cbM.y) ||
                      parseFloat((cbM.a || "0").split("_")[0]) ||
                      0;
                    if (p > 0) {
                      data.cbPrice = p;
                      if (!data.name) data.name = cbM.n;
                    }
                  }
                  const underlying =
                    data.underlyingCode ||
                    (symbol.length === 4 ? symbol : null);
                  if (underlying) {
                    const stMatches = json.msgArray.filter(
                      (q) => q.c === underlying,
                    );
                    let stM =
                      stMatches.find((q) => parseFloat(q.z) > 0) ||
                      stMatches.find((q) => parseFloat(q.y) > 0);
                    if (stM) {
                      const p = parseFloat(stM.z) || parseFloat(stM.y) || 0;
                      if (p > 0) {
                        data.stockPrice = p;
                        if (!data.name && symbol.length === 4)
                          data.name = stM.n;
                      }
                    }
                  }
                  // 更新快取，存入今日日期標籤
                  priceCache[symbol] = {
                    cbPrice: data.cbPrice,
                    stockPrice: data.stockPrice,
                    timestamp: Date.now(),
                    date: today,
                  };
                }
              }
            }
          }

          // 5. 更新介面顯示
          if (data.name || data.cbPrice > 0 || data.stockPrice > 0) {
            inputs.cbPrice.value =
              data.cbPrice > 0 ? data.cbPrice.toFixed(2) : "";
            inputs.stockPrice.value =
              data.stockPrice > 0 ? data.stockPrice.toFixed(2) : "";
            inputs.conversionPrice.value =
              data.conversionPrice > 0 ? data.conversionPrice.toFixed(2) : "";

            const nameDisplay = document.getElementById("stockNameDisplay");
            const nameText = document.getElementById("stockNameText");
            const codeBadge = document.getElementById("stockCodeBadge");

            // [Auto-Fix] 若有取得名稱，順便更新 Firestore Metadata 以供 Autocomplete 使用
            if (data.name) {
              db.collection("cb_history")
                .doc(symbol)
                .set(
                  {
                    name: data.name,
                    lastUpdated: new Date().toISOString(), // Optional: track active usage
                  },
                  { merge: true },
                )
                .catch((err) => console.error("Meta update failed:", err));
            }

            if (data.name) {
              nameText.textContent = data.name;
              codeBadge.textContent = symbol;
              nameDisplay.classList.remove("hidden");

              // [Fix] Ensure timestamp is updated whenever name is shown
              const dataTimestamp = document.getElementById("dataTimestamp");
              const dataSourceBadge =
                document.getElementById("dataSourceBadge");
              const now = new Date();
              const timeStr = now.toLocaleTimeString("zh-TW", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              });
              dataTimestamp.textContent = `行情更新於 ${timeStr}`;

              // Show source badge logic
              if (usedCache) {
                dataSourceBadge.textContent = "快取";
                dataSourceBadge.className =
                  "px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-100 text-amber-700";
              } else {
                dataSourceBadge.textContent = "即時";
                dataSourceBadge.className =
                  "px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700";
              }
            } else {
              nameDisplay.classList.add("hidden");
            }

            showStatus(
              data.name ? `已帶入: ${data.name}` : "已更新行情",
              "success",
            );
            calculate(); // 同步計算當前數值
          } else {
            showStatus("未找到即時報價，嘗試讀取歷史...", "warning");
          }

          // 6. 讀取歷史資料 (此處會觸發 Auto-Crawl)
          // 保持 Loader 開啟，更新訊息
          showChartLoading(true, "同步歷史資料...", "這可能需要一點時間");

          const fullHistory = await fetchMergedHistory(symbol);

          // 7. 若有即時價且計算成功，將其合併入今日紀錄
          const cbPrice = parseFloat(inputs.cbPrice.value);
          const stockPrice = parseFloat(inputs.stockPrice.value);
          const conversionPrice = parseFloat(inputs.conversionPrice.value);

          if (cbPrice && stockPrice && conversionPrice) {
            const sharesPerBond = 100000 / conversionPrice;
            const conversionValue = (sharesPerBond * stockPrice) / 1000;
            const premiumRate =
              ((cbPrice - conversionValue) / conversionValue) * 100;
            const todayRecord = {
              date: new Date().toISOString().split("T")[0],
              premium: premiumRate,
              cbPrice,
              stockPrice,
            };

            // 儲存今日數據並取得合併後的歷史 (這裡僅操作記憶體與 Cache)
            try {
              await savePremiumRecord(symbol, todayRecord);
            } catch (err) {
              console.warn("Auto-save skipped (Permission/Network):", err);
              // Continue rendering chart even if save fails
            }

            // 再次確保圖表數據包含今日
            const existingIdx = fullHistory.findIndex(
              (r) => r.date === todayRecord.date,
            );
            if (existingIdx >= 0) fullHistory[existingIdx] = todayRecord;
            else fullHistory.push(todayRecord);
          }

          // 8. 繪圖
          renderPremiumChart(
            symbol,
            fullHistory.sort((a, b) => new Date(a.date) - new Date(b.date)),
          );
        } catch (err) {
          console.error("Search Error:", err);
          showStatus("讀取失敗: " + err.message, "error");
        } finally {
          // 9. 最終關閉 Loader
          showChartLoading(false);
          inputs.tickerSymbol.disabled = false; // [Fix] Re-enable input
        }
      }

      // Removed loadDailyData() - now we rely on the static JSON generated by tools/fetch-psc-data.js

      function showStatus(text, type) {
        tickerStatus.textContent = text;
        tickerStatus.classList.remove(
          "hidden",
          "text-green-500",
          "text-red-400",
          "text-yellow-500",
          "animate-pulse",
        );

        if (type === "success") {
          tickerStatus.className =
            "absolute right-14 top-1/2 -translate-y-1/2 text-xs font-bold text-green-500 animate-pulse";
        } else if (type === "error") {
          tickerStatus.className =
            "absolute right-14 top-1/2 -translate-y-1/2 text-xs font-bold text-red-400";
        } else if (type === "warning") {
          tickerStatus.className =
            "absolute right-14 top-1/2 -translate-y-1/2 text-xs font-bold text-yellow-500";
        }
      }

      searchBtn.addEventListener("click", handleSearch);

      // Allow Enter key to search
      inputs.tickerSymbol.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleSearch(e);
        }
      });

      // Reset Zoom Logic
      document.getElementById("resetZoomBtn").addEventListener("click", () => {
        if (premiumChart) {
          premiumChart.resetZoom();
          updateRangeButtonUI("all");
        }
      });

      // 時間區間按鈕邏輯
      function updateRangeButtonUI(range) {
        document.querySelectorAll(".range-btn").forEach((btn) => {
          if (btn.dataset.range === range) {
            btn.classList.add(
              "bg-white",
              "shadow-sm",
              "font-bold",
              "text-emerald-600",
            );
            btn.classList.remove("hover:bg-white");
          } else {
            btn.classList.remove(
              "bg-white",
              "shadow-sm",
              "font-bold",
              "text-emerald-600",
            );
            btn.classList.add("hover:bg-white");
          }
        });
      }

      document.querySelectorAll(".range-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const range = btn.dataset.range;
          if (
            !premiumChart ||
            !premiumChart.fullData ||
            premiumChart.fullData.length === 0
          )
            return;

          updateRangeButtonUI(range);

          if (range === "all") {
            premiumChart.resetZoom();
            delete premiumChart.options.scales.x.min;
            delete premiumChart.options.scales.x.max;
            premiumChart.update();
            return;
          }

          const now = new Date();
          let startDate = new Date();
          if (range === "1m") {
            startDate.setMonth(now.getMonth() - 1);
          } else if (range === "3m") {
            startDate.setMonth(now.getMonth() - 3);
          }

          const cutoff = startDate.toISOString().split("T")[0];
          const index = premiumChart.fullData.findIndex(
            (r) => r.date >= cutoff,
          );

          if (index !== -1) {
            // 使用 Chart.js zoom plugin 的 zoomScale 方法或直接操作 scale
            premiumChart.options.scales.x.min = premiumChart.data.labels[index];
            premiumChart.update();
          }
        });
      });

      // Initialize
      loadDatabase();

      // Outputs
      const outputs = {
        premiumRate: document.getElementById("premiumRate"),
        premiumStatus: document.getElementById("premiumStatus"),
        premiumDesc: document.getElementById("premiumDesc"),
        premiumCard: document.getElementById("premiumCard"),
        conversionValue: document.getElementById("conversionValue"),
        sharesInfo: document.getElementById("sharesInfo"),
        parityPrice: document.getElementById("parityPrice"),
        upsideNeeded: document.getElementById("upsideNeeded"),
        itmBadge: document.getElementById("itmBadge"),
        statusTitle: document.getElementById("statusTitle"),
        statusDesc: document.getElementById("statusDesc"),
        statusIcon: document.getElementById("statusIcon"),
        statusIconBg: document.getElementById("statusIconBg"),
      };

      function calculate() {
        const cbPrice = parseFloat(inputs.cbPrice.value);
        const stockPrice = parseFloat(inputs.stockPrice.value);
        const conversionPrice = parseFloat(inputs.conversionPrice.value);

        if (!cbPrice || !stockPrice || !conversionPrice) return;

        // 1. Calculate Convertible Shares (per $100k bond)
        // Usually calculated as integer or kept precise?
        // Taiwan market convention: kept precise for value calc, but shares issued are integer.
        // Let's use precise for valuation to match market app precision.
        const sharesPerBond = 100000 / conversionPrice;

        // 2. Calculate Conversion Value (Theoretical Price of Bond based on Stock)
        // Formula: (Shares * Stock Price) / 1000  (to get % format like 125.00)
        const conversionValue = (sharesPerBond * stockPrice) / 1000;

        // 3. Calculate Premium Rate
        const premiumRate =
          ((cbPrice - conversionValue) / conversionValue) * 100;

        // 4. Calculate Parity Price (Break-even Stock Price)
        // Price where Conversion Value == CB Price
        // (100000/CP * X) / 1000 = CB Price
        // 100/CP * X = CB Price
        // X = CB Price * CP / 100
        const parityPrice = (cbPrice * conversionPrice) / 100;

        // 5. Update UI
        updateUI({
          premiumRate,
          conversionValue,
          sharesPerBond,
          parityPrice,
          stockPrice,
          conversionPrice,
          cbPrice,
        });
      }

      function updateUI(data) {
        // --- 1. Premium Rate (Unified Dashboard) ---
        outputs.premiumRate.textContent = data.premiumRate.toFixed(2) + "%";

        // Use Module Logic for Status
        const statusInfo = CbCalculatorCore.getPremiumStatus(data.premiumRate);
        const moneyness = CbCalculatorCore.getMoneynessStatus(
          data.stockPrice,
          data.conversionPrice,
        );

        // Theme Mapping
        const themeMap = {
          indigo: {
            border: "border-indigo-500",
            shadow: "shadow-indigo-100",
            pill: "bg-indigo-50 text-indigo-600 border-indigo-100",
          },
          green: {
            border: "border-emerald-500",
            shadow: "shadow-emerald-100",
            pill: "bg-emerald-50 text-emerald-600 border-emerald-100",
          },
          amber: {
            border: "border-amber-400",
            shadow: "shadow-amber-100",
            pill: "bg-amber-50 text-amber-700 border-amber-100",
          },
          red: {
            border: "border-rose-400",
            shadow: "shadow-rose-100",
            pill: "bg-rose-50 text-rose-600 border-rose-100",
          },
        };
        const theme = themeMap[statusInfo.colorClass] || themeMap["red"];

        // Update Dashboard Styles
        outputs.premiumCard.className = `premium-card p-0 rounded-2xl border-l-4 transition-all duration-300 overflow-hidden shadow-lg ${theme.border} ${theme.shadow}`;
        outputs.premiumStatus.className = `px-2.5 py-1 rounded-md text-[10px] font-black uppercase tracking-tighter border ${theme.pill}`;

        outputs.premiumStatus.textContent = statusInfo.status
          .split("/")[0]
          .trim();
        outputs.premiumDesc.textContent = statusInfo.desc;

        // --- 2. Secondary Metrics ---
        outputs.conversionValue.textContent = data.conversionValue.toFixed(2);
        outputs.sharesInfo.textContent = `${Math.floor(data.sharesPerBond)} 股/張`;
        outputs.parityPrice.textContent = data.parityPrice.toFixed(2);

        // Upside Logic (Parity)
        const upside =
          ((data.parityPrice - data.stockPrice) / data.stockPrice) * 100;
        const upsideBox = document.getElementById("upsideBox");

        if (upside > 0) {
          outputs.upsideNeeded.textContent = `需上漲 ${upside.toFixed(2)}%`;
          if (upsideBox) {
            upsideBox.className =
              "text-[10px] font-bold text-amber-500 flex items-center gap-1.5";
            upsideBox.innerHTML = `<i class="fas fa-chart-line text-[9px]"></i><span class="mono">需上漲 ${upside.toFixed(2)}%</span>`;
          }
        } else {
          // Break-even reached
          outputs.upsideNeeded.textContent = `已超越 (BE) ${Math.abs(upside).toFixed(2)}%`;
          if (upsideBox) {
            upsideBox.className =
              "text-[10px] font-bold text-green-500 flex items-center gap-1.5";
            upsideBox.innerHTML = `<i class="fas fa-check text-[9px]"></i><span class="mono">已超越 ${Math.abs(upside).toFixed(2)}%</span>`;
          }
        }

        // --- 3. Integrated Moneyness Badge ---
        if (moneyness && outputs.itmBadge) {
          outputs.itmBadge.classList.remove("hidden");
          outputs.itmBadge.textContent = `${moneyness.status} ${moneyness.percent.toFixed(1)}%`;

          if (moneyness.code === "ITM") {
            outputs.itmBadge.className =
              "px-1.5 py-0.5 rounded text-[9px] font-black bg-emerald-50 text-emerald-600 border border-emerald-100 flex items-center gap-1";
          } else if (moneyness.code === "OTM") {
            outputs.itmBadge.className =
              "px-1.5 py-0.5 rounded text-[9px] font-black bg-slate-50 text-slate-400 border border-slate-100 flex items-center gap-1";
          } else {
            outputs.itmBadge.className =
              "px-1.5 py-0.5 rounded text-[9px] font-black bg-amber-50 text-amber-600 border border-amber-100 flex items-center gap-1";
          }
        }
      }

      // Event Listeners
      Object.values(inputs).forEach((input) => {
        input.addEventListener("input", calculate);
      });

      // --- URL Parameter Handling ---
      function handleURLParams() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const autoSearch = params.get("autoSearch");

        if (code) {
          const searchInput = document.getElementById("stockSearch");
          if (searchInput) searchInput.value = code;

          if (autoSearch === "true") {
            // Wait for autocomplete to be ready then search
            setTimeout(() => {
              handleUnifiedSearch(code);
            }, 500);
          }
        }
      }

      // Initial Run
      handleURLParams();
      calculate();
    </script>
  </body>
</html>
