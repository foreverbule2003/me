<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CB Analytics Engine | Me Tools</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>

    <!-- Firebase SDK (Compatibility Mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
      :root {
        --brand-slate: #0f172a;
        --brand-indigo: #4f46e5;
        --market-up: #ef4444;
        --market-down: #22c55e;
        --bg-main: #f8fafc;
      }

      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        background-color: var(--bg-main);
      }

      .mono {
        font-family: "JetBrains Mono", monospace;
      }

      .premium-card {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.05),
          0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }

      .input-premium:focus {
        outline: none;
        border-color: var(--brand-indigo);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      }

      /* è¼¸å…¥æ¬„ä½å¼±åŒ–/é«˜äº®ç‹€æ…‹ */
      .inputs-dimmed {
        opacity: 0.5;
        transition: opacity 0.3s ease;
      }
      .inputs-highlighted {
        opacity: 1;
        animation: highlightPulse 0.4s ease-out;
      }
      @keyframes highlightPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 20px rgba(79, 70, 229, 0.15);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Chart Loading Overlay */
      .chart-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(2px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 0.75rem;
        transition: opacity 0.3s ease;
      }
      .chart-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      /* Autocomplete Dropdown */
      .autocomplete-container {
        position: relative;
      }
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 250px;
        overflow-y: auto;
        background: white;
        border: 1px solid #e2e8f0;
        border-top: none;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 50;
        display: none;
      }
      .autocomplete-dropdown.show {
        display: block;
      }
      .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.15s ease;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-item:hover,
      .autocomplete-item.active {
        background-color: #ecfdf5;
      }
      .autocomplete-item .symbol {
        font-weight: 700;
        color: #10b981;
        font-family: monospace;
      }
      .autocomplete-item .hint {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-left: auto;
      }
      .autocomplete-empty {
        padding: 1rem;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
      }

      .gradient-card {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }
      .input-focus:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      }
      .metric-card {
        transition: all 0.3s ease;
      }
      .metric-card:hover {
        transform: translateY(-2px);
      }
      /* è¼¸å…¥æ¬„ä½å¼±åŒ–/é«˜äº®ç‹€æ…‹ */
      .inputs-dimmed {
        opacity: 0.5;
        transition: opacity 0.3s ease;
      }
      .inputs-highlighted {
        opacity: 1;
        animation: highlightPulse 0.6s ease-out;
      }
      @keyframes highlightPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.01);
          box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        100% {
          transform: scale(1);
        }
      }
      /* æ–¹æ¡ˆ A: æŠ˜ç–Šå¼å±•é–‹å‹•ç•« */
      .inputs-collapsed {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition:
          max-height 0.4s ease-out,
          opacity 0.3s ease-out;
      }
      .inputs-expanded {
        max-height: 500px;
        opacity: 1;
        transition:
          max-height 0.4s ease-in,
          opacity 0.3s ease-in 0.1s;
      }

      /* Chart Loading Overlay */
      .chart-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(2px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 0.75rem;
        transition: opacity 0.3s ease;
      }
      .chart-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      /* Pulse Animation */
      .pulse-ring {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #10b981;
        position: relative;
        animation: pulse-ring 2s infinite;
      }
      .pulse-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      @keyframes pulse-ring {
        0% {
          transform: scale(0.8);
          opacity: 0.8;
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        70% {
          transform: scale(1);
          opacity: 0;
          box-shadow: 0 0 0 20px rgba(16, 185, 129, 0);
        }
        100% {
          transform: scale(0.8);
          opacity: 0;
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
      }

      /* Autocomplete Dropdown */
      .autocomplete-container {
        position: relative;
      }
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 0.75rem 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 50;
        display: none;
      }
      .autocomplete-dropdown.show {
        display: block;
      }
      .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.15s ease;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-item:hover,
      .autocomplete-item.active {
        background-color: #ecfdf5;
      }
      .autocomplete-item .symbol {
        font-weight: 700;
        color: #10b981;
        font-family: monospace;
      }
      .autocomplete-item .hint {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-left: auto;
      }
      .autocomplete-empty {
        padding: 1rem;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body class="min-h-screen text-slate-900">
    <div class="max-w-[1200px] mx-auto p-4 md:p-8">
      <!-- Top Action Bar -->
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <a
            href="hot-cb.html"
            class="flex items-center gap-2 text-slate-600 hover:text-slate-900 font-semibold text-sm transition-colors group"
          >
            <i
              class="fas fa-fire transition-transform group-hover:scale-110 text-red-400"
            ></i>
            <span>ç†±é–€æ¦œå–®</span>
          </a>
          <div class="h-4 w-[1px] bg-slate-200"></div>
          <div class="flex items-center gap-2">
            <span class="status-pill market-open">
              <i class="fas fa-microchip text-[10px]"></i>
              Analytics Engine v2.0
            </span>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <a
            href="/me/?booted=true"
            class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-all border border-transparent hover:border-slate-200"
          >
            <i class="fas fa-house-chimney text-sm"></i>
          </a>
        </div>
      </div>

      <!-- Professional Header -->
      <div class="mb-10 text-center md:text-left">
        <h1
          class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-3"
        >
          <i class="fas fa-calculator text-indigo-500"></i>
          CB å¯è½‰å‚µè¨ˆç®—æ©Ÿ
        </h1>
        <p class="text-slate-500 text-sm mt-1 font-medium">
          ç²¾å¯†è¨ˆç®—æº¢åƒ¹ç‡ã€è½‰æ›åƒ¹å€¼èˆ‡æç›Šå¹³è¡¡é»
        </p>
      </div>

      <!-- High-End Info Card -->
      <div
        class="mb-10 p-6 bg-slate-50 rounded-2xl border border-slate-200 flex flex-col md:flex-row items-start gap-4 shadow-sm relative overflow-hidden"
      >
        <!-- Background decoration -->
        <div
          class="absolute top-0 right-0 p-4 opacity-5 blur-[2px] pointer-events-none text-slate-400"
        >
          <i class="fas fa-brain text-7xl"></i>
        </div>

        <div class="flex items-start gap-4 relative z-10 w-full">
          <div
            class="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 shrink-0"
          >
            <i class="fas fa-terminal"></i>
          </div>
          <div>
            <h3 class="font-bold text-slate-800 mb-1">
              é—œæ–¼è½‰æ›æº¢åƒ¹ç‡ (Conversion Premium)
            </h3>
            <p class="text-xs leading-loose text-slate-500 font-medium">
              è¡¨ç¤º CB å¸‚å ´åƒ¹æ ¼ç›¸å°æ–¼å…¶ã€Œè½‰æ›ç‚ºè‚¡ç¥¨åƒ¹å€¼ã€çš„è¶…é¡æ¯”ä¾‹ã€‚
              <span class="text-indigo-600 font-bold bg-indigo-50 px-1 rounded"
                >æº¢åƒ¹ç‡è¶¨è¿‘ 0% æˆ–ç‚ºè² </span
              >
              æ™‚ï¼ŒCB åƒ¹æ ¼å°‡èˆ‡åº•å±¤è‚¡åƒ¹é«˜åº¦é€£å‹•ã€‚
            </p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
        <!-- Input Panel -->
        <div
          class="lg:col-span-12 xl:col-span-5 bg-white p-5 md:p-6 rounded-2xl premium-card"
        >
          <h2
            class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6 flex items-center gap-2"
          >
            <i class="fas fa-sliders-h text-indigo-500"></i>
            Parameters / è¼¸å…¥åƒæ•¸
          </h2>

          <!-- Search Area Integrated -->
          <div class="mb-8">
            <label
              class="block text-[11px] font-bold text-slate-400 uppercase mb-2 ml-1"
              >æ¨™çš„æœå°‹ / Search Security</label
            >
            <div class="autocomplete-container" id="searchContainer">
              <div class="relative">
                <input
                  type="text"
                  id="stockSearch"
                  placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨± (ä¾‹: 2330)"
                  autocomplete="off"
                  spellcheck="false"
                  class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none mono font-bold"
                />
                <i
                  class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"
                ></i>
                <div
                  id="searchLoader"
                  class="hidden absolute right-4 top-1/2 -translate-y-1/2"
                >
                  <i class="fas fa-circle-notch fa-spin text-indigo-400"></i>
                </div>
              </div>
              <div id="searchDropdown" class="autocomplete-dropdown"></div>
              <!-- Hidden elements for JS compatibility -->
              <input type="hidden" id="tickerSymbol" />
              <button id="searchBtn" class="hidden"></button>
            </div>
          </div>

          <!-- Stock/CB Name Display -->
          <div
            id="stockNameDisplay"
            class="hidden mb-6 p-4 bg-indigo-50/50 rounded-xl border border-indigo-100"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center text-white text-xs font-bold shadow-sm shadow-indigo-200"
              >
                <i class="fas fa-tag"></i>
              </div>
              <span
                id="stockNameText"
                class="font-black text-slate-800 text-lg tracking-tight"
              ></span>
              <span
                id="stockCodeBadge"
                class="ml-auto px-2 py-1 bg-white border border-slate-200 text-slate-500 text-[10px] rounded-md mono font-black"
              ></span>
            </div>
            <!-- æ™‚é–“æˆ³è¨˜è¡Œ -->
            <div
              class="flex items-center gap-3 mt-3 pt-3 border-t border-indigo-100/50 text-[10px] text-slate-400 font-bold uppercase"
            >
              <div class="flex items-center gap-1.5">
                <i class="far fa-clock"></i>
                <span id="dataTimestamp"></span>
              </div>
              <div class="flex items-center gap-1.5">
                <i class="fas fa-database text-slate-300"></i>
                <span id="dataSourceBadge" class="rounded"></span>
              </div>
            </div>
          </div>

          <!-- Analytics Navigation -->
          <div class="mb-8">
            <a
              href="hot-cb.html"
              class="flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-xl hover:border-indigo-200 hover:bg-indigo-50/30 transition-all group no-underline"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center text-red-500"
                >
                  <i class="fas fa-fire text-sm group-hover:animate-pulse"></i>
                </div>
                <div>
                  <div
                    class="text-[11px] font-black text-slate-400 uppercase tracking-tighter"
                  >
                    Market Pulse
                  </div>
                  <div class="text-sm font-bold text-slate-700">
                    æŸ¥çœ‹ä»Šæ—¥ç†±é–€æ¦œå–®
                  </div>
                </div>
              </div>
              <i
                class="fas fa-chevron-right text-slate-300 group-hover:translate-x-1 transition-transform"
              ></i>
            </a>
          </div>

          <!-- Ticker Status (Added back for compatibility) -->
          <div class="relative">
            <span
              id="tickerStatus"
              class="hidden absolute left-0 -top-6 text-xs font-bold text-slate-400"
            ></span>
          </div>

          <hr class="border-slate-100 mb-8" />

          <div id="inputFieldsContainer" class="space-y-6">
            <!-- Parameters Section -->
            <div class="flex items-center justify-between px-1">
              <span
                id="manualInputBtn"
                class="text-[11px] font-black text-slate-400 uppercase tracking-widest cursor-pointer hover:text-indigo-500 transition-colors"
                >Manual Override / æ‰‹å‹•èª¿æ•´</span
              >
              <i class="fas fa-keyboard text-slate-200"></i>
            </div>
            <!-- CB Price -->
            <div>
              <label
                class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1"
                >CB Price / å¯è½‰å‚µåƒ¹æ ¼</label
              >
              <div class="relative">
                <div
                  class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 font-bold"
                >
                  $
                </div>
                <input
                  type="number"
                  id="cbPrice"
                  value="125.00"
                  step="0.01"
                  class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none mono font-bold text-slate-700 text-lg"
                  placeholder="125.00"
                />
              </div>
              <p
                class="text-[10px] text-slate-400 mt-2 px-1 font-bold italic opacity-60"
              >
                ç›®å‰å¯è½‰å‚µçš„æˆäº¤åƒ¹æ ¼ã€‚
              </p>
            </div>

            <!-- Stock Price -->
            <div>
              <label
                class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1"
                >Spot Price / æ¨™çš„è‚¡åƒ¹</label
              >
              <div class="relative">
                <div
                  class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 font-bold"
                >
                  @
                </div>
                <input
                  type="number"
                  id="stockPrice"
                  value="255.00"
                  step="0.01"
                  class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none mono font-bold text-slate-700 text-lg"
                  placeholder="255.00"
                />
              </div>
            </div>

            <!-- Conversion Price -->
            <div>
              <label
                class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1"
                >Conversion Price / è½‰æ›åƒ¹</label
              >
              <div class="relative">
                <div
                  class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 font-bold"
                >
                  #
                </div>
                <input
                  type="number"
                  id="conversionPrice"
                  value="246.60"
                  step="0.01"
                  class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all outline-none mono font-bold text-slate-700 text-lg"
                  placeholder="246.60"
                />
              </div>
              <p
                class="text-[10px] text-slate-400 mt-2 px-1 font-bold italic opacity-60"
              >
                REF: æ¨™çš„å¯è½‰æ›ä¹‹åŸºç¤åƒ¹æ ¼ã€‚
              </p>
            </div>
          </div>
          <!-- çµæŸ inputFieldsContainer -->
        </div>
      </div>

      <!-- Results Panel -->
      <div
        id="resultsContainer"
        class="lg:col-span-7 flex flex-col justify-between space-y-6 lg:space-y-0 lg:gap-6 inputs-collapsed"
      >
        <!-- Main Result: Premium Rate -->
        <div
          class="premium-card p-6 rounded-2xl border-l-4 border-slate-200 transition-colors duration-300"
          id="premiumCard"
        >
          <div class="flex justify-between items-start mb-6">
            <div>
              <h3
                class="text-[11px] font-black text-slate-400 uppercase tracking-widest leading-none"
              >
                Conversion Premium
              </h3>
              <div class="text-[10px] text-slate-400 font-bold mt-1">
                è½‰æ›æº¢åƒ¹ç‡
              </div>
            </div>
            <span
              class="px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-tighter bg-slate-100 text-slate-400"
              id="premiumStatus"
              >Calculating...</span
            >
          </div>
          <div class="flex items-baseline gap-2 mb-4">
            <span
              class="text-5xl md:text-6xl font-black text-slate-800 tracking-tighter mono"
              id="premiumRate"
              >--%</span
            >
          </div>
          <p
            class="text-[11px] font-bold text-slate-400 leading-relaxed max-w-sm"
            id="premiumDesc"
          >
            æš«ç„¡æ•¸æ“šã€‚è«‹è¼¸å…¥æˆ–æœå°‹æ¨™çš„å¾Œé€²è¡Œé‹ç®—ã€‚
          </p>
        </div>

        <!-- Secondary Metrics Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Conversion Value -->
          <div class="premium-card p-5 rounded-xl border-slate-100">
            <div
              class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center justify-between"
            >
              <span>Conversion Val.</span>
              <i class="fas fa-info-circle text-slate-200"></i>
            </div>
            <div
              class="text-2xl font-black text-slate-800 mono tracking-tight"
              id="conversionValue"
            >
              --
            </div>
            <div
              class="text-[11px] font-bold text-slate-400 mt-2 flex items-center gap-1.5"
            >
              <i class="fas fa-layer-group text-[9px]"></i>
              <span id="sharesInfo">-- è‚¡/å¼µ</span>
            </div>
          </div>

          <!-- Parity Price -->
          <div class="premium-card p-5 rounded-xl border-slate-100">
            <div
              class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center justify-between"
            >
              <span>Break-even</span>
              <i class="fas fa-bullseye text-slate-200"></i>
            </div>
            <div
              class="text-2xl font-black text-slate-800 mono tracking-tight"
              id="parityPrice"
            >
              --
            </div>
            <div
              class="text-[11px] font-bold text-slate-400 mt-2 flex items-center gap-1.5"
              id="upsideBox"
            >
              <i class="fas fa-chart-line text-[9px]"></i>
              <span id="upsideNeeded">éœ€ä¸Šæ¼² --%</span>
            </div>
          </div>
        </div>

        <!-- Enhanced Status Bar -->
        <div
          class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex items-center gap-4"
        >
          <div
            class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-sm shrink-0 transition-all duration-300"
            id="statusIconBg"
          >
            <i class="fas fa-minus text-slate-400" id="statusIcon"></i>
          </div>
          <div>
            <h4
              class="text-xs font-black text-slate-700 uppercase tracking-wider leading-none"
              id="statusTitle"
            >
              ç³»çµ±é–’ç½®ä¸­
            </h4>
            <p
              class="text-[10px] font-bold text-slate-400 mt-1"
              id="statusDesc"
            >
              STATIONARY: WAITING FOR INPUT DATA
            </p>
          </div>
        </div>

        <!-- Premium Rate Trend Chart -->
        <div
          id="chartContainer"
          class="premium-card p-6 rounded-2xl hidden relative min-h-[300px]"
        >
          <div class="flex items-center justify-between mb-6">
            <h4
              class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"
            >
              <i class="fas fa-history text-indigo-400"></i>
              Analytics History / æº¢åƒ¹èµ°å‹¢
            </h4>
            <div class="flex items-center gap-3">
              <div
                class="flex bg-slate-100 p-1 rounded-lg"
                id="chartRangeButtons"
              >
                <button
                  class="range-btn text-[10px] font-black px-2.5 py-1 rounded-md transition-all hover:bg-white text-slate-400"
                  data-range="1m"
                >
                  1M
                </button>
                <button
                  class="range-btn text-[10px] font-black px-2.5 py-1 rounded-md transition-all ml-1 hover:bg-white text-slate-400"
                  data-range="3m"
                >
                  3M
                </button>
                <button
                  class="range-btn text-[10px] font-black px-2.5 py-1 rounded-md transition-all ml-1 bg-white shadow-sm text-indigo-600"
                  data-range="all"
                >
                  MAX
                </button>
              </div>
              <button
                id="resetZoomBtn"
                class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 bg-slate-50 rounded-lg border border-slate-100 transition-colors"
                title="é‡ç½®"
              >
                <i class="fas fa-compress-arrows-alt"></i>
              </button>
              <span class="text-xs text-gray-400" id="chartDataInfo"
                >-- ç­†è³‡æ–™</span
              >
            </div>
          </div>
          <div class="relative" style="height: 200px">
            <!-- Loading Overlay (Targeted) -->
            <div
              id="chartLoader"
              class="chart-overlay hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-[2px] rounded-lg"
            >
              <div class="pulse-ring mb-2">
                <div class="pulse-dot"></div>
              </div>
              <h5
                id="chartLoaderTitle"
                class="font-bold text-gray-700 text-sm mb-0.5"
              >
                æ­£åœ¨æœå°‹æ­·å²è³‡æ–™...
              </h5>
              <p id="chartLoaderDesc" class="text-[10px] text-gray-500">
                æ­£åœ¨é€£æ¥æ«ƒè²·ä¸­å¿ƒè³‡æ–™åº«
              </p>
            </div>
            <canvas id="premiumChart"></canvas>
          </div>
          <p
            id="chartNoData"
            class="text-center text-gray-400 text-sm py-8 hidden"
          >
            <i class="fas fa-database mr-2"></i
            >å°šç„¡æ­·å²è³‡æ–™ï¼Œæ¯æ¬¡æœå°‹å°‡ç´¯ç©ä¸€ç­†ç´€éŒ„
          </p>
        </div>

        <!-- Formula Reference -->
        <div
          class="bg-white p-5 rounded-xl text-xs text-gray-400 border border-gray-100"
        >
          <h4 class="font-bold text-gray-600 mb-2">è¨ˆç®—å…¬å¼</h4>
          <ul class="space-y-1 list-disc pl-4">
            <li>
              <span class="font-medium text-gray-500">å¯è½‰æ›è‚¡æ•¸</span> =
              100,000 Ã· è½‰æ›åƒ¹æ ¼
            </li>
            <li>
              <span class="font-medium text-gray-500">è½‰æ›åƒ¹å€¼</span> =
              å¯è½‰æ›è‚¡æ•¸ Ã— è‚¡åƒ¹ Ã· 1000
            </li>
            <li>
              <span class="font-medium text-gray-500">è½‰æ›æº¢åƒ¹ç‡</span> =
              (CBåƒ¹æ ¼ - è½‰æ›åƒ¹å€¼) Ã· è½‰æ›åƒ¹å€¼ Ã— 100%
            </li>
            <li>
              <span class="font-medium text-gray-500">è½‰æ›å¹³åƒ¹</span> = è½‰æ›åƒ¹æ ¼
              Ã— CBåƒ¹æ ¼ Ã· 100
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Modal Removed -->

    <script>
      // Inputs
      const inputs = {
        tickerSymbol: document.getElementById("tickerSymbol"),
        cbPrice: document.getElementById("cbPrice"),
        stockPrice: document.getElementById("stockPrice"),
        conversionPrice: document.getElementById("conversionPrice"),
      };

      // onMount: Check URL Params
      window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const autoSearch = params.get("autoSearch");

        if (code) {
          inputs.tickerSymbol.value = code;
          if (autoSearch === "true") {
            // Trigger Search automatically
            setTimeout(() => {
              document.getElementById("searchBtn").click();
            }, 300); // Slight delay to ensure scripts loaded
          }
        }
      });

      const searchBtn = document.getElementById("searchBtn");
      const tickerStatus = document.getElementById("tickerStatus");
      const manualInputBtn = document.getElementById("manualInputBtn");
      const inputFieldsContainer = document.getElementById(
        "inputFieldsContainer",
      );
      const resultsContainer = document.getElementById("resultsContainer");

      // å±•é–‹è¼¸å…¥æ¬„ä½èˆ‡çµæœå€å¡Š
      function expandInputFields() {
        inputFieldsContainer.classList.remove(
          "inputs-collapsed",
          "inputs-dimmed",
        );
        inputFieldsContainer.classList.add("inputs-expanded");
        resultsContainer.classList.remove("inputs-collapsed");
        resultsContainer.classList.add("inputs-expanded");
        manualInputBtn.classList.add("hidden");
      }

      // æ‰‹å‹•è¼¸å…¥æŒ‰éˆ•äº‹ä»¶
      manualInputBtn.addEventListener("click", () => {
        expandInputFields();
        // æ¸…é™¤é è¨­å€¼è®“ç”¨æˆ¶å¯ä»¥è¼¸å…¥
        inputs.cbPrice.value = "";
        inputs.stockPrice.value = "";
        inputs.conversionPrice.value = "";
        inputs.cbPrice.focus();
      });

      // Load Database from JSON
      let cbDatabase = {};

      // å³æ™‚è¡Œæƒ…å¿«å–ï¼ˆ5 ç§’ TTLï¼‰
      const priceCache = {};

      // ============== æº¢åƒ¹ç‡æ­·å²ç´€éŒ„ (LocalStorage) ==============
      const HISTORY_KEY_PREFIX = "cb_premium_history_";
      const MAX_HISTORY_DAYS = 30;
      let premiumChart = null; // Chart.js å¯¦ä¾‹

      // ============== Firebase åˆå§‹åŒ– (NEW) ==============
      const firebaseConfig = {
        projectId: "my-landing-page-2ca68",
        appId: "1:847051837050:web:c5e2bc56252e0d3ab835c3",
        storageBucket: "my-landing-page-2ca68.firebasestorage.app",
        apiKey: "AIzaSyD98FkpVi_FzGvFsrot_JcCm4086rJrAEw",
        authDomain: "my-landing-page-2ca68.firebaseapp.com",
        messagingSenderId: "847051837050",
        measurementId: "G-BZGQHXQED1",
      };

      // Global state
      window.attemptedCrawls = new Set();

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ============== Autocomplete & Search åŠŸèƒ½ ==============
      let availableSymbols = [];

      async function fetchAvailableSymbols() {
        try {
          const snapshot = await db.collection("cb_history").get();
          availableSymbols = snapshot.docs.map((doc) => ({
            symbol: doc.id,
            name: doc.data().name || "",
          }));
          console.log(
            "[Autocomplete] Loaded",
            availableSymbols.length,
            "symbols",
          );
        } catch (e) {
          console.warn("[Autocomplete] Failed to load symbols:", e);
          availableSymbols = [];
        }
      }

      function renderAutocomplete(filter = "") {
        const dropdown = document.getElementById("searchDropdown");
        const filterUpper = filter.toUpperCase().trim();

        const matches = filterUpper
          ? availableSymbols.filter(
              (s) =>
                s.symbol.includes(filterUpper) ||
                (s.name && s.name.toUpperCase().includes(filterUpper)),
            )
          : availableSymbols;

        if (matches.length === 0 && filterUpper) {
          dropdown.innerHTML =
            '<div class="autocomplete-empty italic text-slate-400">NO MATCH FOUND</div>';
        } else if (matches.length === 0) {
          dropdown.innerHTML =
            '<div class="autocomplete-empty text-slate-400">LOADING DATA...</div>';
        } else {
          dropdown.innerHTML = matches
            .slice(0, 8)
            .map(
              (item) => `
                  <div class="autocomplete-item px-4 py-3 hover:bg-slate-50 cursor-pointer flex items-center justify-between border-b border-slate-50 last:border-none group" data-symbol="${item.symbol}">
                      <div class="flex flex-col">
                        <span class="mono font-black text-indigo-600">${item.symbol}</span>
                        <span class="text-[10px] font-bold text-slate-400">${item.name || "Unknown"}</span>
                      </div>
                      <i class="fas fa-chevron-right text-[10px] text-slate-200 group-hover:text-indigo-400 transition-colors"></i>
                  </div>
              `,
            )
            .join("");
        }
      }

      function showAutocomplete() {
        const dropdown = document.getElementById("searchDropdown");
        dropdown.style.display = "block";
        renderAutocomplete(document.getElementById("stockSearch").value);
      }

      function hideAutocomplete() {
        const dropdown = document.getElementById("searchDropdown");
        dropdown.style.display = "none";
      }

      function initAutocomplete() {
        const input = document.getElementById("stockSearch");
        const dropdown = document.getElementById("searchDropdown");

        input.addEventListener("focus", () => {
          if (availableSymbols.length > 0) showAutocomplete();
        });

        input.addEventListener("input", (e) => {
          // Sync to hidden input for compatibility
          const hiddenInput = document.getElementById("tickerSymbol");
          if (hiddenInput) hiddenInput.value = e.target.value;

          if (availableSymbols.length > 0) {
            showAutocomplete();
            renderAutocomplete(e.target.value);
          }
        });

        // Allow Enter key to trigger search directly
        input.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            hideAutocomplete();
            handleUnifiedSearch(input.value);
          }
        });

        input.addEventListener("blur", () => {
          setTimeout(hideAutocomplete, 200);
        });

        dropdown.addEventListener("click", (e) => {
          const item = e.target.closest(".autocomplete-item");
          if (item) {
            const symbol = item.dataset.symbol;
            input.value = symbol;
            hideAutocomplete();
            handleUnifiedSearch(symbol);
          }
        });
      }

      // çµ±ä¸€æœå°‹è™•ç†å‡½æ•¸
      async function handleUnifiedSearch(code) {
        const searchBtn = document.getElementById("searchBtn");
        const legacyTicker = document.getElementById("tickerSymbol");
        const stockSearch = document.getElementById("stockSearch");
        const searchLoader = document.getElementById("searchLoader");

        // Sync value
        if (legacyTicker) legacyTicker.value = code;

        // UI Feedback
        if (stockSearch) stockSearch.disabled = true;
        if (searchLoader) searchLoader.classList.remove("hidden");

        try {
          // å‘¼å«åŸå§‹é‚è¼¯
          if (searchBtn) {
            // ç”±æ–¼ handleSearch æ˜¯ asyncï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥ await click äº‹ä»¶ã€‚
            // ä½† handleSearch å…§éƒ¨æœƒè™•ç† UI è§£é–ã€‚
            // é€™è£¡æˆ‘å€‘éœ€è¦æ””æˆª handleSearch çš„ finally ä¾†è§£é–æˆ‘å€‘çš„æ–° UIã€‚
            // æœ€å¥½çš„æ–¹å¼æ˜¯ç›´æ¥å‘¼å« handleSearch (å¦‚æœå®ƒæ˜¯å…¨åŸŸå¯è¦‹çš„)
            // ä½†ç‚ºäº†å®‰å…¨ï¼Œæˆ‘å€‘æ¨¡æ“¬é»æ“Šï¼Œä¸¦é€éä¸€å€‹ interval æˆ– event listener ä¾†ç›£è½å®Œæˆ

            // å…¶å¯¦å¯ä»¥ç›´æ¥å‘¼å« handleSearch(null) å› ç‚ºå®ƒæœƒè®€å– inputs.tickerSymbol
            if (typeof handleSearch === "function") {
              await handleSearch(null);
            } else {
              searchBtn.click();
              // Fallback check for new UI unlock
              setTimeout(() => {
                if (stockSearch) stockSearch.disabled = false;
                if (searchLoader) searchLoader.classList.add("hidden");
              }, 2000);
              return;
            }
          }
        } catch (e) {
          console.error(e);
        } finally {
          // Restore UI
          if (stockSearch) {
            stockSearch.disabled = false;
            stockSearch.focus();
          }
          if (searchLoader) searchLoader.classList.add("hidden");
        }
      }

      fetchAvailableSymbols().then(() => {
        initAutocomplete();
      });

      // å–å¾— Firestore ä¸­çš„æ­·å²ç´€éŒ„ (å¢é‡æ›´æ–°)
      async function fetchIncrementalHistory(symbol, lastDate = null) {
        try {
          let query = db
            .collection("cb_history")
            .doc(symbol)
            .collection("records");

          if (lastDate) {
            query = query.where("date", ">", lastDate);
          }

          const snapshot = await query.get();
          if (!snapshot.empty) {
            return snapshot.docs.map((doc) => doc.data());
          }
        } catch (e) {
          console.warn("[Firebase] Firestore read failed.", e);
        }
        return [];
      }

      // ä¸Šå‚³å–®ç­†è³‡æ–™åˆ° Firestore Subcollection
      async function uploadRecordToFirestore(symbol, record) {
        try {
          const batch = db.batch();

          // 1. æ›´æ–°ä¸»æ–‡ä»¶ LastUpdated
          const metaRef = db.collection("cb_history").doc(symbol);
          batch.set(
            metaRef,
            {
              symbol: symbol,
              lastUpdated: new Date().toISOString(),
            },
            { merge: true },
          );

          // 2. å¯«å…¥å–®æ—¥ç´€éŒ„
          const recordRef = metaRef.collection("records").doc(record.date);
          batch.set(recordRef, record);

          await batch.commit();
          console.log(
            `[Firebase] Auto-saved record ${record.date} for ${symbol}`,
          );
        } catch (e) {
          console.error("[Firebase] Save failed:", e);
        }
      }

      // å–å¾—æŒ‡å®šä»£è™Ÿçš„æ­·å²ç´€éŒ„
      function getHistoryData(symbol) {
        try {
          const data = localStorage.getItem(HISTORY_KEY_PREFIX + symbol);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error("[History] Failed to read:", e);
          return [];
        }
      }

      // å„²å­˜æº¢åƒ¹ç‡ç´€éŒ„ (Local + Firestore Incremental)
      async function savePremiumRecord(symbol, todayData) {
        // å¾ LocalStorage å–å¾—ç›®å‰å¿«å– (åƒ…ç”¨æ–¼å¢é‡å­˜å„²)
        const cached = getHistoryData(symbol);
        let history = [...cached];

        const existingIdx = history.findIndex((r) => r.date === todayData.date);
        if (existingIdx >= 0) {
          history[existingIdx] = todayData;
        } else {
          history.push(todayData);
        }

        // ä¿å­˜åˆ° LocalStorage (å¿«å–)
        const trimmed = history
          .slice(-MAX_HISTORY_DAYS)
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        try {
          localStorage.setItem(
            HISTORY_KEY_PREFIX + symbol,
            JSON.stringify(trimmed),
          );
        } catch (e) {}

        // åŒæ­¥å¯«å…¥ Firestore
        await uploadRecordToFirestore(symbol, todayData);

        return history;
      }

      // é¡¯ç¤ºåœ–è¡¨è¼‰å…¥é®ç½©
      // é¡¯ç¤ºåœ–è¡¨è¼‰å…¥é®ç½©
      function showChartLoading(show, title = "è™•ç†ä¸­...", desc = "") {
        // console.log(`[UI] showChartLoading: ${show}, title=${title}`);
        const loader = document.getElementById("chartLoader");
        const container = document.getElementById("chartContainer");
        const titleEl = document.getElementById("chartLoaderTitle");
        const descEl = document.getElementById("chartLoaderDesc");

        // é¸å–æ§åˆ¶æŒ‰éˆ• (å€é–“åˆ‡æ›èˆ‡é‡ç½®)
        const rangeBtns = document.getElementById("chartRangeButtons");
        const resetBtn = document.getElementById("resetZoomBtn");

        if (show) {
          container.classList.remove("hidden"); // ç¢ºä¿å®¹å™¨å¯è¦‹
          loader.classList.remove("hidden");
          if (titleEl) titleEl.textContent = title;
          if (descEl) descEl.textContent = desc;

          // ç¦ç”¨åœ–è¡¨æ§åˆ¶é …
          if (rangeBtns)
            rangeBtns.classList.add(
              "pointer-events-none",
              "opacity-40",
              "cursor-not-allowed",
            );
          if (resetBtn)
            resetBtn.classList.add(
              "pointer-events-none",
              "opacity-40",
              "cursor-not-allowed",
            );
        } else {
          loader.classList.add("hidden");

          // æ¢å¾©åœ–è¡¨æ§åˆ¶é …
          if (rangeBtns)
            rangeBtns.classList.remove(
              "pointer-events-none",
              "opacity-40",
              "cursor-not-allowed",
            );
          if (resetBtn)
            resetBtn.classList.remove(
              "pointer-events-none",
              "opacity-40",
              "cursor-not-allowed",
            );
        }
      }

      // ç¹ªè£½æº¢åƒ¹ç‡èµ°å‹¢åœ–
      // å–å¾—åˆä½µå¾Œçš„æ­·å²è³‡æ–™ (Hybrid Sync: Local -> JSON -> Firestore Incremental)
      async function fetchMergedHistory(symbol) {
        showChartLoading(true, "æ­£åœ¨æª¢æŸ¥æ­·å²è³‡æ–™...", "æœå°‹æœ¬åœ°èˆ‡é›²ç«¯å¿«å–");

        // 1. Get Local Cache first
        const localData = getHistoryData(symbol);
        let history = [...localData];
        let lastDate = null;

        // 2. Cold Start Strategy: If LocalStorage is empty, try fetching static JSON
        if (history.length === 0) {
          console.log("[Sync] Cold start: checking static JSON...");
          try {
            const res = await fetch(
              `/me/data/history/${symbol}.json?t=${Date.now()}`,
            );
            if (res.ok) {
              const jsonData = await res.json();
              if (Array.isArray(jsonData) && jsonData.length > 0) {
                console.log(
                  `[Sync] Loaded ${jsonData.length} records from static JSON.`,
                );
                history = jsonData;
              }
            }
          } catch (e) {
            console.warn("[Sync] Static JSON fetch failed:", e);
          }
        }

        if (history.length > 0) {
          const sorted = history.sort(
            (a, b) => new Date(a.date) - new Date(b.date),
          );
          lastDate = sorted[sorted.length - 1].date;
        }

        // 3. Fetch NEW data from Firestore (Incremental)
        console.log(
          `[Sync] Checking for updates since ${lastDate || "BEGINNING"}...`,
        );
        // åªåœ¨æœ‰æ­·å²è³‡æ–™æ™‚æ‰é¡¯ç¤ºã€ŒåŒæ­¥ä¸­ã€ï¼Œå¦å‰‡å¦‚æœæ˜¯å…¨æ–°çš„å‰‡ä¿æŒã€Œæª¢æŸ¥ä¸­ã€
        if (lastDate)
          showChartLoading(true, "åŒæ­¥æœ€æ–°æ•¸æ“š...", "æ­£åœ¨ä¸‹è¼‰å¢é‡æ›´æ–°");

        const newRecords = await fetchIncrementalHistory(symbol, lastDate);
        if (newRecords.length > 0) history = history.concat(newRecords);

        // 4. Auto-Crawl Strategy
        // If we have very few records (e.g. only today's auto-save), we should still try to crawl full history
        // [Fix] Prevent infinite loop: Only attempt crawl ONCE per session per symbol
        if (history.length <= 5 && !window.attemptedCrawls.has(symbol)) {
          console.log("[Sync] Data sparse. Attempting Auto-Crawl...");
          window.attemptedCrawls.add(symbol); // Mark as attempted immediately

          if (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
          ) {
            showStatus("è³‡æ–™åº«å»ºç«‹ä¸­...", "warning");

            // [Smart Incremental] è‹¥æœ‰éƒ¨åˆ†è³‡æ–™ï¼Œåªè£œé½Šç¼ºå°‘çš„æœˆä»½
            let crawlUrl = `/api/crawl?code=${symbol}`;
            let statusMsg = "é€£æ¥æ«ƒè²·ä¸­å¿ƒèˆ‡è­‰äº¤æ‰€ (ç´„ 15 ç§’)";

            if (history.length > 0) {
              // æ‰¾å‡ºæœ€å¾Œä¸€ç­†æ—¥æœŸ
              const sorted = history.sort(
                (a, b) => new Date(a.date) - new Date(b.date),
              );
              const lastRecordDate = sorted[sorted.length - 1].date;
              crawlUrl += `&since=${lastRecordDate}`;
              statusMsg = `è£œé½Š ${lastRecordDate} å¾Œçš„è³‡æ–™ (ç´„ 3 ç§’)`;
              console.log(
                `[Sync] Smart Incremental Crawl: since ${lastRecordDate}`,
              );
            }

            showChartLoading(true, "æ­£åœ¨è‡ªå‹•çˆ¬å–è³‡æ–™...", statusMsg);

            try {
              const crawlRes = await fetch(crawlUrl);
              if (crawlRes.ok) {
                console.log("[Sync] Crawl finished. Refetching JSON...");
                showChartLoading(
                  true,
                  "çˆ¬å–å®Œæˆï¼Œæ­£åœ¨æ•´ç†...",
                  "è§£ææ•¸æ“šä¸¦å»ºç«‹ç´¢å¼•",
                );

                // Retry fetching JSON
                const retryRes = await fetch(
                  `/me/data/history/${symbol}.json?t=${Date.now()}`,
                );
                if (retryRes.ok) {
                  const retryJson = await retryRes.json();
                  if (Array.isArray(retryJson)) {
                    history = retryJson;
                    window
                      .runMigration(symbol)
                      .catch((e) => console.error("Auto upload failed:", e));
                  }
                }
              }
            } catch (e) {
              console.warn("[Sync] Auto-crawl failed:", e);
              // Loader will be hidden by the parent handleSearch's finally block
            }
          }
        }

        // 5. Update Local Cache & Finish
        const map = new Map();
        history.forEach((h) => map.set(h.date, h));
        const fullSorted = Array.from(map.values()).sort(
          (a, b) => new Date(a.date) - new Date(b.date),
        );
        const toSave = fullSorted.slice(-MAX_HISTORY_DAYS);
        localStorage.setItem(
          HISTORY_KEY_PREFIX + symbol,
          JSON.stringify(toSave),
        );

        return fullSorted;
      }

      // ==========================================
      // [TOOL] Client-Side Migration Helper
      // Run `await window.runMigration('24673')` in console
      // ==========================================
      window.runMigration = async function (symbol) {
        if (!symbol)
          return console.error("è«‹è¼¸å…¥ä»£è™Ÿï¼Œä¾‹å¦‚: runMigration('24673')");

        console.log(`[Migration] Starting migration for ${symbol}...`);

        try {
          // 1. Fetch JSON
          const res = await fetch(
            `/me/data/history/${symbol}.json?t=${Date.now()}`,
          );
          if (!res.ok) throw new Error(`JSON file not found: ${res.status}`);
          const data = await res.json();

          console.log(`[Migration] Found ${data.length} records. Uploading...`);

          const BATCH_SIZE = 450;
          let total = 0;

          // 2. Batch Upload
          for (let i = 0; i < data.length; i += BATCH_SIZE) {
            const chunk = data.slice(i, i + BATCH_SIZE);
            const batch = db.batch();
            const recordsRef = db
              .collection("cb_history")
              .doc(symbol)
              .collection("records");

            chunk.forEach((record) => {
              if (record.date) {
                batch.set(recordsRef.doc(record.date), record);
              }
            });

            await batch.commit();
            total += chunk.length;
            console.log(`[Migration] Progress: ${total}/${data.length}`);
          }

          // 3. Update Meta (including CB name for autocomplete)
          const currentName =
            document.getElementById("stockNameText")?.textContent || "";
          await db.collection("cb_history").doc(symbol).set(
            {
              symbol: symbol,
              name: currentName, // Save name for autocomplete
              lastUpdated: new Date().toISOString(),
              recordCount: total,
            },
            { merge: true },
          );

          console.log(
            `âœ… [Migration] Success! Migrated ${total} records for ${symbol}`,
          );
          // Note: No longer calling handleSearch() here to avoid recursive UI resets.
        } catch (e) {
          console.error("[Migration] Failed:", e);
        }
      };

      // [Tool] æ‰¹æ¬¡ä¿®å¾©ç¼ºå°‘çš„ CB åç¨±
      window.fixMetadata = async function () {
        console.log("ğŸš€ [Fix] é–‹å§‹æƒæç¼ºå°‘åç¨±çš„æ¨™çš„...");

        if (availableSymbols.length === 0) await fetchAvailableSymbols();

        const missing = availableSymbols.filter((s) => !s.name);
        console.log(`ğŸ” ç™¼ç¾ ${missing.length} ç­†è³‡æ–™ç¼ºå°‘åç¨±`);

        if (missing.length === 0) return console.log("âœ… æ‰€æœ‰æ¨™çš„çš†å·²æœ‰åç¨±ï¼");

        let successCount = 0;

        for (const [index, item] of missing.entries()) {
          const symbol = item.symbol;
          console.log(`[${index + 1}/${missing.length}] æ­£åœ¨æŸ¥è©¢ ${symbol}...`);

          try {
            const queries = [`otc_${symbol}.tw`, `tse_${symbol}.tw`];
            const res = await fetch(
              `/api/stock/getStockInfo.jsp?ex_ch=${queries.join("|")}&json=1&delay=0`,
            );

            if (res.ok) {
              const json = await res.json();
              const match = json.msgArray?.find((q) => q.c === symbol);

              if (match && match.n) {
                console.log(`   -> æ‰¾åˆ°åç¨±: ${match.n}`);
                await db.collection("cb_history").doc(symbol).set(
                  {
                    name: match.n,
                  },
                  { merge: true },
                );
                successCount++;
              } else {
                console.warn(`   âš ï¸ æ‰¾ä¸åˆ°åç¨±`);
              }
            }
          } catch (e) {
            console.error(`   âŒ æŸ¥è©¢å¤±æ•—:`, e);
          }
          await new Promise((r) => setTimeout(r, 1500));
        }
        console.log(
          `ğŸ‰ ä¿®å¾©å®Œæˆï¼æˆåŠŸæ›´æ–° ${successCount} ç­†è³‡æ–™ã€‚è«‹é‡æ–°æ•´ç†é é¢ã€‚`,
        );
      };

      function renderPremiumChart(symbol, historyData) {
        const chartContainer = document.getElementById("chartContainer");
        const chartNoData = document.getElementById("chartNoData");
        const chartDataInfo = document.getElementById("chartDataInfo");
        const canvas = document.getElementById("premiumChart");

        // é¡¯ç¤ºåœ–è¡¨å®¹å™¨
        chartContainer.classList.remove("hidden");

        // ç„¡è³‡æ–™è™•ç†ï¼šå˜—è©¦é¡¯ç¤ºåˆå§‹å–®é» (UX æ”¹å–„ï¼šé¿å…å®Œå…¨ç©ºç™½)
        if (!historyData || historyData.length === 0) {
          const cbPrice = parseFloat(inputs.cbPrice.value);
          const stockPrice = parseFloat(inputs.stockPrice.value);
          const conversionPrice = parseFloat(inputs.conversionPrice.value);

          if (cbPrice && stockPrice && conversionPrice) {
            // å»ºç«‹ä¸€å€‹è‡¨æ™‚çš„ã€Œä»Šæ—¥é»ã€
            const today = new Date().toISOString().split("T")[0].substring(5);
            const sharesPerBond = 100000 / conversionPrice;
            const conversionValue = (sharesPerBond * stockPrice) / 1000;
            const premiumRate =
              ((cbPrice - conversionValue) / conversionValue) * 100;

            historyData = [
              { date: today, premium: premiumRate, stockPrice, cbPrice },
            ];
            chartNoData.classList.add("hidden");
            canvas.classList.remove("hidden");
          } else {
            chartNoData.classList.remove("hidden");
            canvas.classList.add("hidden");
            chartDataInfo.textContent = "0 ç­†è³‡æ–™";
            return;
          }
        }

        chartNoData.classList.add("hidden");
        canvas.classList.remove("hidden");
        chartDataInfo.textContent = `${historyData.length} ç­†è³‡æ–™ (å«æ­·å²)`;

        // ä½¿ç”¨å®Œæ•´æ­·å²è³‡æ–™
        const data = historyData;
        const labels = data.map((r) => r.date.substring(5)); // MM-DD
        const premiums = data.map((r) => r.premium || r.premiumRate || 0);
        const stockPrices = data.map((r) => r.stockPrice || 0);
        // CB Price may be missing or mocked
        const cbPrices = data.map((r) => r.cbPrice || null);

        // éŠ·æ¯€èˆŠåœ–è¡¨
        if (premiumChart) premiumChart.destroy();

        premiumChart = new Chart(canvas, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "æº¢åƒ¹ç‡ (%)",
                data: premiums,
                borderColor: "rgb(75, 192, 192)",
                backgroundColor: "rgba(75, 192, 192, 0.1)",
                yAxisID: "y",
                tension: 0.3,
                fill: true,
                pointRadius: data.length > 50 ? 1 : 3,
              },
              {
                label: "è‚¡åƒ¹ (TWD)",
                data: stockPrices,
                borderColor: "rgba(54, 162, 235, 0.6)",
                borderDash: [5, 5],
                yAxisID: "y1",
                tension: 0.3,
                pointRadius: 0,
                borderWidth: 1.5,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: { display: true, text: "æº¢åƒ¹ç‡ (%)" },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                grid: { drawOnChartArea: false },
                title: { display: true, text: "è‚¡åƒ¹ (TWD)" },
              },
            },
            plugins: {
              zoom: {
                pan: {
                  enabled: true,
                  mode: "x",
                  threshold: 5,
                },
                zoom: {
                  wheel: {
                    enabled: true,
                  },
                  pinch: {
                    enabled: true,
                  },
                  mode: "x",
                },
              },
              tooltip: {
                callbacks: {
                  afterLabel: function (context) {
                    const item = data[context.dataIndex];
                    if (context.dataset.yAxisID === "y" && item.cbPrice) {
                      return `CBåƒ¹: ${item.cbPrice.toFixed(2)}`;
                    }
                    if (item.isMock) return "(æ¨¡æ“¬æ•¸æ“š)";
                  },
                },
              },
            },
          },
        });

        // é‡è¦ï¼šå°‡åŸå§‹æ•¸æ“šæ›è¼‰è‡³å¯¦ä¾‹ä»¥ä¾¿å€é–“åˆ‡æ›æŒ‰éˆ•ä½¿ç”¨
        premiumChart.fullData = data;

        // åˆå§‹é¡¯æ™‚å€é–“è¨­ç‚ºã€Œå…¨éƒ¨ã€æŒ‰éˆ•æ¨£å¼
        updateRangeButtonUI("all");
      }

      async function loadDatabase() {
        try {
          // Add timestamp to prevent caching
          // Use absolute path relative to site root
          const res = await fetch(
            "/me/data/cb-data.json?t=" + new Date().getTime(),
          );
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();

          // Convert array to object map for easy lookup
          json.items.forEach((item) => {
            cbDatabase[item.code] = item; // Map CB Code (e.g. 24673)

            // Map Stock Code (e.g. 2467)
            if (item.underlyingCode && !cbDatabase[item.underlyingCode]) {
              cbDatabase[item.underlyingCode] = item;
            }
          });

          console.log(
            "Database loaded:",
            Object.keys(cbDatabase).length,
            "keys",
          );

          // Temp debug indicator (optional)
          // tickerStatus.textContent = "DB Loaded";
          // tickerStatus.classList.remove("hidden");
        } catch (e) {
          console.error("Error loading cb-data.json:", e);
          alert(
            "è³‡æ–™åº«è¼‰å…¥å¤±æ•—: " + e.message + "\nè«‹ç¢ºèª cb-data.json æ˜¯å¦å­˜åœ¨",
          );

          // Fallback for demo
          cbDatabase = {
            24673: {
              name: "å¿—è–ä¸‰ (Fallback)",
              cbPrice: 125.0,
              stockPrice: 255.0,
              conversionPrice: 246.6,
            },
          };
        }
      }

      // Manual Search Logic
      async function handleSearch(e) {
        if (e && e.preventDefault) e.preventDefault();

        const symbol = inputs.tickerSymbol.value.trim().toUpperCase();
        if (!symbol) return;

        // [Fix] Disable input during search to prevent double-submit or navigation jumps
        inputs.tickerSymbol.disabled = true;

        // 1. å³æ™‚éŸ¿æ‡‰ UI
        expandInputFields();
        showChartLoading(true, "æŸ¥è©¢ä¸­...", "æ­£åœ¨è®€å–è³‡æ–™åº«èˆ‡å³æ™‚è¡Œæƒ…");
        tickerStatus.classList.add("hidden");
        showStatus("æœå°‹ä¸­...", "warning");

        // 2. å¼•å° UI æ¸²æŸ“ (é¿å… JS é˜»å¡)
        await new Promise((r) => setTimeout(r, 60));

        try {
          // 3. è®€å–èˆ‡ç¯©é¸è³‡æ–™åº«
          if (Object.keys(cbDatabase).length === 0) await loadDatabase();
          let data = cbDatabase[symbol] || {
            name: "",
            conversionPrice: 0,
            stockPrice: 0,
            cbPrice: 0,
            underlyingCode: "",
          };

          // 4. æŠ“å–å³æ™‚è¡Œæƒ… (MIS API) - å¯¦ä½œé€²éšå¿«å–æ©Ÿåˆ¶
          const now = new Date();
          const today = now.toDateString();
          const hour = now.getHours();
          const minute = now.getMinutes();
          // å°ç£å¸‚å ´ 13:30 æ”¶ç›¤
          const isAfterHours = hour > 13 || (hour === 13 && minute >= 30);

          const CACHE_TTL = 5000; // 5ç§’ç¯€æµ
          const cachedData = priceCache[symbol];
          let usedCache = false;

          // åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨å¿«å–ï¼š
          // 1. 5ç§’å…§çš„ Session ç¯€æµ (ç›¤ä¸­é©ç”¨)
          // 2. ç›¤å¾Œ (13:30å¾Œ) ä¸”ä»Šæ—¥å·²æŠ“éä¸€æ¬¡
          if (cachedData) {
            const isVeryRecent = Date.now() - cachedData.timestamp < CACHE_TTL;
            const isSameDayAfterHours =
              isAfterHours && cachedData.date === today;

            if (isVeryRecent || isSameDayAfterHours) {
              data.cbPrice = cachedData.cbPrice || data.cbPrice;
              data.stockPrice = cachedData.stockPrice || data.stockPrice;
              usedCache = true;
              console.log(
                `[MIS] ${isSameDayAfterHours ? "ç›¤å¾Œä½¿ç”¨å¿«å–" : "ç¯€æµä½¿ç”¨å¿«å–"}: ${symbol}`,
              );
            }
          }

          if (!usedCache) {
            const queries = [];
            if (symbol.length === 5) queries.push(`otc_${symbol}.tw`);
            if (data.underlyingCode) {
              queries.push(`tse_${data.underlyingCode}.tw`);
              queries.push(`otc_${data.underlyingCode}.tw`);
            }
            if (symbol.length === 4) {
              queries.push(`tse_${symbol}.tw`);
              queries.push(`otc_${symbol}.tw`);
            }

            if (queries.length > 0) {
              const res = await fetch(
                `/api/stock/getStockInfo.jsp?ex_ch=${queries.join("|")}&json=1&delay=0`,
              );
              if (res.ok) {
                const json = await res.json();
                if (json.msgArray) {
                  const cbM = json.msgArray.find((q) => q.c === symbol);
                  if (cbM) {
                    const p =
                      parseFloat(cbM.z) ||
                      parseFloat(cbM.y) ||
                      parseFloat((cbM.a || "0").split("_")[0]) ||
                      0;
                    if (p > 0) {
                      data.cbPrice = p;
                      if (!data.name) data.name = cbM.n;
                    }
                  }
                  const underlying =
                    data.underlyingCode ||
                    (symbol.length === 4 ? symbol : null);
                  if (underlying) {
                    const stMatches = json.msgArray.filter(
                      (q) => q.c === underlying,
                    );
                    let stM =
                      stMatches.find((q) => parseFloat(q.z) > 0) ||
                      stMatches.find((q) => parseFloat(q.y) > 0);
                    if (stM) {
                      const p = parseFloat(stM.z) || parseFloat(stM.y) || 0;
                      if (p > 0) {
                        data.stockPrice = p;
                        if (!data.name && symbol.length === 4)
                          data.name = stM.n;
                      }
                    }
                  }
                  // æ›´æ–°å¿«å–ï¼Œå­˜å…¥ä»Šæ—¥æ—¥æœŸæ¨™ç±¤
                  priceCache[symbol] = {
                    cbPrice: data.cbPrice,
                    stockPrice: data.stockPrice,
                    timestamp: Date.now(),
                    date: today,
                  };
                }
              }
            }
          }

          // 5. æ›´æ–°ä»‹é¢é¡¯ç¤º
          if (data.name || data.cbPrice > 0 || data.stockPrice > 0) {
            inputs.cbPrice.value =
              data.cbPrice > 0 ? data.cbPrice.toFixed(2) : "";
            inputs.stockPrice.value =
              data.stockPrice > 0 ? data.stockPrice.toFixed(2) : "";
            inputs.conversionPrice.value =
              data.conversionPrice > 0 ? data.conversionPrice.toFixed(2) : "";

            const nameDisplay = document.getElementById("stockNameDisplay");
            const nameText = document.getElementById("stockNameText");
            const codeBadge = document.getElementById("stockCodeBadge");

            // [Auto-Fix] è‹¥æœ‰å–å¾—åç¨±ï¼Œé †ä¾¿æ›´æ–° Firestore Metadata ä»¥ä¾› Autocomplete ä½¿ç”¨
            if (data.name) {
              db.collection("cb_history")
                .doc(symbol)
                .set(
                  {
                    name: data.name,
                    lastUpdated: new Date().toISOString(), // Optional: track active usage
                  },
                  { merge: true },
                )
                .catch((err) => console.error("Meta update failed:", err));
            }

            if (data.name) {
              nameText.textContent = data.name;
              codeBadge.textContent = symbol;
              nameDisplay.classList.remove("hidden");

              // [Fix] Ensure timestamp is updated whenever name is shown
              const dataTimestamp = document.getElementById("dataTimestamp");
              const dataSourceBadge =
                document.getElementById("dataSourceBadge");
              const now = new Date();
              const timeStr = now.toLocaleTimeString("zh-TW", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              });
              dataTimestamp.textContent = `è¡Œæƒ…æ›´æ–°æ–¼ ${timeStr}`;

              // Show source badge logic
              if (usedCache) {
                dataSourceBadge.textContent = "å¿«å–";
                dataSourceBadge.className =
                  "px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-100 text-amber-700";
              } else {
                dataSourceBadge.textContent = "å³æ™‚";
                dataSourceBadge.className =
                  "px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700";
              }
            } else {
              nameDisplay.classList.add("hidden");
            }

            showStatus(
              data.name ? `å·²å¸¶å…¥: ${data.name}` : "å·²æ›´æ–°è¡Œæƒ…",
              "success",
            );
            calculate(); // åŒæ­¥è¨ˆç®—ç•¶å‰æ•¸å€¼
          } else {
            showStatus("æœªæ‰¾åˆ°å³æ™‚å ±åƒ¹ï¼Œå˜—è©¦è®€å–æ­·å²...", "warning");
          }

          // 6. è®€å–æ­·å²è³‡æ–™ (æ­¤è™•æœƒè§¸ç™¼ Auto-Crawl)
          // ä¿æŒ Loader é–‹å•Ÿï¼Œæ›´æ–°è¨Šæ¯
          showChartLoading(true, "åŒæ­¥æ­·å²è³‡æ–™...", "é€™å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“");

          const fullHistory = await fetchMergedHistory(symbol);

          // 7. è‹¥æœ‰å³æ™‚åƒ¹ä¸”è¨ˆç®—æˆåŠŸï¼Œå°‡å…¶åˆä½µå…¥ä»Šæ—¥ç´€éŒ„
          const cbPrice = parseFloat(inputs.cbPrice.value);
          const stockPrice = parseFloat(inputs.stockPrice.value);
          const conversionPrice = parseFloat(inputs.conversionPrice.value);

          if (cbPrice && stockPrice && conversionPrice) {
            const sharesPerBond = 100000 / conversionPrice;
            const conversionValue = (sharesPerBond * stockPrice) / 1000;
            const premiumRate =
              ((cbPrice - conversionValue) / conversionValue) * 100;
            const todayRecord = {
              date: new Date().toISOString().split("T")[0],
              premium: premiumRate,
              cbPrice,
              stockPrice,
            };

            // å„²å­˜ä»Šæ—¥æ•¸æ“šä¸¦å–å¾—åˆä½µå¾Œçš„æ­·å² (é€™è£¡åƒ…æ“ä½œè¨˜æ†¶é«”èˆ‡ Cache)
            await savePremiumRecord(symbol, todayRecord);

            // å†æ¬¡ç¢ºä¿åœ–è¡¨æ•¸æ“šåŒ…å«ä»Šæ—¥
            const existingIdx = fullHistory.findIndex(
              (r) => r.date === todayRecord.date,
            );
            if (existingIdx >= 0) fullHistory[existingIdx] = todayRecord;
            else fullHistory.push(todayRecord);
          }

          // 8. ç¹ªåœ–
          renderPremiumChart(
            symbol,
            fullHistory.sort((a, b) => new Date(a.date) - new Date(b.date)),
          );
        } catch (err) {
          console.error("Search Error:", err);
          showStatus("è®€å–å¤±æ•—: " + err.message, "error");
        } finally {
          // 9. æœ€çµ‚é—œé–‰ Loader
          showChartLoading(false);
          inputs.tickerSymbol.disabled = false; // [Fix] Re-enable input
        }
      }

      // Removed loadDailyData() - now we rely on the static JSON generated by tools/fetch-psc-data.js

      function showStatus(text, type) {
        tickerStatus.textContent = text;
        tickerStatus.classList.remove(
          "hidden",
          "text-green-500",
          "text-red-400",
          "text-yellow-500",
          "animate-pulse",
        );

        if (type === "success") {
          tickerStatus.className =
            "absolute right-14 top-1/2 -translate-y-1/2 text-xs font-bold text-green-500 animate-pulse";
        } else if (type === "error") {
          tickerStatus.className =
            "absolute right-14 top-1/2 -translate-y-1/2 text-xs font-bold text-red-400";
        } else if (type === "warning") {
          tickerStatus.className =
            "absolute right-14 top-1/2 -translate-y-1/2 text-xs font-bold text-yellow-500";
        }
      }

      searchBtn.addEventListener("click", handleSearch);

      // Allow Enter key to search
      inputs.tickerSymbol.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleSearch(e);
        }
      });

      // Reset Zoom Logic
      document.getElementById("resetZoomBtn").addEventListener("click", () => {
        if (premiumChart) {
          premiumChart.resetZoom();
          updateRangeButtonUI("all");
        }
      });

      // æ™‚é–“å€é–“æŒ‰éˆ•é‚è¼¯
      function updateRangeButtonUI(range) {
        document.querySelectorAll(".range-btn").forEach((btn) => {
          if (btn.dataset.range === range) {
            btn.classList.add(
              "bg-white",
              "shadow-sm",
              "font-bold",
              "text-emerald-600",
            );
            btn.classList.remove("hover:bg-white");
          } else {
            btn.classList.remove(
              "bg-white",
              "shadow-sm",
              "font-bold",
              "text-emerald-600",
            );
            btn.classList.add("hover:bg-white");
          }
        });
      }

      document.querySelectorAll(".range-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const range = btn.dataset.range;
          if (
            !premiumChart ||
            !premiumChart.fullData ||
            premiumChart.fullData.length === 0
          )
            return;

          updateRangeButtonUI(range);

          if (range === "all") {
            premiumChart.options.scales.x.min = premiumChart.data.labels[0];
            premiumChart.resetZoom();
            premiumChart.update();
            return;
          }

          const now = new Date();
          let startDate = new Date();
          if (range === "1m") {
            startDate.setMonth(now.getMonth() - 1);
          } else if (range === "3m") {
            startDate.setMonth(now.getMonth() - 3);
          }

          const cutoff = startDate.toISOString().split("T")[0];
          const index = premiumChart.fullData.findIndex(
            (r) => r.date >= cutoff,
          );

          if (index !== -1) {
            // ä½¿ç”¨ Chart.js zoom plugin çš„ zoomScale æ–¹æ³•æˆ–ç›´æ¥æ“ä½œ scale
            premiumChart.options.scales.x.min = premiumChart.data.labels[index];
            premiumChart.update();
          }
        });
      });

      // Initialize
      loadDatabase();

      // Outputs
      const outputs = {
        premiumRate: document.getElementById("premiumRate"),
        premiumStatus: document.getElementById("premiumStatus"),
        premiumDesc: document.getElementById("premiumDesc"),
        premiumCard: document.getElementById("premiumCard"),
        conversionValue: document.getElementById("conversionValue"),
        sharesInfo: document.getElementById("sharesInfo"),
        parityPrice: document.getElementById("parityPrice"),
        upsideNeeded: document.getElementById("upsideNeeded"),
        statusTitle: document.getElementById("statusTitle"),
        statusDesc: document.getElementById("statusDesc"),
        statusIcon: document.getElementById("statusIcon"),
        statusIconBg: document.getElementById("statusIconBg"),
      };

      function calculate() {
        const cbPrice = parseFloat(inputs.cbPrice.value);
        const stockPrice = parseFloat(inputs.stockPrice.value);
        const conversionPrice = parseFloat(inputs.conversionPrice.value);

        if (!cbPrice || !stockPrice || !conversionPrice) return;

        // 1. Calculate Convertible Shares (per $100k bond)
        // Usually calculated as integer or kept precise?
        // Taiwan market convention: kept precise for value calc, but shares issued are integer.
        // Let's use precise for valuation to match market app precision.
        const sharesPerBond = 100000 / conversionPrice;

        // 2. Calculate Conversion Value (Theoretical Price of Bond based on Stock)
        // Formula: (Shares * Stock Price) / 1000  (to get % format like 125.00)
        const conversionValue = (sharesPerBond * stockPrice) / 1000;

        // 3. Calculate Premium Rate
        const premiumRate =
          ((cbPrice - conversionValue) / conversionValue) * 100;

        // 4. Calculate Parity Price (Break-even Stock Price)
        // Price where Conversion Value == CB Price
        // (100000/CP * X) / 1000 = CB Price
        // 100/CP * X = CB Price
        // X = CB Price * CP / 100
        const parityPrice = (cbPrice * conversionPrice) / 100;

        // 5. Update UI
        updateUI({
          premiumRate,
          conversionValue,
          sharesPerBond,
          parityPrice,
          stockPrice,
          conversionPrice,
          cbPrice,
        });
      }

      function updateUI(data) {
        // --- Premium Rate ---
        outputs.premiumRate.textContent = data.premiumRate.toFixed(2) + "%";

        // Style based on premium
        let borderClass = "border-slate-200";
        let statusText = "STANDARD / ä¸€èˆ¬";
        let statusColor = "bg-slate-100 text-slate-400";
        let descText = "";

        if (data.premiumRate < 0) {
          borderClass = "border-indigo-500";
          statusText = "DISCOUNT / æŠ˜åƒ¹";
          statusColor = "bg-indigo-50 text-indigo-600";
          descText = "CB åƒ¹æ ¼ä½æ–¼è½‰æ›åƒ¹å€¼ã€‚ç›®å‰è™•æ–¼æŠ˜åƒ¹ç‹€æ…‹ï¼Œå…·æœ‰å¥—åˆ©ç©ºé–“ã€‚";
        } else if (data.premiumRate <= 10) {
          borderClass = "border-green-500";
          statusText = "LOW PREMIUM / ä½æº¢åƒ¹";
          statusColor = "bg-green-50 text-green-600";
          descText = "æº¢åƒ¹ç¨‹åº¦ä½ã€‚åƒ¹æ ¼åˆç†ï¼Œèˆ‡æ¨™çš„è‚¡åƒ¹é€£å‹•æ€§æ¥µé«˜ã€‚";
        } else if (data.premiumRate <= 20) {
          borderClass = "border-amber-400";
          statusText = "MID PREMIUM / ä¸­æº¢åƒ¹";
          statusColor = "bg-amber-50 text-amber-700";
          descText = "æº¢åƒ¹ç¨‹åº¦ä¸­ç­‰ã€‚è‚¡åƒ¹æ³¢å‹•å° CB å½±éŸ¿åŠ›å°šå¯ï¼Œéœ€ç•™æ„è¿½åƒ¹é¢¨éšªã€‚";
        } else {
          borderClass = "border-red-400";
          statusText = "HIGH PREMIUM / é«˜æº¢åƒ¹";
          statusColor = "bg-red-50 text-red-600";
          descText =
            "æº¢åƒ¹ç¨‹åº¦åé«˜ã€‚CB åƒ¹æ ¼åŒ…å«éå¤šæ¬Šåˆ©é‡‘ï¼Œè‚¡åƒ¹ä¸Šæ¼²æ™‚è·Ÿæ¼²å¹…åº¦å—é™ã€‚";
        }

        outputs.premiumCard.className = `premium-card p-6 rounded-2xl border-l-4 transition-all duration-300 ${borderClass}`;
        outputs.premiumStatus.className = `px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-tighter ${statusColor}`;
        outputs.premiumStatus.textContent = statusText;
        outputs.premiumDesc.textContent = descText;

        // --- Secondary Metrics ---
        outputs.conversionValue.textContent = data.conversionValue.toFixed(2);
        outputs.sharesInfo.textContent = `${Math.floor(data.sharesPerBond)} è‚¡/å¼µ`;

        outputs.parityPrice.textContent = data.parityPrice.toFixed(2);
        const upside =
          ((data.parityPrice - data.stockPrice) / data.stockPrice) * 100;

        const upsideBox = document.getElementById("upsideBox");
        if (upside > 0) {
          outputs.upsideNeeded.textContent = `éœ€å†æ¼² ${upside.toFixed(2)}%`;
          if (upsideBox)
            upsideBox.className =
              "text-[11px] font-bold text-red-500 mt-2 flex items-center gap-1.5";
        } else {
          outputs.upsideNeeded.textContent = `å·²è¶…è¶Šæç›Šå¹³é» ${Math.abs(upside).toFixed(2)}%`;
          if (upsideBox)
            upsideBox.className =
              "text-[11px] font-bold text-green-600 mt-2 flex items-center gap-1.5";
        }

        // --- In/Out of the Money Status ---
        const isITM = data.stockPrice > data.conversionPrice;

        if (isITM) {
          outputs.statusIconBg.className =
            "w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-sm shrink-0 transition-all duration-300";
          outputs.statusIcon.className = "fas fa-check text-green-600";
          outputs.statusTitle.textContent = "åƒ¹å…§ (ITM)";
          outputs.statusTitle.className =
            "text-xs font-black text-green-700 uppercase tracking-wider leading-none";
          const depth =
            ((data.stockPrice - data.conversionPrice) / data.conversionPrice) *
            100;
          outputs.statusDesc.textContent = `IN THE MONEY: è‚¡åƒ¹é«˜æ–¼è½‰æ›åƒ¹ ${depth.toFixed(2)}%`;
        } else {
          outputs.statusIconBg.className =
            "w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-sm shrink-0 transition-all duration-300";
          outputs.statusIcon.className = "fas fa-times text-slate-400";
          outputs.statusTitle.textContent = "åƒ¹å¤– (OTM)";
          outputs.statusTitle.className =
            "text-xs font-black text-slate-700 uppercase tracking-wider leading-none";
          const depth =
            ((data.conversionPrice - data.stockPrice) / data.stockPrice) * 100;
          outputs.statusDesc.textContent = `OUT OF THE MONEY: è·è½‰æ›åƒ¹å°šå·® ${depth.toFixed(2)}%`;
        }
      }

      // Event Listeners
      Object.values(inputs).forEach((input) => {
        input.addEventListener("input", calculate);
      });

      // --- URL Parameter Handling ---
      function handleURLParams() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const autoSearch = params.get("autoSearch");

        if (code) {
          const searchInput = document.getElementById("stockSearch");
          if (searchInput) searchInput.value = code;

          if (autoSearch === "true") {
            // Wait for autocomplete to be ready then search
            setTimeout(() => {
              handleUnifiedSearch(code);
            }, 500);
          }
        }
      }

      // Initial Run
      handleURLParams();
      calculate();
    </script>
  </body>
</html>
