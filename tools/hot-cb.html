<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market Hot List | 今日熱門可轉債</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand-slate: #0f172a;
        --brand-indigo: #4f46e5;
        --market-up: #ef4444;
        --market-down: #22c55e;
        --bg-main: #f8fafc;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background-color: var(--bg-main);
      }
      .mono { font-family: "JetBrains Mono", monospace; }
      .premium-card {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }
      .table-row-hover { transition: all 0.15s ease; cursor: pointer; }
      .table-row-hover:hover { background-color: #f1f5f9; }
      .rank-dot {
        width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
        font-size: 11px; font-weight: 800; border-radius: 6px; background: #f1f5f9; color: #64748b;
      }
      .rank-dot.top-1 { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
      .rank-dot.top-2 { background: #ffedd5; color: #f97316; border: 1px solid #fed7aa; }
      .rank-dot.top-3 { background: #fef9c3; color: #ca8a04; border: 1px solid #fef08a; }
      .status-pill {
        display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px;
        border-radius: 9999px; font-size: 11px; font-weight: 600;
      }
      .market-open { background: #dcfce7; color: #15803d; }
      .market-closed { background: #f1f5f9; color: #475569; }
      @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      .animate-pulse-soft { animation: pulse-soft 2s infinite ease-in-out; }
      
      /* Tab Styles */
      .tab-btn {
        padding: 12px 24px; font-size: 13px; font-weight: 800; color: #94a3b8;
        transition: all 0.2s ease; border-bottom: 2px solid transparent;
      }
      .tab-btn.active { color: var(--brand-indigo); border-bottom-color: var(--brand-indigo); }
      .tab-btn:hover:not(.active) { color: #64748b; background: rgba(241, 245, 249, 0.5); }
      .tab-content { display: none; }
      .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
  </head>
  <body class="min-h-screen text-slate-900">
    <div class="max-w-[1200px] mx-auto p-4 md:p-8">
      <!-- Top Bar -->
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <a href="cb-calculator.html" class="flex items-center gap-2 text-slate-600 hover:text-slate-900 font-bold text-sm">
            <i class="fas fa-arrow-left"></i><span>計算機</span>
          </a>
          <div class="h-4 w-[1px] bg-slate-200"></div>
          <span id="marketStatus" class="status-pill market-closed">
            <i class="fas fa-circle text-[6px] animate-pulse-soft"></i>載入中...
          </span>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="fetchHotCB()" id="refreshBtn" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors">
            <i class="fas fa-sync-alt"></i>
          </button>
          <a href="/me/?booted=true" class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:bg-slate-100 border border-transparent hover:border-slate-200">
            <i class="fas fa-house-chimney text-sm"></i>
          </a>
        </div>
      </div>

      <!-- Header -->
      <div class="mb-10">
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-800 flex items-center gap-3 flex-wrap">
          今日熱門可轉債
          <div class="flex items-center gap-2">
             <button onclick="goToDate(-1)" class="w-6 h-6 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-400 flex items-center justify-center">
                <i class="fas fa-chevron-left text-xs"></i>
             </button>
             <span class="text-slate-400 text-lg font-medium" id="dateDisplay">--/--/--</span>
             <button onclick="goToDate(1)" class="w-6 h-6 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-400 flex items-center justify-center">
                <i class="fas fa-chevron-right text-xs"></i>
             </button>
          </div>
        </h1>
        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 mt-2 text-xs text-slate-500 font-medium">
          <div class="flex items-center gap-1.5"><i class="far fa-clock"></i> 最後更新: <span id="updateTime" class="mono text-slate-700">--:--:--</span></div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="flex items-center gap-2 border-b border-slate-200 mb-8 overflow-x-auto no-scrollbar">
        <button onclick="switchTab('pulse')" id="tab-pulse" class="tab-btn active uppercase tracking-wider flex items-center gap-2 whitespace-nowrap">
          <i class="fas fa-chart-line text-xs"></i> 市場熱門 (Pulse)
        </button>
        <button onclick="switchTab('watchlist')" id="tab-watchlist" class="tab-btn uppercase tracking-wider flex items-center gap-2 whitespace-nowrap">
          <i class="fas fa-star text-xs"></i> 我的追蹤 (Watchlist)
        </button>
      </div>

      <!-- Market Pulse Content -->
      <div id="content-pulse" class="tab-content active">
        <div id="statusBanner" class="mb-6 hidden"></div>
        <div class="premium-card rounded-2xl overflow-hidden border-slate-200">
          <div id="htListContainer" class="min-h-[400px]">
            <div class="p-8 space-y-4">
              <div class="h-8 bg-slate-50 rounded animate-pulse w-full"></div>
              <div class="h-12 bg-slate-50 rounded animate-pulse w-full"></div>
              <div class="h-12 bg-slate-50 rounded animate-pulse w-full"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Watchlist Content -->
      <div id="content-watchlist" class="tab-content">
        <div class="mb-10">
          <div class="flex items-center justify-between mb-6 px-1">
            <div>
              <h2 class="text-sm font-black text-slate-800 uppercase tracking-widest flex items-center gap-2">
                <i class="fas fa-satellite-dish text-indigo-500"></i> 追蹤清單管理
              </h2>
              <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">Cloud Sync Engine Active</p>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="premium-card p-5 rounded-2xl border-indigo-100 bg-gradient-to-br from-white to-indigo-50/50">
              <div class="text-[10px] font-black text-slate-400 uppercase mb-4 px-1 tracking-widest">追蹤新標的</div>
              <div class="flex gap-2.5">
                <input type="text" id="newCbInput" placeholder="代號 (例: 15142)" class="flex-grow border border-slate-200 rounded-xl px-4 py-3 text-sm font-black outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-400 transition-all mono uppercase" />
                <button onclick="addTrackedCB()" id="addCbBtn" class="w-12 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl flex items-center justify-center transition-all shadow-lg"><i class="fas fa-plus"></i></button>
              </div>
            </div>
            <div class="md:col-span-3 premium-card p-5 rounded-2xl border-slate-100 bg-slate-50/30">
              <div class="text-[10px] font-black text-slate-400 uppercase mb-4 px-1 tracking-widest">目前追蹤中</div>
              <div id="trackedListContainer" class="flex flex-wrap gap-4">
                <div class="h-12 w-28 bg-white rounded-xl animate-pulse"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="p-6 bg-slate-50 rounded-2xl border border-slate-200 text-xs text-slate-500 font-bold">
          <i class="fas fa-info-circle text-indigo-400 mr-2"></i>GitHub Actions 每日收盤後會自動補齊此清單標的的歷史行情。
        </div>
      </div>

      <div class="mt-6 text-[11px] text-slate-400 flex justify-between items-center px-2">
        <span>* 資料每 15 分鐘自動更新。不構成投資建議。</span>
        <span class="mono">Timboy v2.5.0</span>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, doc, getDoc, collection, onSnapshot, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB4VXQaa_bWldNrXfSARgK3w258fac9Fvg",
        authDomain: "my-landing-page-2ca68.firebaseapp.com",
        projectId: "my-landing-page-2ca68",
        storageBucket: "my-landing-page-2ca68.firebasestorage.app",
        messagingSenderId: "847051837050",
        appId: "1:847051837050:web:c5e2bc56252e0d3ab835c3",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // DOM Elements
      const statusBanner = document.getElementById("statusBanner");
      const container = document.getElementById("htListContainer");
      const updateTimeEl = document.getElementById("updateTime");
      const dateDisplay = document.getElementById("dateDisplay");
      const marketStatusPill = document.getElementById("marketStatus");
      const trackedListContainer = document.getElementById("trackedListContainer");
      const newCbInput = document.getElementById("newCbInput");

      // Tabs
      window.switchTab = (tabId) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`content-${tabId}`).classList.add('active');
      };

      // Watchlist
      onSnapshot(collection(db, "cb_history"), (snapshot) => {
        const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        if (items.length === 0) {
          trackedListContainer.innerHTML = '<div class="text-xs text-slate-300 italic px-2">尚未追蹤任何標的</div>';
          return;
        }
        trackedListContainer.innerHTML = items.map(item => `
          <div class="group flex items-center gap-3 bg-white border border-slate-200 hover:border-indigo-200 rounded-xl pl-3 pr-2 py-2.5 transition-all shadow-sm">
            <div class="flex flex-col">
              <span class="mono text-[11px] font-black text-slate-700">${item.id}</span>
              <span class="text-[9px] font-bold text-slate-400 truncate w-16">${item.name || '待同步...'}</span>
            </div>
            <button onclick="deleteTrackedCB('${item.id}')" class="w-6 h-6 rounded-lg flex items-center justify-center text-slate-200 hover:text-red-500 hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-times text-[10px]"></i></button>
          </div>
        `).join('');
      });

      window.addTrackedCB = async () => {
        const code = newCbInput.value.trim();
        if (!code || code.length < 5) return alert("請輸入正確的 CB 代號");
        const btn = document.getElementById("addCbBtn");
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
        try {
          await setDoc(doc(db, "cb_history", code), { symbol: code, updatedAt: serverTimestamp(), isNew: true }, { merge: true });
          newCbInput.value = "";
        } catch (e) { alert("新增失敗"); }
        finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-plus"></i>'; }
      };

      window.deleteTrackedCB = async (id) => {
        if (confirm(`確定要取消追蹤 ${id} 嗎？`)) {
          try { await deleteDoc(doc(db, "cb_history", id)); } catch (e) { alert("移除失敗"); }
        }
      };

      // Fetching Logic with Cloud Fallback
      async function loadFromCloud(snapshotId) {
        console.log(`[Cloud] Attempting fallback for: ${snapshotId || 'latest'}`);
        try {
          const metaRef = doc(db, "hot_cb_meta", "latest");
          const metaSnap = await getDoc(metaRef);
          const docId = snapshotId || metaSnap.data()?.lastDateId;
          
          if (!docId) { console.error("[Cloud] No document ID found in meta"); return null; }
          
          console.log(`[Cloud] Fetching snapshot: ${docId}`);
          const snap = await getDoc(doc(db, "hot_cb_snapshots", docId));
          if (!snap.exists()) { console.error("[Cloud] Snapshot not found:", docId); return null; }
          
          return snap.data();
        } catch (e) { 
          console.error("[Cloud] Firebase error:", e);
          return null; 
        }
      }

      async function fetchHotCB() {
        console.log("[Data] Start fetchHotCB");
        updateLoadingState(true);
        try {
          const res = await fetch("/api/hot-cb");
          console.log("[API] Response status:", res.status);
          if (res.ok) {
            const data = await res.json();
            return processData(data, "live");
          }
        } catch (e) { console.warn("[API] Endpoint issue or JSON error:", e); }

        // Fallback to Firestore
        const cloudData = await loadFromCloud();
        if (cloudData) {
          console.log("[Data] Using cloud fallback data");
          processData(cloudData, "live");
        } else {
          renderError("連線故障", "無法取得即時或備援數據，請檢查網路狀態或稍後再試。");
        }
        updateLoadingState(false);
      }

      async function fetchHistoryCB(dateStr) {
        console.log(`[Data] Fetch history: ${dateStr}`);
        updateLoadingState(true);
        try {
          const res = await fetch(`/data/history/${dateStr}.json`);
          if (res.ok) return processData(await res.json(), "history");
        } catch (e) { console.warn("[API] Local history error:", e); }

        // Fallback to Firestore
        const cloudData = await loadFromCloud(dateStr);
        if (cloudData) processData(cloudData, "history");
        else renderError("查無存檔", `找不到 ${dateStr} 的歷史數據 (API & Cloud)`);
        updateLoadingState(false);
      }

      function processData(json, mode) {
        try {
          const list = Array.isArray(json) ? json : (json.data || []);
          const dataTime = json.updatedAt ? new Date(json.updatedAt) : new Date();
          renderDashboard(list, json.source || "cloud");
          updateHeaderTime(dataTime);
          if (mode === "history") updateArchiveStatus();
          else updateMarketStatus(dataTime);
        } catch (e) {
          console.error("[Process] Failed to process data:", e);
          renderError("處理錯誤", "數據解析過程發生異常");
        }
      }

      function renderDashboard(list, source) {
        try {
          if (source === "mock") {
              statusBanner.innerHTML = `<div class="bg-amber-50 border border-amber-100 p-3 rounded-xl text-xs text-amber-700 flex items-center justify-center gap-2"><i class="fas fa-info-circle"></i><span>目前顯示模擬數據。</span></div>`;
              statusBanner.classList.remove("hidden");
          } else statusBanner.classList.add("hidden");

          if (list.length === 0) {
              container.innerHTML = '<div class="p-12 text-center text-slate-300">NO DATA FOUND</div>';
              return;
          }

          let html = `<div class="overflow-x-auto"><table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 border-b border-slate-200 text-[10px] uppercase text-slate-400 font-black tracking-widest">
              <tr>
                <th class="pl-4 md:pl-6 py-4 w-10 text-center">#</th>
                <th class="px-3 md:px-4 py-4">Security / Time</th>
                <th class="px-3 md:px-4 py-4 text-right">Last Price</th>
                <th class="px-3 md:px-4 py-4 text-right">Change</th>
                <th class="px-3 md:px-4 py-4 text-right hidden sm:table-cell">Volume</th>
                <th class="px-3 md:px-4 py-4 text-center w-12">Action</th>
              </tr>
            </thead><tbody class="divide-y divide-slate-50">`;

          html += list.map((item, index) => {
            const rank = index + 1;
            const changeStr = (item.change || "").toString().replace(/[＋▲+]/g, "").replace(/[－▼-]/g, "-");
            const changeVal = parseFloat(changeStr) || 0;
            const isUp = (item.change || "").toString().includes("▲") || changeVal > 0;
            const isDown = (item.change || "").toString().includes("▼") || changeVal < 0;
            const pColor = isUp ? "text-red-500" : (isDown ? "text-green-600" : "text-slate-900");
            const cBg = isUp ? "bg-red-50 text-red-600" : (isDown ? "bg-green-50 text-green-600" : "bg-slate-100 text-slate-500");
            const lastClose = (item.price - changeVal).toFixed(2);

            return `<tr class="table-row-hover group" onclick="window.location.href='cb-calculator.html?code=${item.code}&autoSearch=true'">
              <td class="pl-4 md:pl-6 py-5"><div class="rank-dot top-${rank <= 3 ? rank : 'normal'} mx-auto">${rank}</div></td>
              <td class="px-3 md:px-4 py-5">
                <div class="flex flex-col"><span class="font-black text-slate-700 text-sm">${item.name}</span>
                <div class="flex items-center gap-2 mt-0.5"><span class="mono text-[10px] font-bold text-slate-400">${item.code}</span><span class="text-[9px] text-slate-300 font-bold bg-slate-50 px-1 rounded">${item.time || "--:--"}</span></div></div>
              </td>
              <td class="px-3 md:px-4 py-5 text-right">
                <div class="flex flex-col items-end">
                  <span class="mono font-black text-base ${pColor}">${parseFloat(item.price).toFixed(2)}</span>
                  <div class="flex items-center gap-1.5 mt-0.5">
                    <span class="text-[9px] font-black text-red-400">${item.high || '--'}</span>
                    <span class="text-[9px] font-black text-slate-200">/</span>
                    <span class="text-[9px] font-black text-green-400">${item.low || '--'}</span>
                  </div>
                </div>
              </td>
              <td class="px-3 md:px-4 py-5 text-right">
                <div class="flex flex-col items-end gap-1">
                  <span class="${pColor} text-[11px] font-black leading-none">${isUp?'▲':(isDown?'▼':'')} ${Math.abs(changeVal).toFixed(2)}</span>
                  <span class="px-1.5 py-0.5 rounded text-[10px] mono font-black ${cBg}">${item.changePercent || "--"}</span>
                </div>
              </td>
              <td class="px-3 md:px-4 py-5 text-right hidden sm:table-cell">
                <div class="flex flex-col items-end">
                  <span class="mono text-sm font-black text-slate-600">${parseInt(item.volume).toLocaleString()}</span>
                  <span class="text-[9px] text-slate-300 font-black uppercase tracking-tighter">VOL</span>
                </div>
              </td>
              <td class="pr-4 md:pr-6 py-5 text-center"><button class="w-8 h-8 rounded-full bg-slate-50 group-hover:bg-indigo-600 group-hover:text-white text-slate-300 flex items-center justify-center transition-all shadow-sm"><i class="fas fa-calculator text-[10px]"></i></button></td>
            </tr>`;
          }).join("");
          container.innerHTML = html + "</tbody></table></div>";
        } catch (e) {
          console.error("[Render] Dashboard failed:", e);
          renderError("渲染錯誤", "無法生成榜單內容");
        }
      }

      // Utils
      function updateLoadingState(s) { const b = document.getElementById("refreshBtn"); if (b) s ? b.querySelector("i").classList.add("fa-spin") : b.querySelector("i").classList.remove("fa-spin"); }
      function renderError(t, m) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-[300px] text-slate-400"><i class="fas fa-exclamation-circle fa-2x mb-4 text-slate-200"></i><h3 class="font-bold text-slate-600">${t}</h3><p class="text-xs mt-1">${m}</p></div>`; }
      function updateHeaderTime(d) {
        updateTimeEl.textContent = d.toLocaleTimeString("en-GB", { hour12: false });
        const days = ["日","一","二","三","四","五","六"];
        dateDisplay.textContent = `${d.getFullYear().toString().slice(-2)}/${(d.getMonth()+1).toString().padStart(2,"0")}/${d.getDate().toString().padStart(2,"0")}(${days[d.getDay()]})`;
      }
      function updateMarketStatus(d) {
        const isT = d.getDay()!==0 && d.getDay()!==6 && (d.getHours()*60+d.getMinutes()>=540 && d.getHours()*60+d.getMinutes()<=815);
        marketStatusPill.className = `status-pill ${isT?'market-open':'market-closed'}`;
        marketStatusPill.innerHTML = isT?'<i class="fas fa-circle text-[6px] animate-pulse"></i> LIVE DATA':'<i class="fas fa-moon text-[10px]"></i> LAST CLOSE';
      }
      function updateArchiveStatus() {
        marketStatusPill.className="status-pill bg-slate-100 text-slate-500";
        marketStatusPill.innerHTML='<i class="fas fa-archive text-[10px]"></i> HISTORY';
      }

      window.goToDate = (o) => {
        const currentText = dateDisplay.textContent.split('(')[0]; // e.g. "26/01/24"
        const [yy, mm, dd] = currentText.split('/').map(Number);
        const d = new Date(2000 + yy, mm - 1, dd);
        d.setDate(d.getDate() + o);
        const target = d.toISOString().split('T')[0];
        const today = new Date().toISOString().split('T')[0];
        window.location.href = target >= today ? "hot-cb.html" : `hot-cb.html?date=${target}`;
      };

      // Initialization
      const urlParams = new URLSearchParams(window.location.search);
      const queryDate = urlParams.get("date");
      if (queryDate) fetchHistoryCB(queryDate); else fetchHotCB();
    </script>
  </body>
</html>
