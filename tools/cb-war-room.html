<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market Terminal | CB 戰情室</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Financial Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <style>
      :root {
        --brand-slate: #0f172a;
        --brand-indigo: #4f46e5;
        --market-up: #ef4444;
        --market-down: #22c55e;
        --bg-main: #f8fafc;
      }
      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        background-color: var(--bg-main);
      }
      .mono {
        font-family: "JetBrains Mono", monospace;
      }
      .premium-card {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }
      .table-row-hover {
        transition: all 0.15s ease;
        cursor: pointer;
      }
      .table-row-hover:hover {
        background-color: #f1f5f9;
      }
      .rank-dot {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 800;
        border-radius: 6px;
        background: #f1f5f9;
        color: #64748b;
      }
      .rank-dot.top-1 {
        background: #fee2e2;
        color: #ef4444;
        border: 1px solid #fecaca;
      }
      .rank-dot.top-2 {
        background: #ffedd5;
        color: #f97316;
        border: 1px solid #fed7aa;
      }
      .rank-dot.top-3 {
        background: #fef9c3;
        color: #ca8a04;
        border: 1px solid #fef08a;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 600;
      }
      .market-open {
        background: #dcfce7;
        color: #15803d;
      }
      .market-closed {
        background: #f1f5f9;
        color: #475569;
      }
      @keyframes pulse-soft {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .animate-pulse-soft {
        animation: pulse-soft 2s infinite ease-in-out;
      }

      /* Tab Styles */
      .tab-btn {
        padding: 12px 24px;
        font-size: 13px;
        font-weight: 800;
        color: #94a3b8;
        transition: all 0.2s ease;
        border-bottom: 2px solid transparent;
      }
      .tab-btn.active {
        color: var(--brand-indigo);
        border-bottom-color: var(--brand-indigo);
      }
      .tab-btn:hover:not(.active) {
        color: #64748b;
        background: rgba(241, 245, 249, 0.5);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }

      /* Live Feedback Animations */
      @keyframes price-up {
        0% {
          background-color: rgba(239, 68, 68, 0.2);
        }
        100% {
          background-color: transparent;
        }
      }
      @keyframes price-down {
        0% {
          background-color: rgba(34, 197, 94, 0.2);
        }
        100% {
          background-color: transparent;
        }
      }
      .flash-up {
        animation: price-up 1s ease-out;
      }
      .flash-down {
        animation: price-down 1s ease-out;
      }

      .progress-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: var(--brand-indigo);
        transition: width 1s linear;
      }

      /* Signal Widget (Phase 3) */
      .signal-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }
      .signal-good {
        background-color: #22c55e;
        box-shadow: 0 0 5px rgba(34, 197, 94, 0.4);
      }
      .signal-fair {
        background-color: #eab308;
      }
      .signal-poor {
        background-color: #ef4444;
        animation: pulse-red 1s infinite;
      }

      @keyframes pulse-red {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Analysis Drawer */
      #analysisDrawer {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-width: 480px;
        background: white;
        z-index: 100;
        box-shadow: -20px 0 50px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
      }
      #analysisDrawer.open {
        transform: translateX(0);
      }
      #drawerOverlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(4px);
        z-index: 90;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      #drawerOverlay.show {
        opacity: 1;
        pointer-events: auto;
      }

      .drawer-header {
        padding: 24px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .drawer-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }

      .metric-small {
        background: #f8fafc;
        border: 1px solid #f1f5f9;
        padding: 12px;
        border-radius: 12px;
      }
      .metric-label {
        font-size: 10px;
        font-weight: 800;
        color: #94a3b8;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .metric-value {
        font-family: "JetBrains Mono", monospace;
        font-weight: 800;
        color: #1e293b;
        font-size: 16px;
      }

      /* Staggered Animations for Drawer Content */
      @keyframes slideInContent {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #analysisDrawer.open .stagger-entry {
        animation: slideInContent 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .stagger-entry {
        opacity: 0;
      } /* Initial state hidden */
      .delay-1 {
        animation-delay: 0.1s !important;
      }
      .delay-2 {
        animation-delay: 0.2s !important;
      }
      .delay-3 {
        animation-delay: 0.3s !important;
      }
      .delay-4 {
        animation-delay: 0.4s !important;
      }
    </style>
  </head>
  <body class="min-h-screen text-slate-900">
    <!-- Progress Indicator (Top Sticky) -->
    <div
      class="fixed top-0 left-0 w-full h-[2px] z-50 bg-slate-100 overflow-hidden"
    >
      <div
        id="topProgressBar"
        class="h-full bg-indigo-500 transition-all duration-1000 ease-linear"
        style="width: 0%"
      ></div>
    </div>

    <div class="max-w-[1200px] mx-auto p-4 md:p-8">
      <!-- Top Bar -->
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <a
            href="cb-calculator.html"
            class="flex items-center gap-2 text-slate-600 hover:text-slate-900 font-bold text-sm"
          >
            <i class="fas fa-arrow-left"></i><span>計算機</span>
          </a>
          <div class="h-4 w-[1px] bg-slate-200"></div>
          <span id="marketStatus" class="status-pill market-closed">
            <i class="fas fa-circle text-[6px] animate-pulse-soft"></i>載入中...
          </span>
          <!-- Network Signal Widget -->
          <div
            id="signalWidget"
            class="hidden flex items-center gap-1.5 px-2 py-1 bg-slate-50 border border-slate-100 rounded-full cursor-help"
            title="API Latency"
          >
            <div id="signalDot" class="signal-dot signal-good"></div>
            <span
              id="signalText"
              class="text-[9px] font-bold text-slate-400 mono"
              >--ms</span
            >
          </div>
        </div>
        <div class="flex items-center gap-3">
          <!-- Auth Button (Phase 3) -->
          <button
            id="authBtn"
            class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:bg-slate-100 hover:text-indigo-600 border border-transparent hover:border-slate-200 transition-all"
            onclick="loginWithGoogle()"
            title="登入"
          >
            <i class="fas fa-user-circle text-lg"></i>
          </button>
          <button
            onclick="fetchHotCB()"
            id="refreshBtn"
            class="p-2 text-slate-400 hover:text-indigo-600 transition-colors"
          >
            <i class="fas fa-sync-alt"></i>
          </button>
          <a
            href="/me/?booted=true"
            class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:bg-slate-100 border border-transparent hover:border-slate-200"
          >
            <i class="fas fa-house-chimney text-sm"></i>
          </a>
        </div>
      </div>

      <div class="mb-10">
        <h1
          class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-800 flex items-center gap-3 flex-wrap"
        >
          CB 戰情室
          <!-- Date Navigator UI -->
          <div class="relative group ml-2 flex items-center gap-2">
            <button
              onclick="SmartDateNavigator.prevDay()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 transition-colors"
            >
              <i class="fas fa-chevron-left text-xs"></i>
            </button>

            <div
              class="flex items-center gap-2 cursor-pointer bg-slate-50 hover:bg-slate-100 px-3 py-1.5 rounded-xl border border-transparent hover:border-slate-200 transition-all"
              onclick="document.getElementById('datePicker').showPicker()"
            >
              <i class="far fa-calendar-alt text-slate-400"></i>
              <span
                class="text-slate-600 text-lg font-bold mono"
                id="dateDisplay"
                >--/--/--</span
              >
              <input
                type="date"
                id="datePicker"
                class="absolute opacity-0 w-0 h-0 pointer-events-none"
                onchange="SmartDateNavigator.jumpToDate(this.value)"
              />
            </div>

            <button
              onclick="SmartDateNavigator.nextDay()"
              id="nextDayBtn"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
            >
              <i class="fas fa-chevron-right text-xs"></i>
            </button>
          </div>
        </h1>
        <div
          class="flex flex-wrap items-center gap-x-6 gap-y-2 mt-2 text-xs text-slate-500 font-medium"
        >
          <div class="flex items-center gap-1.5">
            <i class="far fa-clock"></i> 最後更新:
            <span id="updateTime" class="mono text-slate-700">--:--:--</span>
          </div>
          <div
            id="historicalBadge"
            class="hidden flex items-center gap-1.5 px-2 py-0.5 bg-amber-50 text-amber-600 border border-amber-100 rounded-md"
          >
            <i class="fas fa-history"></i> 歷史回顧模式
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div
        class="flex items-center gap-2 border-b border-slate-200 mb-8 overflow-x-auto no-scrollbar"
      >
        <button
          onclick="switchTab('pulse')"
          id="tab-pulse"
          class="tab-btn active flex items-center gap-2 whitespace-nowrap"
        >
          <i class="fas fa-chart-line text-xs"></i> 市場熱門
        </button>
        <button
          onclick="switchTab('watchlist')"
          id="tab-watchlist"
          class="tab-btn flex items-center gap-2 whitespace-nowrap"
        >
          <i class="fas fa-star text-xs"></i> 我的追蹤
        </button>
      </div>

      <!-- Market Pulse Content -->
      <div id="content-pulse" class="tab-content active">
        <div id="statusBanner" class="mb-6 hidden"></div>
        <div class="premium-card rounded-2xl overflow-hidden border-slate-200">
          <div id="htListContainer" class="min-h-[400px]">
            <div class="p-8 space-y-4">
              <div class="h-8 bg-slate-50 rounded animate-pulse w-full"></div>
              <div class="h-12 bg-slate-50 rounded animate-pulse w-full"></div>
              <div class="h-12 bg-slate-50 rounded animate-pulse w-full"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Watchlist Content -->
      <div id="content-watchlist" class="tab-content">
        <!-- Dashboard Summary -->
        <div
          id="watchlistHero"
          class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"
        >
          <!-- Dynamic Hero Cards will go here (Top 3) -->
        </div>

        <div class="mb-10">
          <div class="flex items-center justify-between mb-6 px-1">
            <div>
              <h2
                class="text-sm font-black text-slate-800 uppercase tracking-widest flex items-center gap-2"
              >
                <i class="fas fa-satellite-dish text-indigo-500"></i>
                自選標的監測
              </h2>
              <p
                class="text-[10px] text-slate-400 font-bold mt-1"
                id="watchlistStats"
              >
                偵測中...
              </p>
            </div>
            <button
              onclick="addNewGroup()"
              class="px-3 py-1.5 rounded-lg border border-indigo-200 text-indigo-500 text-[10px] font-black hover:bg-indigo-50 transition-all flex items-center gap-2"
            >
              <i class="fas fa-plus-circle"></i> ADD GROUP
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div
              class="premium-card p-5 rounded-2xl border-indigo-100 bg-gradient-to-br from-white to-indigo-50/50"
            >
              <div
                class="text-[10px] font-black text-slate-400 uppercase mb-4 px-1 tracking-widest"
              >
                新增追蹤
              </div>
              <div class="flex gap-2.5">
                <input
                  type="text"
                  id="newCbInput"
                  placeholder="代號 (例: 15142)"
                  class="flex-grow border border-slate-200 rounded-xl px-4 py-3 text-sm font-black outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-400 transition-all mono uppercase"
                />
                <button
                  onclick="addTrackedCB()"
                  id="addCbBtn"
                  class="w-12 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl flex items-center justify-center transition-all shadow-lg"
                >
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
            <div
              class="md:col-span-3 premium-card p-5 rounded-2xl border-slate-100 bg-slate-50/30"
            >
              <div
                class="text-[10px] font-black text-slate-400 uppercase mb-4 px-1 tracking-widest"
              >
                目前名單
              </div>
              <div id="trackedListContainer" class="flex flex-wrap gap-4">
                <div class="h-12 w-28 bg-white rounded-xl animate-pulse"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="mt-6 text-[11px] text-slate-400 flex justify-between items-center px-2"
      >
        <span>* 資料每 15 分鐘自動更新。不構成投資建議。</span>
        <span class="mono">Timboy v3.0.0 (SmartNav)</span>
      </div>
    </div>

    <!-- Analysis Drawer -->
    <div id="drawerOverlay" onclick="closeAnalysis()"></div>
    <div id="analysisDrawer">
      <div class="drawer-header bg-slate-50/50">
        <div>
          <div
            id="drawerBadge"
            class="text-xs font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full inline-block mb-1"
          >
            個股快篩
          </div>
          <h2 id="drawerTitle" class="text-xl font-black text-slate-800">
            標的分析
          </h2>
          <p
            id="drawerCode"
            class="text-[10px] mono font-bold text-slate-400 mt-0.5"
          >
            --
          </p>
        </div>
        <button
          onclick="closeAnalysis()"
          class="w-10 h-10 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 transition-colors"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="drawer-content space-y-6">
        <!-- Live Data Summary -->
        <div class="grid grid-cols-2 gap-3 stagger-entry delay-1">
          <div class="metric-small">
            <div class="metric-label">現價 (CB)</div>
            <div id="dCbPrice" class="metric-value">--</div>
          </div>
          <div class="metric-small">
            <div class="metric-label">現價 (股票)</div>
            <div id="dStockPrice" class="metric-value">--</div>
          </div>
        </div>

        <!-- (Refactored) Unified Analysis Card V10 -->
        <div
          id="dResultCard"
          class="premium-card p-0 rounded-2xl border-l-4 border-slate-200 transition-colors duration-300 shadow-sm overflow-hidden stagger-entry delay-2"
        >
          <!-- Top Section: Premium Rate -->
          <div class="p-6 pb-4">
            <div class="flex justify-between items-center mb-1">
              <h3
                class="text-[10px] font-black text-slate-400 uppercase tracking-widest opacity-80"
              >
                轉換溢價率
              </h3>
              <span
                class="px-1.5 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter bg-slate-100 text-slate-400 border border-slate-100/50"
                id="dPremiumStatus"
                >計算中</span
              >
            </div>
            <div class="flex items-baseline gap-2 mb-2">
              <span
                class="text-5xl font-black text-slate-800 tracking-tighter mono"
                id="dPremiumRate"
                >--%</span
              >
            </div>
            <p
              class="text-[10px] font-bold text-slate-400 opacity-60 leading-none"
              id="dPremiumDesc"
            >
              正在取得即時報價...
            </p>
          </div>

          <!-- Divider -->
          <div class="h-px bg-slate-100 mx-6"></div>

          <!-- Bottom Section: Metrics Grid -->
          <div
            class="grid grid-cols-2 gap-px bg-slate-100 border-t border-slate-100"
          >
            <!-- Conversion Value -->
            <div
              class="bg-white/60 p-5 group hover:bg-white transition-colors"
              title="每張可轉債換成股票後的價值"
            >
              <div
                class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center justify-between"
              >
                <span>轉換價值</span>
                <div
                  class="w-5 h-5 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:text-indigo-400 transition-colors"
                >
                  <i class="fas fa-coins text-[10px]"></i>
                </div>
              </div>
              <div
                class="text-2xl font-black text-slate-800 mono tracking-tight mb-1"
                id="dConvVal"
              >
                --
              </div>
              <div
                class="text-[10px] font-bold text-slate-400 flex items-center gap-1.5"
              >
                <i class="fas fa-layer-group text-[9px] opacity-70"></i>
                <span id="dSharesInfo" class="mono">-- 股/張</span>
              </div>
            </div>

            <!-- Parity (Upside) -->
            <div
              class="bg-white/60 p-5 group hover:bg-white transition-colors relative"
              title="與 CB 價格相等(平價)時的理論股價"
            >
              <div
                class="absolute left-0 top-4 bottom-4 w-px bg-slate-100/50"
              ></div>
              <div
                class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center justify-between"
              >
                <span>需上漲 (BE)</span>
                <div
                  class="w-5 h-5 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:text-amber-500 transition-colors"
                >
                  <i class="fas fa-bullseye text-[10px]"></i>
                </div>
              </div>
              <div
                class="text-2xl font-black text-slate-800 mono tracking-tight mb-1"
                id="dParityPrice"
              >
                --
              </div>
              <div
                class="text-[10px] font-bold text-slate-400 flex items-center gap-1.5"
              >
                <i class="fas fa-chart-line text-[9px] opacity-70"></i>
                <span id="dUpsideNeeded" class="mono">需上漲 --%</span>
              </div>
            </div>

            <!-- Conversion Price Input (Full Width) -->
            <div
              class="col-span-2 bg-white/60 p-5 group hover:bg-white transition-colors border-t border-slate-100 relative"
            >
              <div class="flex items-center justify-between">
                <label
                  for="dConvPriceInput"
                  class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"
                >
                  轉換價格
                  <span
                    class="text-[9px] text-indigo-400 bg-indigo-50 px-1.5 rounded ml-1"
                    >(可調整)</span
                  >
                </label>
                <div class="flex items-center gap-2">
                  <input
                    type="number"
                    id="dConvPriceInput"
                    step="0.01"
                    class="bg-white border invalid:border-red-300 border-slate-200 text-right px-3 py-1.5 rounded-lg mono text-lg font-black w-32 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 text-slate-700"
                  />
                  <button
                    onclick="saveAnalysisMeta()"
                    title="儲存至雲端中繼資料"
                    class="w-10 h-10 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white transition-all flex items-center justify-center border border-indigo-100"
                  >
                    <i class="fas fa-save"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart Section (Unified Widget) -->
        <div class="pt-4 stagger-entry delay-4" id="dChartSection">
          <div
            class="premium-card p-6 rounded-2xl relative min-h-[300px] border-slate-200"
          >
            <!-- Mount Point for Shared Widget -->
            <div id="dPremiumChartMount" class="w-full">
              <div
                class="flex flex-col items-center justify-center h-[200px] text-slate-300"
              >
                <div class="pulse-ring mb-2"><div class="pulse-dot"></div></div>
                <div
                  class="text-[10px] font-bold tracking-widest uppercase opacity-50"
                >
                  載入圖表引擎...
                </div>
              </div>
            </div>
          </div>
        </div>
        <p
          id="dChartNoData"
          class="text-center text-gray-400 text-sm py-8 hidden"
        >
          <i class="fas fa-database mr-2"></i>尚無歷史資料
        </p>

        <!-- Action Buttons -->
        <div class="pt-2 stagger-entry delay-4">
          <button
            onclick="
              window.open(
                'cb-calculator.html?code=' +
                  window.currentAnalysisCode +
                  '&autoSearch=true',
                '_blank',
              )
            "
            class="w-full py-4 text-xs font-black bg-white border border-slate-200 text-slate-400 rounded-xl hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
          >
            <i class="fas fa-external-link-alt"></i> 開啟進階計算機
          </button>
        </div>
      </div>
    </div>

    <!-- Unified Loader Overlay -->
    <div
      id="loader"
      class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/10 backdrop-blur-sm hidden"
    >
      <div class="flex flex-col items-center gap-4">
        <div
          class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-xl shadow-indigo-200 animate-bounce"
        >
          <i class="fas fa-bolt text-white"></i>
        </div>
        <div class="flex flex-col items-center">
          <span
            class="text-[10px] font-black text-indigo-500 uppercase tracking-[0.2em] mb-1"
            >Processing</span
          >
          <div class="h-1 w-24 bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-indigo-500 w-1/2 animate-pulse"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- 0. Core Utils (Global Scope) -->
    <script>
      // --- Smart Date Navigator ---
      class SmartDateNavigator {
        static formatDate(d) {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          return `${y}-${m}-${dd}`;
        }

        static isWeekend(d) {
          const day = d.getDay();
          return day === 0 || day === 6;
        }

        static getEffectiveDate(inputDate = new Date()) {
          const d = new Date(inputDate);
          // Avoid timezone issues by using local time logic
          // Loop back to Friday if Sat(6) or Sun(0)
          while (this.isWeekend(d)) {
            d.setDate(d.getDate() - 1);
          }
          return d;
        }

        static updateUI(targetDate) {
          const el = document.getElementById("dateDisplay");
          const picker = document.getElementById("datePicker");
          const nextBtn = document.getElementById("nextDayBtn");
          const days = ["日", "一", "二", "三", "四", "五", "六"];

          const y = targetDate.getFullYear();
          const m = String(targetDate.getMonth() + 1).padStart(2, "0");
          const d = String(targetDate.getDate()).padStart(2, "0");
          const dayName = days[targetDate.getDay()];

          // Display format: YYYY/MM/DD(Day)
          if (el)
            el.textContent = `${y.toString().slice(-2)}/${m}/${d}(${dayName})`;

          const iso = this.formatDate(targetDate);
          if (picker) picker.value = iso; // Sync picker internal state

          // Disable "Next Day" if target is today or future
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const target = new Date(targetDate);
          target.setHours(0, 0, 0, 0);

          if (target >= today) {
            if (nextBtn) {
              nextBtn.disabled = true;
              nextBtn.classList.add("opacity-30", "cursor-not-allowed");
            }
            const badge = document.getElementById("historicalBadge");
            if (badge) badge.classList.add("hidden");
          } else {
            if (nextBtn) {
              nextBtn.disabled = false;
              nextBtn.classList.remove("opacity-30", "cursor-not-allowed");
            }
            const badge = document.getElementById("historicalBadge");
            if (badge) badge.classList.remove("hidden");
          }

          window.currentDisplayDate = targetDate;
        }

        // Handlers
        static prevDay() {
          const current = window.currentDisplayDate || new Date();
          const prev = new Date(current);
          prev.setDate(prev.getDate() - 1);
          // Auto-skip weekend backwards
          while (this.isWeekend(prev)) {
            prev.setDate(prev.getDate() - 1);
          }
          this.loadDate(prev);
        }

        static nextDay() {
          const current = window.currentDisplayDate || new Date();
          const next = new Date(current);
          next.setDate(next.getDate() + 1);
          // Auto-skip weekend forwards
          while (this.isWeekend(next)) {
            next.setDate(next.getDate() + 1);
          }

          // Check future cap
          if (next > new Date()) return;
          this.loadDate(next);
        }

        static jumpToDate(isoStr) {
          if (!isoStr) return;
          const d = new Date(isoStr);
          // If user picks weekend, maybe warn or auto-adjust?
          // Implementation: Auto-adjust to Friday if weekend
          const effective = this.getEffectiveDate(d);
          if (effective.getTime() !== d.getTime()) {
            // Optional: toast('已自動調整至最近交易日')
            console.log("[DateNav] Adjusted weekend selection to Friday");
          }
          this.loadDate(effective);
        }

        static loadDate(date) {
          if (window.fetchHotCB) {
            window.fetchHotCB(date);
          } else {
            console.warn("fetchHotCB not ready yet");
          }
        }
      }
      window.SmartDateNavigator = SmartDateNavigator;
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collection,
        onSnapshot,
        setDoc,
        deleteDoc,
        serverTimestamp,
        query,
        where,
        getDocs,
        orderBy,
        limit,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        GoogleAuthProvider,
        signInWithPopup,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getAnalytics,
        logEvent,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
      import {
        onCLS,
        onINP,
        onLCP,
        onFCP,
        onTTFB,
      } from "https://unpkg.com/web-vitals@3/dist/web-vitals.attribution.js?module";
      import { CbPremiumHistoryChart } from "./components/CbPremiumHistoryChart.mjs";
      import { CbHistoryService } from "./components/CbHistoryService.mjs";

      window.CbPremiumHistoryChart = CbPremiumHistoryChart;
      window.CbHistoryService = CbHistoryService;

      const firebaseConfig = {
        apiKey: "AIzaSyB4VXQaa_bWldNrXfSARgK3w258fac9Fvg",
        authDomain: "my-landing-page-2ca68.firebaseapp.com",
        projectId: "my-landing-page-2ca68",
        storageBucket: "my-landing-page-2ca68.firebasestorage.app",
        messagingSenderId: "847051837050",
        appId: "1:847051837050:web:c5e2bc56252e0d3ab835c3",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      window.db = db;
      const auth = getAuth(app);

      // Initialize Analytics & Web Vitals
      let analytics = null;
      try {
        analytics = getAnalytics(app);
        console.log("[Analytics] Initialized for War Room");

        const sendToGA = ({ name, delta, id }) => {
          logEvent(analytics, "web_vitals", {
            event_category: "Web Vitals",
            event_action: name,
            event_value: Math.round(name === "CLS" ? delta * 1000 : delta),
            event_label: id,
            non_interaction: true,
          });
        };

        onCLS(sendToGA);
        onINP(sendToGA);
        onLCP(sendToGA);
        onFCP(sendToGA);
        onTTFB(sendToGA);
      } catch (e) {
        console.warn("[Analytics] Init failed:", e);
      }

      // --- 0. Global Error Protection ---
      window.onerror = function (msg, url, line, col, error) {
        if (
          msg.indexOf("RangeError") > -1 ||
          msg.indexOf("Invalid time value") > -1
        ) {
          console.error("[Guard] Suppressed RangeError:", msg);
          return true; // Stop error from bubbling
        }
        return false;
      };

      // --- 0. Global Error Recovery ---
      window.addEventListener("error", (e) => {
        if (
          e.message.includes("Invalid time value") ||
          e.message.includes("toISOString")
        ) {
          console.warn(
            "[Stability] Suppressed expected date error:",
            e.message,
          );
          e.preventDefault(); // Stop from breaking execution
        }
      });

      // Auth State
      let currentUser = null;
      let watchlistUnsubscribe = null;

      // DOM Elements
      const statusBanner = document.getElementById("statusBanner");
      const container = document.getElementById("htListContainer");
      const updateTimeEl = document.getElementById("updateTime");
      const dateDisplay = document.getElementById("dateDisplay");
      const marketStatusPill = document.getElementById("marketStatus");
      const trackedListContainer = document.getElementById(
        "trackedListContainer",
      );
      const newCbInput = document.getElementById("newCbInput");

      // --- 2. Robust Date Utils (Local-First) ---
      const formatDateLocal = (d) => {
        if (!d || isNaN(d.getTime())) d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      };

      const parseLocalDate = (str) => {
        if (
          !str ||
          str === "null" ||
          str === "NaN-NaN-NaN" ||
          str === "undefined"
        ) {
          return new Date();
        }
        try {
          const parts = str.split("-").map(Number);
          if (
            parts.length !== 3 ||
            isNaN(parts[0]) ||
            isNaN(parts[1]) ||
            isNaN(parts[2])
          ) {
            return new Date();
          }
          const d = new Date(parts[0], parts[1] - 1, parts[2]);
          return isNaN(d.getTime()) ? new Date() : d;
        } catch (e) {
          return new Date();
        }
      };

      // --- 2. Unified Initialization Logic ---
      // 3. Unified Bootstrap Function
      const bootstrap = () => {
        const todayStr = formatDateLocal(new Date());
        console.log(`[Init] Bootstrap v3.1.0 (SmartNav): today=${todayStr}`);

        // A. Clean URL if needed (remove legacy query params)
        if (window.location.search) {
          console.log("[Init] Cleaning legacy URL query params...");
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname,
          );
        }

        // B. Determine Effective Date (Skip weekends)
        const initialDate = SmartDateNavigator.getEffectiveDate(new Date());

        // C. Always Fetch Hot CB (Live Data or Fallback)
        // Note: fetchHotCB will handle UI updates
        fetchHotCB(initialDate);
      };
      window.initBootstrap = bootstrap;

      // Tabs
      window.switchTab = (tabId) => {
        if (tabId === "watchlist" && !currentUser) {
          showAuthDeniedMask();
          return;
        }

        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`tab-${tabId}`).classList.add("active");
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document.getElementById(`content-${tabId}`).classList.add("active");
      };

      // Phase 3: Global State
      window.lastDataPool = null;
      window.globalCbDatabase = null;
      let countdownTimer = null;
      const UPDATE_INTERVAL = 60; // seconds
      let isHeroCollapsed =
        localStorage.getItem("cb_hero_collapsed") === "true";

      // Timer Logic
      function startUpdateTimer() {
        if (countdownTimer) clearInterval(countdownTimer);
        let seconds = UPDATE_INTERVAL;
        const bar = document.getElementById("topProgressBar");

        countdownTimer = setInterval(() => {
          seconds--;
          const pct = ((UPDATE_INTERVAL - seconds) / UPDATE_INTERVAL) * 100;
          bar.style.width = `${pct}%`;

          if (seconds <= 0) {
            fetchHotCB();
            seconds = UPDATE_INTERVAL;
          }
        }, 1000);
      }

      // Watchlist
      let virtualCategories = []; // Local empty groups
      window.lastKnownItems = [];

      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        console.log("Auth State Changed:", user ? "LoggedIn" : "LoggedOut");

        // Update Auth Button UI
        updateAuthUI(user);

        if (user) {
          // Subscribe to data
          if (watchlistUnsubscribe) watchlistUnsubscribe();
          watchlistUnsubscribe = onSnapshot(
            collection(db, "cb_history"),
            (snapshot) => {
              window.lastKnownItems = snapshot.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              renderTrackedList(window.lastKnownItems);
              updateWatchlistStats(window.lastKnownItems);
              if (window.lastDataPool)
                renderWatchlistHero(window.lastDataPool, window.lastKnownItems);
            },
          );
          // Hide mask if open
          const mask = document.getElementById("authDeniedMask");
          if (mask) mask.remove();
        } else {
          // Unsubscribe and clear
          if (watchlistUnsubscribe) {
            watchlistUnsubscribe();
            watchlistUnsubscribe = null;
          }
          window.lastKnownItems = [];
          renderTrackedList([]);
          updateWatchlistStats([]);
          if (lastDataPool) renderWatchlistHero(lastDataPool, []);
        }
      });

      function showAuthDeniedMask() {
        if (document.getElementById("authDeniedMask")) return;

        const mask = document.createElement("div");
        mask.id = "authDeniedMask";
        mask.className =
          "fixed inset-0 z-[110] flex items-center justify-center p-6";
        mask.innerHTML = `
          <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
          <div class="relative premium-card max-w-sm w-full p-8 rounded-3xl text-center shadow-2xl border-indigo-500/30 animate-fadeIn">
            <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600">
              <i class="fas fa-lock text-xl"></i>
            </div>
            <h2 class="text-xl font-black text-slate-800 mb-2 uppercase tracking-tight">Access Denied</h2>
            <p class="text-xs font-bold text-slate-400 mb-8 leading-relaxed">
              「我的追蹤」頁籤包含私有資產數據現，請先開啟 TimBoy 主系統進行身分驗證。
            </p>
            <div class="space-y-3">
              <button onclick="loginWithGoogle()" class="block w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-xs font-black shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2">
                <i class="fab fa-google"></i> 使用 Google 帳號登入
              </button>
              <button onclick="document.getElementById('authDeniedMask').remove(); switchTab('pulse')" class="block w-full py-4 text-slate-400 hover:text-slate-600 text-[10px] font-black uppercase tracking-widest">
                返回市場熱門
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(mask);
      }

      window.addNewGroup = () => {
        const name = prompt("請輸入新分組名稱 (例如: 散熱, 電源供應器):");
        if (name && name.trim()) {
          const groupName = name.trim();
          if (!virtualCategories.includes(groupName)) {
            virtualCategories.push(groupName);
            renderTrackedList(lastKnownItems);
          }
        }
      };

      // In-Place Login
      window.loginWithGoogle = async () => {
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error("Login failed", error);
          alert("登入失敗: " + error.message);
        }
      };

      function updateAuthUI(user) {
        const btn = document.getElementById("authBtn");
        if (!btn) {
          console.warn("AuthBtn not found in DOM");
          return;
        }

        if (user) {
          const avatar = user.photoURL
            ? `<img src="${user.photoURL}" class="w-6 h-6 rounded-full border border-indigo-200">`
            : `<i class="fas fa-user-check text-indigo-600 text-lg"></i>`;
          btn.innerHTML = avatar;
          btn.onclick = logoutUser;
          btn.title = `已登入: ${user.displayName || user.email}`;
          btn.classList.remove("text-slate-400", "hover:text-indigo-600");
          // Keep styling consistent or leave as is if image
        } else {
          btn.innerHTML = '<i class="fas fa-user-circle text-lg"></i>';
          btn.onclick = loginWithGoogle;
          btn.title = "登入 Google 帳號";
          btn.classList.add("text-slate-400", "hover:text-indigo-600");
        }
      }

      window.logoutUser = async () => {
        if (confirm("確定要登出戰情室嗎？")) {
          try {
            await signOut(auth);
            window.switchTab("pulse"); // Force switch back to public tab
          } catch (e) {
            console.error("Logout failed", e);
          }
        }
      };

      function updateWatchlistStats(items) {
        const stats = document.getElementById("watchlistStats");
        const total = items.length;
        const syncing = items.filter(
          (i) => !i.name || i.name === "待同步...",
        ).length;
        stats.innerHTML = `<i class="fas fa-microchip"></i> ACTIVE: ${total} | SYNCING: ${syncing} | CLOUD ENGINE V2`;
      }

      window.toggleHero = () => {
        isHeroCollapsed = !isHeroCollapsed;
        localStorage.setItem("cb_hero_collapsed", isHeroCollapsed);
        const watchlist = Array.from(
          document.querySelectorAll("#trackedListContainer .mono"),
        ).map((el) => ({ id: el.textContent }));
        if (lastDataPool) renderWatchlistHero(lastDataPool, watchlist);
      };

      function renderWatchlistHero(list, watchlist) {
        const hero = document.getElementById("watchlistHero");
        const top3 = list.slice(0, 3);

        const cardsHtml = top3
          .map((item) => {
            const isTracked = watchlist.some(
              (w) => w.id === item.code || w.code === item.code,
            );
            const changeVal =
              parseFloat(
                (item.change || "0").replace(/[▲▼+]/g, "").replace(/[－]/, "-"),
              ) || 0;
            const pColor =
              changeVal > 0
                ? "text-red-500"
                : changeVal < 0
                  ? "text-green-600"
                  : "text-slate-400";

            return `
                <div class="premium-card p-3 rounded-2xl border-slate-100 flex flex-col gap-1.5 hover:border-indigo-200 transition-all cursor-grab active:cursor-grabbing group" 
                     draggable="true" 
                     ondragstart="handleDragStart(event, '${item.code}')"
                     onclick="openAnalysis('${item.code}')">
                    <div class="flex justify-between items-center">
                         <span class="mono text-[8px] font-black text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100/50">${item.code}</span>
                        <div class="w-5 h-5 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-indigo-50 group-hover:text-indigo-500 transition-colors">
                            <i class="fas ${isTracked ? "fa-star text-amber-400" : "fa-plus"} text-[8px]"></i>
                        </div>
                    </div>
                    <h3 class="text-sm font-black text-slate-800 truncate">${item.name}</h3>
                    <div class="flex items-center justify-between mt-0.5">
                        <span class="mono font-black text-lg ${pColor}">${parseFloat(item.price).toFixed(2)}</span>
                        <div class="text-right">
                            <div class="${pColor} text-[10px] font-black leading-none">${changeVal > 0 ? "▲" : changeVal < 0 ? "▼" : ""} ${Math.abs(changeVal).toFixed(2)}</div>
                            <div class="text-[8px] text-slate-400 font-bold mt-1">${item.changePercent}</div>
                        </div>
                    </div>
                </div>
              `;
          })
          .join("");

        hero.innerHTML = `
          <div class="w-full">
            <div class="flex items-center gap-2 mb-3 cursor-pointer group/title" onclick="toggleHero()">
              <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest bg-indigo-50 px-2 py-0.5 rounded">Market Pulse / 市場熱點</span>
              <div class="h-[1px] flex-grow bg-slate-100/80"></div>
              <button class="w-6 h-6 rounded-full flex items-center justify-center text-slate-300 group-hover/title:text-indigo-500 transition-all ${isHeroCollapsed ? "-rotate-90" : ""}">
                <i class="fas fa-chevron-down text-[10px]"></i>
              </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 overflow-hidden transition-all duration-300" style="max-height: ${isHeroCollapsed ? "0px" : "400px"}; opacity: ${isHeroCollapsed ? "0" : "1"}; margin-top: ${isHeroCollapsed ? "-8px" : "0px"}">
              ${cardsHtml}
            </div>
          </div>
        `;
      }

      function renderTrackedList(items) {
        if (items.length === 0 && virtualCategories.length === 0) {
          trackedListContainer.innerHTML =
            '<div class="text-xs text-slate-300 italic px-2">尚未追蹤任何標的</div>';
          return;
        }

        // Group by category
        const groups = items.reduce((acc, item) => {
          const cat = item.category || "未分類 (UNCATEGORIZED)";
          if (!acc[cat]) acc[cat] = [];
          acc[cat].push(item);
          return acc;
        }, {});

        // Merge Virtual Groups
        virtualCategories.forEach((v) => {
          if (!groups[v]) groups[v] = [];
        });

        // Sort categories (Uncategorized at bottom)
        const sortedCats = Object.keys(groups).sort((a, b) => {
          if (a.includes("未分類")) return 1;
          if (b.includes("未分類")) return -1;
          return a.localeCompare(b);
        });

        trackedListContainer.innerHTML = sortedCats
          .map((cat) => {
            const groupItems = groups[cat];
            const isEmpty = groupItems.length === 0;

            return `
          <div class="w-full mb-6 last:mb-0 category-drop-zone transition-all duration-200 rounded-xl p-1" 
               ondragover="handleDragOver(event)" 
               ondragleave="handleDragLeave(event)"
               ondrop="handleDrop(event, '${cat}')">
            <div class="flex items-center gap-2 mb-3 px-1">
                <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest bg-indigo-50 px-2 py-0.5 rounded">${cat}</span>
                <div class="h-[1px] flex-grow bg-slate-100"></div>
                <span class="text-[9px] font-bold text-slate-300 mono">${groupItems.length}</span>
            </div>
            <div class="flex flex-wrap gap-4">
              ${
                isEmpty
                  ? `<div class="w-full py-4 border-2 border-dashed border-slate-100 rounded-xl flex items-center justify-center text-[10px] font-bold text-slate-300 uppercase tracking-widest">拖拉標的至此處加入</div>`
                  : groupItems
                      .map(
                        (item) => `
                <div class="group flex items-center gap-2.5 bg-white border border-slate-200 hover:border-indigo-200 rounded-xl pl-3 pr-2 py-2.5 transition-all shadow-sm cursor-grab active:cursor-grabbing" 
                     draggable="true" 
                     ondragstart="handleDragStart(event, '${item.id}')"
                     onclick="openAnalysis('${item.id}')">
                  <div class="flex flex-col">
                    <div class="flex items-center gap-1.5">
                        <span class="mono text-[11px] font-black text-slate-700">${item.id}</span>
                        <button onclick="event.stopPropagation(); editCategory('${item.id}', '${item.category || ""}')" class="text-[8px] text-slate-300 hover:text-indigo-500 opacity-0 group-hover:opacity-100 transition-all"><i class="fas fa-tag"></i></button>
                    </div>
                    <span class="text-[9px] font-bold text-slate-400 truncate w-16">${item.name || "待同步..."}</span>
                  </div>
                  <div class="flex flex-col items-end px-1 border-l border-slate-50 ml-1">
                      <span class="text-[9px] font-black text-slate-300 uppercase">Status</span>
                      <span class="text-[10px] font-black text-indigo-500 mono">ACTIVE</span>
                  </div>
                  <button onclick="event.stopPropagation(); deleteTrackedCB('${item.id}')" class="w-6 h-6 rounded-lg flex items-center justify-center text-slate-200 hover:text-red-500 hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-times text-[10px]"></i></button>
                </div>
              `,
                      )
                      .join("")
              }
            </div>
          </div>
        `;
          })
          .join("");
      }

      // Drag & Drop Handlers
      window.handleDragStart = (e, id) => {
        e.dataTransfer.setData("text/plain", id);
        e.dataTransfer.effectAllowed = "move";
        // Ghost effect helper
        setTimeout(() => (e.target.style.opacity = "0.4"), 0);
      };

      document.addEventListener("dragend", (e) => {
        if (e.target.draggable) e.target.style.opacity = "1";
      });

      window.handleDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        const zone = e.currentTarget;
        zone.classList.add(
          "bg-indigo-50/50",
          "ring-2",
          "ring-indigo-100",
          "ring-inset",
        );
      };

      window.handleDragLeave = (e) => {
        const zone = e.currentTarget;
        zone.classList.remove(
          "bg-indigo-50/50",
          "ring-2",
          "ring-indigo-100",
          "ring-inset",
        );
      };

      window.handleDrop = async (e, category) => {
        e.preventDefault();
        window.handleDragLeave(e);
        const id = e.dataTransfer.getData("text/plain");
        if (!id) return;

        try {
          // Fetch existing metadata to preserve name/prices if possible
          let metadata = { category, updatedAt: serverTimestamp() };
          const docRef = doc(db, "cb_history", id);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            // Keep existing fields, just update category
            // No operation needed as merge:true will handle it
          } else {
            // Try to find in pool for name
            const poolItem = window.lastDataPool?.find((i) => i.code === id);
            if (poolItem) {
              metadata.name = poolItem.name;
              metadata.underlyingCode = poolItem.underlyingCode || "";
              metadata.conversionPrice = poolItem.conversionPrice || 0;
            }
          }

          await setDoc(docRef, metadata, { merge: true });
          virtualCategories = virtualCategories.filter((v) => v !== category);
          console.log(`[D&D] Moved ${id} to ${category}`);
        } catch (e) {
          console.error("Failed to update category via D&D", e);
        }
      };

      window.editCategory = async (id, current) => {
        const newCat = prompt(
          `為 ${id} 輸入類別內容 (例如: 半導體, AI, 防禦型):`,
          current,
        );
        if (newCat === null) return;
        try {
          await setDoc(
            doc(db, "cb_history", id),
            { category: newCat.trim(), updatedAt: serverTimestamp() },
            { merge: true },
          );
        } catch (e) {
          alert("更新類別失敗");
        }
      };

      window.addTrackedCB = async () => {
        const input = document.getElementById("newCbInput");
        const code = input.value.trim().toUpperCase();
        if (!code || code.length < 5) {
          alert("請輸入正確的可轉債代號 (例如: 15142)");
          return;
        }

        // Check if already in watchlist
        if (lastKnownItems.some((i) => i.id === code)) {
          alert("此標的已在追蹤名單中");
          return;
        }

        try {
          const docRef = doc(db, "cb_history", code);
          const docSnap = await getDoc(docRef);

          let metadata = {
            addedAt: serverTimestamp(),
            category: "未分類 (UNCATEGORIZED)",
          };

          if (docSnap.exists()) {
            // Already has metadata, just ensure addedAt/category?
            // Actually if it exists in cb_history but not in watchlist (which is just live listener on cb_history),
            // that means... wait, watchlist IS the listener on cb_history for ALL items.
            // If it's in cb_history, it should be in watchlist.
            // Unless we filter? Currently renderTrackedList shows all.
            // So if docSnap exists, it SHOULD be in lastKnownItems.
            // Maybe it's a "soft delete" or just missing category?
            // We'll update it anyway.
          } else {
            // New to DB. Try to fetch from pool or generic.
            const poolItem = window.lastDataPool?.find((i) => i.code === code);
            if (poolItem) {
              metadata.name = poolItem.name;
              metadata.underlyingCode = poolItem.underlyingCode;
              metadata.conversionPrice = poolItem.conversionPrice;
            }
          }

          await setDoc(docRef, metadata, { merge: true });
          input.value = "";
          console.log(`[Watchlist] Added ${code}`);
        } catch (e) {
          console.error("Failed to add tracked CB", e);
          alert("新增失敗，請檢查權限或網路連線");
        }
      };

      window.deleteTrackedCB = async (id) => {
        // [Auth Rollback]
        // if (!currentUser) { showAuthDeniedMask(); return; }

        if (!confirm(`確定要取消追蹤 ${id} 嗎?`)) return;

        try {
          await deleteDoc(doc(db, "cb_history", id));
          console.log(`[Watchlist] Deleted ${id}`);
        } catch (e) {
          console.error("Failed to delete tracked CB", e);
          alert("刪除失敗");
        }
      };

      // Fetching Logic with Cloud Fallback
      async function loadFromCloud(snapshotId) {
        console.log(
          `[Cloud] Attempting fallback for: ${snapshotId || "latest"}`,
        );
        try {
          const metaRef = doc(db, "hot_cb_meta", "latest");
          const metaSnap = await getDoc(metaRef);
          const docId = snapshotId || metaSnap.data()?.lastDateId;

          if (!docId) {
            console.error("[Cloud] No document ID found in meta");
            return null;
          }

          console.log(`[Cloud] Fetching snapshot: ${docId}`);
          const snap = await getDoc(doc(db, "hot_cb_snapshots", docId));
          if (!snap.exists()) {
            console.error("[Cloud] Snapshot not found:", docId);
            return null;
          }

          // Strict Weekend Block: Never return data for Sat/Sun from cloud
          const d = parseLocalDate(docId);
          if (d.getDay() === 0 || d.getDay() === 6) {
            console.warn("[Cloud] Blocked weekend data:", docId);
            return null;
          }

          return snap.data();
        } catch (e) {
          console.error("[Cloud] Firebase error:", e);
          return null;
        }
      }

      window.fetchHotCB = async function (targetDate = null) {
        // Use supplied date or default to current effective date
        const dateToUse =
          targetDate ||
          window.currentDisplayDate ||
          SmartDateNavigator.getEffectiveDate(new Date());
        const dateId = SmartDateNavigator.formatDate(dateToUse);
        const todayId = SmartDateNavigator.formatDate(new Date());

        // Update UI immediately to reflect target date
        SmartDateNavigator.updateUI(dateToUse);
        updateLoadingState(true);
        if (statusBanner) statusBanner.classList.add("hidden");

        const cacheKey = `hot_cb_list_${dateId}`;
        console.log(
          `[Data] Strategy: Cloud First + Local Cache. Fetching ${dateId}`,
        );

        try {
          // 1. Try Local Cache (IndexedDB)
          const cached = await CbHistoryService._readLocal(cacheKey);
          // If cache exists and it's either an old date (static) or today's cache from today
          // Adding length check to bypass suspicious "mock" caches (usually only 4 items)
          if (
            cached &&
            (dateId !== todayId || cached.lastSync === todayId) &&
            cached.records?.length > 5
          ) {
            console.log(
              `[Data] Cache hit for ${dateId} (${cached.records.length} items)`,
            );
            processData(
              cached.records,
              dateId === todayId ? "live" : "history",
            );
            updateHeaderTime(new Date(cached.timestamp || Date.now()));
            updateLoadingState(false);
            if (dateId === todayId) startUpdateTimer();
            return;
          } else if (cached) {
            console.warn(
              `[Data] Cache hit but data suspicious (${cached.records?.length} items). Forcing refresh.`,
            );
          }

          // 2. Clear Cache Miss -> Cloud Fetch
          console.log(
            `[Data] Cache miss/stale. Requesting Firestore for ${dateId}...`,
          );
          const docRef = doc(db, "hot_cb_snapshots", dateId);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const cloudData = docSnap.data();
            const items = cloudData.items || cloudData.data || [];

            const cloudDate = cloudData.updatedAt?.toDate
              ? cloudData.updatedAt.toDate()
              : new Date(cloudData.updatedAt || Date.now());

            // Save to local cache with today's tag and timestamp
            await CbHistoryService._writeLocal(
              cacheKey,
              items,
              todayId,
              cloudDate.toISOString(),
            );

            processData(items, dateId === todayId ? "live" : "history");
            updateHeaderTime(cloudDate);

            if (dateId === todayId) startUpdateTimer();
          } else {
            console.warn(`[Data] No Firestore snapshot for ${dateId}`);
            processData([], "history");
            renderError("尚無資料", `資料庫中暫無 ${dateId} 的紀錄`);
          }
        } catch (e) {
          console.error("[Data] Fetch failure:", e);
          renderError("載入失敗", "目前無法與雲端同步，請稍後再試。");
        } finally {
          updateLoadingState(false);
        }
      };

      function processData(json, mode) {
        try {
          const list = Array.isArray(json) ? json : json.data || [];
          const dataTime = json.updatedAt
            ? new Date(json.updatedAt)
            : new Date();

          // Flash animation handling: compare with previous data
          const poolChanged =
            window.lastDataPool &&
            JSON.stringify(window.lastDataPool[0]?.price) !==
              JSON.stringify(list[0]?.price);

          window.lastDataPool = list;
          renderDashboard(list, json.source || "cloud", poolChanged);

          // Update Watchlist Hero if data loaded
          const watchItems = Array.from(
            document.querySelectorAll("#trackedListContainer .mono"),
          ).map((el) => el.textContent);
          // (Actual watchlist comes from snapshot subscription)

          updateHeaderTime(dataTime);
          updateHeaderTime(dataTime);
          if (mode === "history") {
            updateArchiveStatus();
            // Stop auto-refresh in history mode
            if (countdownTimer) clearInterval(countdownTimer);
            document.getElementById("topProgressBar").style.width = "0%";
            // Provide visual cue
            statusBanner.innerHTML = `<div class="bg-amber-50 border border-amber-100 p-3 rounded-xl text-xs text-amber-700 flex items-center justify-center gap-2"><i class="fas fa-history"></i><span>目前顯示歷史資料 (${SmartDateNavigator.formatDate(window.currentDisplayDate)}) - 即時報價已暫停更新。</span></div>`;
            statusBanner.classList.remove("hidden");
          } else {
            updateMarketStatus(dataTime);
            startUpdateTimer(); // Start 60s countdown
          }
        } catch (e) {
          console.error("[Process] Failed to process data:", e);
          renderError("處理錯誤", "數據解析過程發生異常");
        } finally {
          updateLoadingState(false);
        }
      }

      function renderDashboard(list, source, isPulse) {
        try {
          if (source === "mock") {
            statusBanner.innerHTML = `<div class="bg-amber-50 border border-amber-100 p-3 rounded-xl text-xs text-amber-700 flex items-center justify-center gap-2"><i class="fas fa-info-circle"></i><span>目前顯示模擬數據。</span></div>`;
            statusBanner.classList.remove("hidden");
          } else statusBanner.classList.add("hidden");

          if (list.length === 0) {
            container.innerHTML =
              '<div class="p-12 text-center text-slate-300">NO DATA FOUND</div>';
            return;
          }

          let html = `<div class="overflow-x-auto"><table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-400 font-bold">
              <tr>
                <th class="pl-4 md:pl-6 py-4 w-10 text-center">#</th>
                <th class="px-3 md:px-4 py-4">名稱 / 時間</th>
                <th class="px-3 md:px-4 py-4 text-right">現價</th>
                <th class="px-3 md:px-4 py-4 text-right">漲跌</th>
                <th class="px-3 md:px-4 py-4 text-right">成交量</th>
                <th class="px-3 md:px-4 py-4 text-center w-12">操作</th>
              </tr>
            </thead><tbody class="divide-y divide-slate-50">`;

          html += list
            .map((item, index) => {
              const rank = index + 1;
              const changeStr = (item.change || "")
                .toString()
                .replace(/[＋▲+]/g, "")
                .replace(/[－▼-]/g, "-");
              const changeVal = parseFloat(changeStr) || 0;
              const isUp =
                (item.change || "").toString().includes("▲") || changeVal > 0;
              const isDown =
                (item.change || "").toString().includes("▼") || changeVal < 0;
              const pColor = isUp
                ? "text-red-500"
                : isDown
                  ? "text-green-600"
                  : "text-slate-900";
              const cBg = isUp
                ? "bg-red-50 text-red-600"
                : isDown
                  ? "bg-green-50 text-green-600"
                  : "bg-slate-100 text-slate-500";
              const lastClose = (item.price - changeVal).toFixed(2);

              const flashClass = isPulse
                ? isUp
                  ? "flash-up"
                  : isDown
                    ? "flash-down"
                    : ""
                : "";

              return `<tr class="table-row-hover group ${flashClass}" onclick="openAnalysis('${item.code}')">
              <td class="pl-4 md:pl-6 py-5"><div class="rank-dot top-${rank <= 3 ? rank : "normal"} mx-auto">${rank}</div></td>
              <td class="px-3 md:px-4 py-5">
                <div class="flex flex-col"><span class="font-black text-slate-700 text-sm">${item.name}</span>
                <div class="flex items-center gap-2 mt-0.5"><span class="mono text-[10px] font-bold text-slate-400">${item.code}</span><span class="text-[9px] text-slate-300 font-bold bg-slate-50 px-1 rounded">${item.time || "--:--"}</span></div></div>
              </td>
              <td class="px-3 md:px-4 py-5 text-right">
                <span class="mono font-black text-sm ${pColor}">${parseFloat(item.price).toFixed(2)}</span>
              </td>
              <td class="px-3 md:px-4 py-5 text-right">
                <div class="flex flex-col items-end">
                  <span class="mono text-[11px] font-black ${pColor}">${item.change}</span>
                  <span class="text-[9px] font-bold text-slate-400 mt-0.5">${item.changePercent}</span>
                </div>
              </td>
              <td class="px-3 md:px-4 py-5 text-right">
                <span class="mono text-xs font-bold text-slate-500">${item.volume}</span>
              </td>
              <td class="px-3 md:px-4 py-5 text-center">
                <button class="w-8 h-8 rounded-lg bg-slate-50 text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 transition-all flex items-center justify-center mx-auto group/btn">
                  <i class="fas fa-chart-line text-xs group-hover/btn:scale-110 transition-transform"></i>
                </button>
              </td>
            </tr>`;
            })
            .join("");

          html += "</tbody></table></div>";
          container.innerHTML = html;
        } catch (e) {
          console.error("[Render] Dashboard failed:", e);
          renderError("渲染失敗", "表格生成過程發生錯誤");
        }
      }

      function updateLoadingState(isLoading) {
        const loader = document.getElementById("loader");
        if (isLoading) loader.classList.remove("hidden");
        else loader.classList.add("hidden");
      }

      function renderError(title, msg) {
        container.innerHTML = `
        <div class="p-12 text-center flex flex-col items-center justify-center animate-fadeIn">
          <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-exclamation-triangle text-xl"></i>
          </div>
          <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight mb-2">${title}</h3>
          <p class="text-xs font-bold text-slate-400 max-w-xs leading-relaxed">${msg}</p>
          <button onclick="window.location.reload()" class="mt-6 px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full text-[10px] font-black uppercase tracking-widest transition-all">Retry</button>
        </div>`;
      }

      function updateHeaderTime(date) {
        if (!date || isNaN(date.getTime())) {
          updateTimeEl.textContent = "UPDATE: --:--:--";
          return;
        }
        try {
          updateTimeEl.textContent = `UPDATE: ${date.toLocaleTimeString()}`;
        } catch (e) {
          updateTimeEl.textContent = "UPDATE: --:--:--";
        }
      }

      function updateArchiveStatus() {
        const pill = document.getElementById("marketStatus");
        pill.className = "status-pill bg-slate-100 text-slate-500";
        pill.innerHTML = '<i class="fas fa-archive text-[10px]"></i> HISTORY';
      }

      function updateMarketStatus(date) {
        const pill = document.getElementById("marketStatus");
        const hour = date.getHours();
        const min = date.getMinutes();
        const day = date.getDay();
        const isWeekend = day === 0 || day === 6;
        const totalMin = hour * 60 + min;

        // Market hours: 09:00 - 13:30 (540 - 810)
        const isOpen = !isWeekend && totalMin >= 540 && totalMin <= 810;

        if (isOpen) {
          pill.className = "status-pill bg-green-50 text-green-600";
          pill.innerHTML =
            '<span class="relative flex h-2 w-2 mr-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span> LIVE';
        } else {
          pill.className = "status-pill bg-slate-100 text-slate-500";
          pill.innerHTML =
            '<i class="fas fa-moon text-[10px] mr-1"></i> CLOSED';
        }
      }

      function getDataPath(filename) {
        return `../data/${filename}`;
      }

      // Performance Monitoring
      window.measureFetch = async (url) => {
        const start = performance.now();
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const contentType = res.headers.get("content-type");
          if (contentType && contentType.includes("text/html")) {
            throw new Error(
              "Received HTML instead of JSON (likely 404/fallback)",
            );
          }

          const duration = performance.now() - start;

          logPerfEvent("fetch_success", {
            url: url.split("?")[0],
            duration: Math.round(duration),
          });

          if (duration > 3000) {
            console.warn(
              `[Perf] Slow fetch: ${url} (${duration.toFixed(0)}ms)`,
            );
          }
          return res;
        } catch (e) {
          logPerfEvent("fetch_error", { url, error: e.message });
          throw e;
        }
      };

      function logPerfEvent(name, params) {
        try {
          // Explicitly use analytics instance (V10)
          if (typeof analytics !== "undefined" && analytics) {
            logEvent(analytics, name, params);
          }
          console.log(`[Perf] ${name}:`, params);
        } catch (e) {
          // Safety: Don't call db.collection or anything else here
          console.warn(
            `[Perf] Analytics dispatch failed for ${name}:`,
            e.message,
          );
        }
      }

      window.openAnalysis = async (code) => {
        window.currentAnalysisCode = code;
        const drawer = document.getElementById("analysisDrawer");
        const overlay = document.getElementById("drawerOverlay");

        if (!drawer || !overlay) {
          console.error("[Analysis] Drawer UI elements missing");
          return;
        }

        drawer.classList.add("open");
        overlay.classList.add("show");
        document.body.style.overflow = "hidden";

        // 0. Reset UI
        document.getElementById("dConvPriceInput").value = "";
        document.getElementById("drawerTitle").textContent = "--";
        document.getElementById("drawerCode").textContent = code;
        document.getElementById("dCbPrice").textContent = "--";
        document.getElementById("dStockPrice").textContent = "--";
        document.getElementById("dConvVal").textContent = "--";
        document.getElementById("dSharesInfo").textContent = "--";
        document.getElementById("dParityPrice").textContent = "--";
        document.getElementById("dUpsideNeeded").textContent = "--%";
        document.getElementById("dPremiumRate").textContent = "--%";
        document.getElementById("dPremiumDesc").textContent =
          "正在讀取中繼資料...";
        document.getElementById("dPremiumStatus").textContent = "LOADING";

        // 1. Initial Data Search (Pool vs Tracked)
        const poolItem = window.lastDataPool?.find((i) => i.code === code);
        const trackedItem = window.lastKnownItems?.find((i) => i.id === code);

        // 2. Fetch/Resolve Metadata from Firestore (Master Info)
        let meta = null;
        try {
          const metaSnap = await getDoc(doc(db, "cb_history", code));
          if (metaSnap.exists()) {
            meta = metaSnap.data();
          }
        } catch (e) {
          console.warn(
            `[Analysis] Master metadata fetch failed for ${code}`,
            e,
          );
        }

        // 3. Merge order: Firestore Meta > Pool Item > Tracked Item
        const item = {
          code: code,
          name: meta?.name || poolItem?.name || trackedItem?.name || code,
          price: trackedItem?.price || poolItem?.price || 0,
          stockPrice: trackedItem?.stockPrice || poolItem?.stockPrice || 0,
          changePercent:
            trackedItem?.changePercent || poolItem?.changePercent || "0.00%",
          conversionPrice:
            meta?.conversionPrice || trackedItem?.conversionPrice || 0,
          underlyingCode:
            meta?.underlyingCode ||
            poolItem?.underlyingCode ||
            trackedItem?.underlyingCode ||
            "",
        };

        document.getElementById("drawerTitle").textContent = item.name;
        document.getElementById("drawerCode").textContent = item.code;
        window.performAnalysis(item);

        fetchAnalysisHistory(code);
      };

      window.closeAnalysis = () => {
        const drawer = document.getElementById("analysisDrawer");
        const overlay = document.getElementById("drawerOverlay");
        if (drawer) drawer.classList.remove("open");
        if (overlay) overlay.classList.remove("show");
        document.body.style.overflow = "";
      };

      window.performAnalysis = async (item) => {
        const inputVal = document.getElementById("dConvPriceInput")?.value;
        const convPrice = parseFloat(inputVal) || item.conversionPrice || 0;
        const spotPrice = parseFloat(item.stockPrice) || 0;
        const lastCbPrice =
          parseFloat(item.price) || parseFloat(item.close) || 0;

        // 3. UI Updates - Basics
        const dStockPrice = document.getElementById("dStockPrice");
        if (dStockPrice) {
          dStockPrice.textContent = spotPrice > 0 ? spotPrice.toFixed(2) : "--";
          dStockPrice.classList.toggle("text-slate-300", spotPrice === 0);
        }

        const cbPriceEl = document.getElementById("dCbPrice");
        if (cbPriceEl) {
          cbPriceEl.innerHTML = lastCbPrice > 0 ? lastCbPrice.toFixed(2) : "--";
          if (lastCbPrice === 100.0) {
            cbPriceEl.innerHTML += `<span class="ml-2 text-[10px] text-amber-500 bg-amber-50 px-1 rounded border border-amber-200" title="若今日無成交，系統可能回傳票面價 100">票面?</span>`;
          }
        }

        const dConvPriceInput = document.getElementById("dConvPriceInput");
        if (dConvPriceInput && !inputVal) {
          dConvPriceInput.value = convPrice > 0 ? convPrice : "";
        }

        // 4. Detailed Calculations
        // Parity (平價) = (Spot / Conv) * 100
        const parity =
          convPrice > 0 && spotPrice > 0 ? (spotPrice / convPrice) * 100 : 0;

        // Premium (溢價率) = (CBPrice / Parity - 1) * 100
        let premium = 0;
        if (parity > 0 && lastCbPrice > 0) {
          premium = (lastCbPrice / parity - 1) * 100;
        }

        // Break-Even Stock Price (保本價) = (CBPrice / 100) * ConvPrice
        const beStockPrice =
          lastCbPrice > 0 && convPrice > 0
            ? (lastCbPrice / 100) * convPrice
            : 0;

        // 5. Update Metrics UI
        const dConvVal = document.getElementById("dConvVal");
        if (dConvVal)
          dConvVal.textContent = parity > 0 ? parity.toFixed(2) : "--";

        const dParityPrice = document.getElementById("dParityPrice");
        if (dParityPrice)
          dParityPrice.textContent =
            beStockPrice > 0 ? beStockPrice.toFixed(2) : "--";

        const dPremiumRate = document.getElementById("dPremiumRate");
        if (dPremiumRate) {
          dPremiumRate.textContent =
            parity > 0 && lastCbPrice > 0 ? premium.toFixed(2) + "%" : "--%";
          dPremiumRate.className =
            "text-5xl font-black tracking-tighter mono " +
            (premium < 0
              ? "text-green-600"
              : premium > 10
                ? "text-red-500"
                : "text-slate-800");
        }

        // 6. Shares per Bond
        const sharesPerBond =
          convPrice > 0 ? Math.floor(100000 / convPrice) : 0;
        const dSharesInfo = document.getElementById("dSharesInfo");
        if (dSharesInfo)
          dSharesInfo.textContent =
            sharesPerBond > 0 ? `${sharesPerBond} 股/張` : "-- 股/張";

        // 7. Upside Needed (BE)
        const dUpsideNeeded = document.getElementById("dUpsideNeeded");
        if (dUpsideNeeded) {
          const upside =
            spotPrice > 0 && beStockPrice > 0
              ? (beStockPrice / spotPrice - 1) * 100
              : 0;
          dUpsideNeeded.textContent =
            upside !== 0 ? `需上漲 ${upside.toFixed(2)}%` : "需上漲 --%";
        }

        // 8. Description & Status
        const descEl = document.getElementById("dPremiumDesc");
        const statusEl = document.getElementById("dPremiumStatus");
        if (descEl) {
          if (parity > 0 && lastCbPrice > 0) {
            descEl.textContent =
              premium > 0
                ? "目前價格高於理論價值 (溢價)"
                : "目前價格低於理論價值 (折價)";
          } else {
            descEl.textContent = "資料不足，無法計算";
          }
        }
        if (statusEl) {
          if (parity > 0 && lastCbPrice > 0) {
            statusEl.textContent = premium > 0 ? "溢價" : "折價";
            statusEl.className =
              premium > 0
                ? "px-1.5 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter bg-red-50 text-red-500 border border-red-100"
                : "px-1.5 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter bg-green-50 text-green-600 border border-green-100";
          } else {
            statusEl.textContent = "待確認";
            statusEl.className =
              "px-1.5 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter bg-slate-100 text-slate-400 border border-slate-100/50";
          }
        }
      };

      async function fetchAnalysisHistory(code) {
        const mountPoint = document.getElementById("dPremiumChartMount");
        if (mountPoint)
          mountPoint.innerHTML =
            '<div class="h-48 flex items-center justify-center text-slate-300 text-[10px] font-bold uppercase tracking-widest animate-pulse">Loading Historical Data...</div>';
        try {
          const history = await window.CbHistoryService.fetchHistory(
            window.db,
            code,
            {
              onStatusUpdate: (msg, submsg) => {
                // If we wanted to update a title elsewhere, we could here
              },
            },
          );

          if (history.length > 0 && mountPoint) {
            window.currentChartRawData = history;
            window.analysisChart = window.CbPremiumHistoryChart.mount(
              mountPoint,
              history,
            );
          }
        } catch (e) {
          console.warn("History load failed:", e);
        }
      }

      window.toggleDrawerParams = () => {
        const params = document.getElementById("drawerParams");
        if (params) params.classList.toggle("hidden");
      };

      window.saveAnalysisMeta = async () => {
        const code = window.currentAnalysisCode;
        const convPrice = parseFloat(
          document.getElementById("dConvPriceInput").value,
        );
        if (!code || isNaN(convPrice)) {
          alert("請輸入有效的轉換價格");
          return;
        }

        const btn = document.querySelector('[onclick="saveAnalysisMeta()"]');
        const originalIcon = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
          await setDoc(
            doc(db, "cb_history", code),
            {
              conversionPrice: convPrice,
              updatedAt: serverTimestamp(),
            },
            { merge: true },
          );

          btn.className = btn.className.replace(
            "bg-indigo-50 text-indigo-600",
            "bg-green-500 text-white",
          );
          btn.innerHTML = '<i class="fas fa-check"></i>';
          console.log(`[Analysis] Metadata saved for ${code}`);

          setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.className = btn.className.replace(
              "bg-green-500 text-white",
              "bg-indigo-50 text-indigo-600",
            );
          }, 2000);
        } catch (e) {
          console.error("[Analysis] Save failed", e);
          alert("儲存失敗，請檢查權限");
          btn.disabled = false;
          btn.innerHTML = originalIcon;
        }
      };

      const convInput = document.getElementById("dConvPriceInput");
      if (convInput) {
        convInput.addEventListener("input", () => {
          const item = window.lastDataPool?.find(
            (i) => i.code === window.currentAnalysisCode,
          );
          if (item) window.performAnalysis(item);
        });
      }

      // --- Final Initialization ---
      console.log("[Init] War Room Components Initialized.");
      window.initBootstrap();
    </script>
  </body>
</html>
